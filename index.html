<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kehadiran Pelatih GIATMARA Kelantan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    <span class="text-purple-600 font-bold text-lg">G</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold">GIATMARA Kelantan</h1>
                    <p class="text-sm opacity-90">Sistem Kehadiran Pelatih</p>
                </div>
            </div>
            <div id="userInfo" class="hidden">
                <span id="currentUser" class="mr-4"></span>
                <button onclick="logout()" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30 transition">
                    Log Keluar
                </button>
            </div>
        </div>
    </nav>

    <!-- Login Selection Screen -->
    <div id="loginSelection" class="container mx-auto px-4 py-12">
        <div class="max-w-4xl mx-auto text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-8">Pilih Jenis Log Masuk</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Pusat Login -->
                <div class="card-shadow bg-white rounded-xl p-8 hover-scale cursor-pointer" onclick="showPusatLogin()">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Log Masuk Pusat</h3>
                    <p class="text-gray-600">Untuk kakitangan pusat GIATMARA mengurus kehadiran pelatih</p>
                </div>

                <!-- Admin Login -->
                <div class="card-shadow bg-white rounded-xl p-8 hover-scale cursor-pointer" onclick="showAdminLogin()">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Log Masuk Admin</h3>
                    <p class="text-gray-600">Untuk pentadbir sistem menguruskan pusat, kursus dan laporan</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pusat Login Form -->
    <div id="pusatLoginForm" class="hidden container mx-auto px-4 py-12">
        <div class="max-w-md mx-auto">
            <div class="card-shadow bg-white rounded-xl p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Log Masuk Pusat</h2>
                    <p class="text-gray-600 mt-2">Masukkan maklumat pusat anda</p>
                </div>
                <form onsubmit="loginPusat(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Pilih Pusat</label>
                        <select id="pusatSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            <option value="">Pilih Pusat GIATMARA</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Kata Laluan</label>
                        <input type="password" id="pusatPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan kata laluan" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium">
                        Log Masuk
                    </button>
                </form>
                <button onclick="backToSelection()" class="w-full mt-4 text-gray-600 hover:text-gray-800 transition">
                    ‚Üê Kembali ke Pilihan
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Login Form -->
    <div id="adminLoginForm" class="hidden container mx-auto px-4 py-12">
        <div class="max-w-md mx-auto">
            <div class="card-shadow bg-white rounded-xl p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Log Masuk Admin</h2>
                    <p class="text-gray-600 mt-2">Akses pentadbir sistem</p>
                </div>
                <form onsubmit="loginAdmin(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">ID Admin</label>
                        <input type="text" id="adminId" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Masukkan ID Admin" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Kata Laluan</label>
                        <input type="password" id="adminPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Masukkan kata laluan" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-medium">
                        Log Masuk
                    </button>
                </form>
                <button onclick="backToSelection()" class="w-full mt-4 text-gray-600 hover:text-gray-800 transition">
                    ‚Üê Kembali ke Pilihan
                </button>
            </div>
        </div>
    </div>

    <!-- Pusat Dashboard -->
    <div id="pusatDashboard" class="hidden container mx-auto px-4 py-8">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Dashboard Pusat</h2>
            <p class="text-gray-600">Pengurusan kehadiran pelatih</p>
        </div>

        <!-- Quick Stats -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Jumlah Pelatih</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalPelatih">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Hadir Hari Ini</p>
                        <p class="text-2xl font-bold text-gray-800" id="hadirHariIni">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Tidak Hadir</p>
                        <p class="text-2xl font-bold text-gray-800" id="tidakHadir">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Lewat</p>
                        <p class="text-2xl font-bold text-gray-800" id="lewat">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <button onclick="showTambahPelatih()" class="bg-blue-600 text-white p-6 rounded-xl hover:bg-blue-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <h3 class="font-semibold">Tambah Pelatih</h3>
                </div>
            </button>
            <button onclick="showImportPelatih()" class="bg-green-600 text-white p-6 rounded-xl hover:bg-green-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                    </svg>
                    <h3 class="font-semibold">Import Pelatih</h3>
                </div>
            </button>
            <button onclick="showPendaftaranSesi()" class="bg-indigo-600 text-white p-6 rounded-xl hover:bg-indigo-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="font-semibold">Pendaftaran Sesi</h3>
                </div>
            </button>
            <button onclick="showKehadiran()" class="bg-purple-600 text-white p-6 rounded-xl hover:bg-purple-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <h3 class="font-semibold">Rekod Kehadiran</h3>
                </div>
            </button>
            <button onclick="showLaporanPusat()" class="bg-orange-600 text-white p-6 rounded-xl hover:bg-orange-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="font-semibold">Laporan</h3>
                </div>
            </button>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-xl p-6 card-shadow">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Aktiviti Terkini</h3>
            <div id="recentActivity" class="space-y-3">
                <div class="flex items-center justify-center p-8 bg-gray-50 rounded-lg">
                    <div class="text-center">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        <p class="text-gray-600 font-medium">Tiada Data Pelatih</p>
                        <p class="text-sm text-gray-500 mt-1">Tambah pelatih baru atau import dari fail untuk mula menggunakan sistem</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden container mx-auto px-4 py-8">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Dashboard Admin</h2>
            <p class="text-gray-600">Pengurusan sistem keseluruhan</p>
        </div>

        <!-- Admin Menu -->
        <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <button onclick="showPusatManagement()" class="bg-blue-600 text-white p-6 rounded-xl hover:bg-blue-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <h3 class="font-semibold">Urus Pusat</h3>
                </div>
            </button>
            <button onclick="showKursusManagement()" class="bg-green-600 text-white p-6 rounded-xl hover:bg-green-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    <h3 class="font-semibold">Urus Kursus</h3>
                </div>
            </button>
            <button onclick="showSesiManagement()" class="bg-purple-600 text-white p-6 rounded-xl hover:bg-purple-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="font-semibold">Urus Sesi</h3>
                </div>
            </button>
            <button onclick="showLogoManagement()" class="bg-indigo-600 text-white p-6 rounded-xl hover:bg-indigo-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <h3 class="font-semibold">Urus Logo</h3>
                </div>
            </button>
            <button onclick="showPelatihManagement()" class="bg-teal-600 text-white p-6 rounded-xl hover:bg-teal-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <h3 class="font-semibold">Urus Pelatih</h3>
                </div>
            </button>
            <button onclick="showLaporan()" class="bg-orange-600 text-white p-6 rounded-xl hover:bg-orange-700 transition card-shadow hover-scale">
                <div class="text-center">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="font-semibold">Jana Laporan</h3>
                </div>
            </button>
        </div>

        <!-- System Overview -->
        <div class="grid md:grid-cols-3 gap-6">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Jumlah Pusat</h3>
                <p class="text-3xl font-bold text-blue-600">5</p>
                <p class="text-sm text-gray-600 mt-2">Pusat aktif di Kelantan</p>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Jumlah Kursus</h3>
                <p class="text-3xl font-bold text-green-600">12</p>
                <p class="text-sm text-gray-600 mt-2">Kursus yang ditawarkan</p>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Jumlah Pelatih</h3>
                <p class="text-3xl font-bold text-purple-600">248</p>
                <p class="text-sm text-gray-600 mt-2">Pelatih berdaftar</p>
            </div>
        </div>
    </div>

    <!-- Modal untuk Rekod Kehadiran -->
    <div id="kehadiranModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-6xl w-full mx-4 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Rekod Kehadiran Pelatih</h3>
                <div class="text-sm text-gray-600">
                    Tarikh: <span class="font-semibold" id="currentDate"></span>
                </div>
            </div>
            
            <!-- Filter dan Search -->
            <div class="mb-6 space-y-4">
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <input type="text" id="searchPelatih" placeholder="Cari nama pelatih..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onkeyup="filterPelatih()">
                    </div>
                    <div>
                        <select id="filterKursus" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterPelatih()">
                            <option value="">Semua Kursus</option>
                            <!-- Options will be populated dynamically based on imported courses -->
                        </select>
                    </div>
                    <div>
                        <button onclick="markAllPresent()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            Semua Hadir
                        </button>
                    </div>
                </div>
                
                <!-- Date Search Section -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <label class="text-sm font-medium text-blue-800">Cari Kehadiran Mengikut Tarikh:</label>
                        </div>
                        <div>
                            <input type="date" id="searchTarikh" class="px-4 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white" onchange="cariKehadiranTarikh()">
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="cariKehadiranTarikh()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Cari
                            </button>
                            <button onclick="resetTarikhCarian()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">
                                Reset
                            </button>
                            <button onclick="showAttendanceHistory()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm">
                                üìä Sejarah Kehadiran
                            </button>
                        </div>
                    </div>
                    <div id="tarikhInfo" class="mt-2 text-sm text-blue-700 hidden">
                        <!-- Date search info will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- Senarai Pelatih -->
            <div id="kehadiranList" class="space-y-3 mb-6">
                <!-- Dynamic content will be populated here -->
            </div>
            
            <div class="flex space-x-4">
                <button onclick="closeKehadiran()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                    Tutup
                </button>
                <button onclick="simpanKehadiran()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">
                    Simpan Kehadiran
                </button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Tambah Pelatih -->
    <div id="tambahPelatihModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Tambah Pelatih Baru</h3>
            <form onsubmit="tambahPelatih(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Nama Penuh</label>
                    <input type="text" id="namaPelatih" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">No. KP</label>
                    <input type="text" id="noKP" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Sesi Kursus</label>
                    <select id="sesiPelatih" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Sesi Kursus</option>
                        <!-- Options will be populated dynamically based on available sessions -->
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Kursus</label>
                    <input type="text" id="kursusPelatih" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly placeholder="Kursus akan diisi automatik berdasarkan sesi">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">No. Telefon</label>
                    <input type="tel" id="noTelefon" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">
                        Tambah
                    </button>
                    <button type="button" onclick="closeTambahPelatih()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal untuk Import Pelatih -->
    <div id="importPelatihModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Import Pelatih dari Fail</h3>
                <button onclick="closeImportPelatih()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Upload Section -->
            <div class="mb-6">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition">
                    <div class="mb-4">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Pilih Fail untuk Import</h4>
                        <p class="text-gray-600 mb-4">Drag & drop fail atau klik untuk pilih</p>
                        <p class="text-sm text-gray-500 mb-4">Format yang disokong: CSV, Excel (.xlsx/.xls), TXT</p>
                        <p class="text-xs text-blue-600 mb-4">üí° <strong>Tip:</strong> Sistem akan membaca fail dan menunjukkan pratonton sebelum import data ke dalam sistem</p>
                    </div>
                    
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.txt" onchange="handleFileUpload(event)" class="hidden">
                    <div class="flex justify-center space-x-4">
                        <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-medium">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Pilih Fail
                        </button>
                        <button onclick="downloadTemplate()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition font-medium">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Muat Turun Template
                        </button>
                    </div>
                </div>
                
                <!-- Format Guide -->
                <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h5 class="font-semibold text-blue-800 mb-2">üìã Format Fail CSV/Excel:</h5>
                    <div class="text-sm text-blue-700">
                        <p class="mb-2"><strong>Susunan Kolum (mesti mengikut urutan ini):</strong></p>
                        <div class="bg-white border rounded p-2 font-mono text-xs">
                            Nama Penuh, No. KP, Kursus, No. Telefon, Alamat
                        </div>
                        <p class="mt-2"><strong>Contoh data dalam fail:</strong></p>
                        <div class="bg-white border rounded p-2 font-mono text-xs">
                            Ahmad bin Ali, 901234567890, PENDAWAI ELEKTRIK (PW4), 0123456789, "Jalan Merdeka, Kota Bharu"<br>
                            Siti Aminah, 901234567891, TEKNOLOGI SISTEM KOMPUTER, 0123456788, "Jalan Raya, Machang"
                        </div>
                        <p class="mt-2 text-xs">
                            <strong>Nota Penting:</strong><br>
                            ‚Ä¢ Kolum <strong>Nama, No. KP, dan Kursus</strong> adalah wajib<br>
                            ‚Ä¢ Telefon dan Alamat adalah pilihan (boleh kosong)<br>
                            ‚Ä¢ Jika ada koma dalam alamat, gunakan tanda petik " "<br>
                            ‚Ä¢ Sistem akan menunjukkan pratonton sebelum import
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Import Preview -->
            <div id="importPreview" class="mb-6">
                <!-- Dynamic content will be populated here -->
            </div>
            
            <!-- Import Results -->
            <div id="importResults" class="hidden">
                <!-- Dynamic content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Modal untuk Pendaftaran Sesi -->
    <div id="pendaftaranSesiModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Pendaftaran Sesi Kursus</h3>
                <button onclick="closePendaftaranSesi()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Form Pendaftaran Sesi -->
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Bahagian Kiri - Form Input -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">Maklumat Sesi Baru</h4>
                    <form onsubmit="daftarSesi(event)" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Nama Sesi</label>
                            <input type="text" id="namaSesiDaftar" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Contoh: Sesi Pagi Elektrik 2024" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Kod Kursus</label>
                                <input type="text" id="kodKursus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Contoh: ELK001" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Nama Kursus</label>
                                <select id="namaKursusDaftar" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="">Pilih Kursus</option>
                                    <option value="BAIKPULIH DAN MENGECAT KENDERAAN">BAIKPULIH DAN MENGECAT KENDERAAN</option>
                                    <option value="BAIKPULIH KERANGKA KENDERAAN">BAIKPULIH KERANGKA KENDERAAN</option>
                                    <option value="BEM">BEM</option>
                                    <option value="JAHITAN LANGSIR & SOFT FURNISHING">JAHITAN LANGSIR & SOFT FURNISHING</option>
                                    <option value="JAHITAN PAKAIAN DAN FESYEN">JAHITAN PAKAIAN DAN FESYEN</option>
                                    <option value="KIMPALAN STRUKTUR KELULI">KIMPALAN STRUKTUR KELULI</option>
                                    <option value="KONFEKSIONERI & BAKERI">KONFEKSIONERI & BAKERI</option>
                                    <option value="MASAKAN DAN PRAMUSAJI">MASAKAN DAN PRAMUSAJI</option>
                                    <option value="MASAKAN ETNIK ASIAN">MASAKAN ETNIK ASIAN</option>
                                    <option value="PENDAWAI ELEKTRIK (PW4)">PENDAWAI ELEKTRIK (PW4)</option>
                                    <option value="PENDAWAIAN ELEKTRIK PW2">PENDAWAIAN ELEKTRIK PW2</option>
                                    <option value="REKAAN PAKAIAN DAN FESYEN">REKAAN PAKAIAN DAN FESYEN</option>
                                    <option value="TEK. BINANAN BANBGUNAN">TEK. BINANAN BANBGUNAN</option>
                                    <option value="TEK. KIMPALAN">TEK. KIMPALAN</option>
                                    <option value="TEK. PENYEJUKBEKUAN & PENYAMANAN UDARA">TEK. PENYEJUKBEKUAN & PENYAMANAN UDARA</option>
                                    <option value="TEKNOLOGI AUTOMOTIF (TAHAP 2)">TEKNOLOGI AUTOMOTIF (TAHAP 2)</option>
                                    <option value="TEKNOLOGI AUTOMOTIF (TAHAP 3)">TEKNOLOGI AUTOMOTIF (TAHAP 3)</option>
                                    <option value="TEKNOLOGI ELEKTRONIK">TEKNOLOGI ELEKTRONIK</option>
                                    <option value="TEKNOLOGI MOTOSIKAL">TEKNOLOGI MOTOSIKAL</option>
                                    <option value="TEKNOLOGI PERABOT">TEKNOLOGI PERABOT</option>
                                    <option value="TEKNOLOGI SISTEM KOMPUTER">TEKNOLOGI SISTEM KOMPUTER</option>
                                    <option value="TERAPI KECANTIKAN DAN SOLEKAN">TERAPI KECANTIKAN DAN SOLEKAN</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Tahun Sesi</label>
                                <select id="tahunSesiDaftar" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="">Pilih Tahun</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Tempoh Kursus</label>
                                <select id="tempohKursusDaftar" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="">Pilih Tempoh</option>
                                    <option value="3">3 Bulan</option>
                                    <option value="6">6 Bulan</option>
                                    <option value="9">9 Bulan</option>
                                    <option value="12">12 Bulan</option>
                                    <option value="18">18 Bulan</option>
                                    <option value="24">24 Bulan</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Tarikh Mula</label>
                                <input type="date" id="tarikhMula" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Tarikh Tamat</label>
                                <input type="date" id="tarikhTamat" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Masa Mula</label>
                                <input type="time" id="masaMulaDaftar" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Masa Tamat</label>
                                <input type="time" id="masaTamatDaftar" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Kapasiti Pelatih</label>
                            <input type="number" id="kapasitPelatih" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Contoh: 25" min="1" max="50" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Keterangan Tambahan</label>
                            <textarea id="keteranganSesi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="Maklumat tambahan tentang sesi ini..."></textarea>
                        </div>
                        
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-medium">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Daftar Sesi Baru
                        </button>
                    </form>
                </div>
                
                <!-- Bahagian Kanan - Senarai Sesi Sedia Ada -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">Sesi Kursus Sedia Ada</h4>
                    <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <div id="senaraySesiSediaAda" class="space-y-3">
                            <!-- Dynamic content will be populated here -->
                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <div class="flex justify-between items-start mb-2">
                                    <h5 class="font-semibold text-gray-800">Sesi Pagi Teknologi Automotif 2024</h5>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Aktif</span>
                                </div>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p><strong>Kod:</strong> AUT001 | <strong>Kursus:</strong> TEKNOLOGI AUTOMOTIF (TAHAP 2)</p>
                                    <p><strong>Tahun:</strong> 2024 | <strong>Tempoh:</strong> 6 Bulan</p>
                                    <p><strong>Tarikh:</strong> 01/01/2024 - 30/06/2024</p>
                                    <p><strong>Masa:</strong> 08:00 - 12:00 | <strong>Kapasiti:</strong> 25 pelatih</p>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <div class="flex justify-between items-start mb-2">
                                    <h5 class="font-semibold text-gray-800">Sesi Petang Sistem Komputer 2024</h5>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Aktif</span>
                                </div>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p><strong>Kod:</strong> KOM001 | <strong>Kursus:</strong> TEKNOLOGI SISTEM KOMPUTER</p>
                                    <p><strong>Tahun:</strong> 2024 | <strong>Tempoh:</strong> 6 Bulan</p>
                                    <p><strong>Tarikh:</strong> 01/02/2024 - 31/07/2024</p>
                                    <p><strong>Kapasiti:</strong> 20 pelatih</p>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <div class="flex justify-between items-start mb-2">
                                    <h5 class="font-semibold text-gray-800">Sesi Pagi Kimpalan Struktur 2024</h5>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Akan Datang</span>
                                </div>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p><strong>Kod:</strong> KIM001 | <strong>Kursus:</strong> KIMPALAN STRUKTUR KELULI</p>
                                    <p><strong>Tahun:</strong> 2024 | <strong>Tempoh:</strong> 9 Bulan</p>
                                    <p><strong>Tarikh:</strong> 01/03/2024 - 30/11/2024</p>
                                    <p><strong>Kapasiti:</strong> 30 pelatih</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistik Ringkas -->
                    <div class="mt-4 grid grid-cols-3 gap-3 text-center">
                        <div class="bg-green-100 p-3 rounded-lg">
                            <p class="text-lg font-bold text-green-600" id="jumlahSesiAktif">2</p>
                            <p class="text-xs text-gray-600">Sesi Aktif</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <p class="text-lg font-bold text-blue-600" id="jumlahSesiAkanDatang">1</p>
                            <p class="text-xs text-gray-600">Akan Datang</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-lg">
                            <p class="text-lg font-bold text-purple-600" id="jumlahPelatihTerdaftar">75</p>
                            <p class="text-xs text-gray-600">Pelatih Terdaftar</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Laporan Pusat -->
    <div id="laporanPusatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Laporan Kehadiran Pusat</h3>
            
            <!-- Pilihan Laporan -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-600 text-white p-4 rounded-lg">
                    <h4 class="font-semibold mb-3">Laporan Harian</h4>
                    <div class="mb-3">
                        <label class="block text-sm opacity-90 mb-2">Pilih Tarikh:</label>
                        <input type="date" id="tarikhHarian" class="w-full px-3 py-2 text-black rounded focus:outline-none focus:ring-2 focus:ring-blue-300" value="">
                    </div>
                    <button onclick="janaLaporanHarianPusat()" class="w-full bg-blue-800 hover:bg-blue-900 text-white py-2 rounded transition">
                        Jana Laporan
                    </button>
                </div>
                <button onclick="janaLaporanBulananPusat()" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition">
                    <h4 class="font-semibold">Laporan Bulanan</h4>
                    <p class="text-sm opacity-90">Kehadiran bulan ini</p>
                </button>
                <div class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition">
                    <h4 class="font-semibold mb-3">Laporan Tahunan</h4>
                    <div class="mb-3">
                        <label class="block text-sm opacity-90 mb-2">Pilih Kursus:</label>
                        <select id="laporanTahunanKursus" class="w-full px-3 py-2 text-black rounded focus:outline-none focus:ring-2 focus:ring-purple-300">
                            <option value="">Semua Kursus</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <button onclick="janaLaporanTahunanPusat()" class="w-full bg-purple-800 hover:bg-purple-900 text-white py-2 rounded transition">
                        Jana Laporan
                    </button>
                </div>
            </div>
            
            <!-- Filter Laporan -->
            <div class="mb-6">
                <div class="flex flex-wrap gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kursus</label>
                        <select id="laporanKursus" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Kursus</option>
                            <!-- Options will be populated dynamically based on imported courses -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bulan</label>
                        <select id="laporanBulan" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Bulan</option>
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Mac</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Jun</option>
                            <option value="7">Julai</option>
                            <option value="8">Ogos</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Disember</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tahun</label>
                        <select id="laporanTahun" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="cariLaporan()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Cari
                        </button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetFilter()" class="px-4 py-2 bg-gray-500 text-white text-sm rounded-lg hover:bg-gray-600 transition">
                        Reset Filter
                    </button>
                    <button onclick="exportFilteredData()" class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition">
                        Export Hasil Carian
                    </button>
                </div>
            </div>
            
            <!-- Kandungan Laporan -->
            <div id="laporanPusatContent" class="bg-gray-50 p-4 rounded-lg min-h-32 mb-6">
                <p class="text-gray-600 text-center">Pilih jenis laporan untuk melihat data</p>
            </div>
            
            <div class="flex space-x-4">
                <button onclick="closeLaporanPusat()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                    Tutup
                </button>
                <button onclick="exportLaporan()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition">
                    Export Excel
                </button>
                <button onclick="cetakLaporan()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">
                    Cetak Laporan
                </button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Laporan -->
    <div id="laporanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Jana Laporan Kehadiran</h3>
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <button onclick="janaLaporanHarian()" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition">
                    <h4 class="font-semibold">Laporan Harian</h4>
                    <p class="text-sm opacity-90">Kehadiran hari ini</p>
                </button>
                <button onclick="janaLaporanBulanan()" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition">
                    <h4 class="font-semibold">Laporan Bulanan</h4>
                    <p class="text-sm opacity-90">Kehadiran bulan ini</p>
                </button>
                <button onclick="janaLaporanTahunan()" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition">
                    <h4 class="font-semibold">Laporan Tahunan</h4>
                    <p class="text-sm opacity-90">Kehadiran tahun ini</p>
                </button>
            </div>
            <div id="laporanContent" class="bg-gray-50 p-4 rounded-lg min-h-32">
                <p class="text-gray-600 text-center">Pilih jenis laporan untuk melihat data</p>
            </div>
            <button onclick="closeLaporan()" class="w-full mt-4 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                Tutup
            </button>
        </div>
    </div>

    <!-- Modal untuk Pengurusan Pusat -->
    <div id="pusatManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Pengurusan Pusat GIATMARA</h3>
            
            <!-- Form Tambah Pusat -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">Tambah Pusat Baru</h4>
                <form onsubmit="tambahPusat(event)" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nama Pusat</label>
                        <input type="text" id="namaPusat" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Contoh: GIATMARA Pasir Mas" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Alamat Pusat</label>
                        <textarea id="alamatPusat" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Masukkan alamat lengkap pusat" required></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Kata Laluan Pusat</label>
                        <input type="password" id="passwordPusat" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Masukkan kata laluan untuk pusat ini" required>
                        <p class="text-xs text-gray-500 mt-1">Kata laluan ini akan digunakan oleh kakitangan pusat untuk log masuk</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Sahkan Kata Laluan</label>
                        <input type="password" id="confirmPasswordPusat" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Sahkan kata laluan" required>
                    </div>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                        Tambah Pusat
                    </button>
                </form>
            </div>

            <!-- Senarai Pusat Sedia Ada -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">Pusat Sedia Ada</h4>
                <div class="space-y-2">
                    <!-- Dynamic center list will be populated here -->
                </div>
            </div>

            <button onclick="closePusatManagement()" class="w-full bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                Tutup
            </button>
        </div>
    </div>

    <!-- Modal untuk Pengurusan Kursus -->
    <div id="kursusManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Pengurusan Kursus</h3>
            
            <!-- Form Tambah Kursus -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">Tambah Kursus Baru</h4>
                <form onsubmit="tambahKursus(event)" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nama Kursus</label>
                        <input type="text" id="namaKursus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Contoh: Teknologi Automotif" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Tempoh Kursus (Bulan)</label>
                        <select id="tempohKursus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                            <option value="">Pilih Tempoh</option>
                            <option value="3">3 Bulan</option>
                            <option value="6">6 Bulan</option>
                            <option value="9">9 Bulan</option>
                            <option value="12">12 Bulan</option>
                            <option value="18">18 Bulan</option>
                            <option value="24">24 Bulan</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                        Tambah Kursus
                    </button>
                </form>
            </div>

            <!-- Senarai Kursus Sedia Ada -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">Kursus Sedia Ada</h4>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Dynamic content will be populated here -->
                </div>
            </div>

            <button onclick="closeKursusManagement()" class="w-full bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                Tutup
            </button>
        </div>
    </div>

    <!-- Modal untuk Pengurusan Sesi -->
    <div id="sesiManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Pengurusan Sesi Kursus</h3>
            
            <!-- Form Tambah Sesi -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">Tambah Sesi Baru</h4>
                <form onsubmit="tambahSesi(event)" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nama Sesi</label>
                        <input type="text" id="namaSesi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Contoh: Sesi Pagi Elektrik" required>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Masa Mula</label>
                            <input type="time" id="masaMula" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Masa Tamat</label>
                            <input type="time" id="masaTamat" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Bilangan Bulan</label>
                            <input type="number" id="bilanganBulan" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" min="1" max="24" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Bilangan Hari</label>
                            <input type="number" id="bilanganHari" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" min="1" max="31" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Tahun</label>
                            <input type="number" id="tahunSesi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" min="2024" max="2030" value="2024" required>
                        </div>
                    </div>
                    <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                        Tambah Sesi
                    </button>
                </form>
            </div>

            <!-- Senarai Sesi Sedia Ada -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">Sesi Sedia Ada</h4>
                <div class="space-y-2">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">Sesi Pagi - Elektrik</span>
                            <span class="text-green-600 text-sm">Aktif</span>
                        </div>
                        <p class="text-sm text-gray-600">8:00 AM - 12:00 PM | 6 bulan | 2024</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">Sesi Petang - Komputer</span>
                            <span class="text-green-600 text-sm">Aktif</span>
                        </div>
                        <p class="text-sm text-gray-600">2:00 PM - 6:00 PM | 6 bulan | 2024</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">Sesi Pagi - Mekanikal</span>
                            <span class="text-green-600 text-sm">Aktif</span>
                        </div>
                        <p class="text-sm text-gray-600">8:00 AM - 12:00 PM | 9 bulan | 2024</p>
                    </div>
                </div>
            </div>

            <button onclick="closeSesiManagement()" class="w-full bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                Tutup
            </button>
        </div>
    </div>

    <!-- Modal untuk Pengurusan Pelatih -->
    <div id="pelatihManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Pengurusan Pelatih Keseluruhan</h3>
                <button onclick="closePelatihManagement()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Filter Section -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200">
                <h4 class="font-semibold text-blue-800 mb-4">üîç Carian dan Penapis</h4>
                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-blue-700 mb-2">Pusat:</label>
                        <select id="filterPusatPelatih" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white" onchange="filterPelatihData()">
                            <option value="">Semua Pusat</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-blue-700 mb-2">Kursus:</label>
                        <select id="filterKursusPelatih" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white" onchange="filterPelatihData()">
                            <option value="">Semua Kursus</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-blue-700 mb-2">Sesi:</label>
                        <select id="filterSesiPelatih" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white" onchange="filterPelatihData()">
                            <option value="">Semua Sesi</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-blue-700 mb-2">Tahun:</label>
                        <select id="filterTahunPelatih" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white" onchange="filterPelatihData()">
                            <option value="">Semua Tahun</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex flex-wrap gap-3">
                    <div class="flex-1 min-w-64">
                        <label class="block text-sm font-medium text-blue-700 mb-2">Cari Nama/No. KP:</label>
                        <input type="text" id="searchPelatihName" placeholder="Masukkan nama atau no. KP pelatih..." class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500" onkeyup="filterPelatihData()">
                    </div>
                    <div class="flex items-end space-x-2">
                        <button onclick="resetPelatihFilter()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                            Reset
                        </button>
                        <button onclick="exportPelatihData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            Export Excel
                        </button>
                        <button onclick="showBulkDeleteOptions()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            üóëÔ∏è Padam Pelatih
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Section -->
            <div class="grid md:grid-cols-5 gap-4 mb-6">
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-blue-600" id="totalPelatihKeseluruhan">0</p>
                    <p class="text-sm text-gray-600">Jumlah Pelatih</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-green-600" id="pelatihAktif">0</p>
                    <p class="text-sm text-gray-600">Pelatih Aktif</p>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-purple-600" id="jumlahPusat">0</p>
                    <p class="text-sm text-gray-600">Pusat Terlibat</p>
                </div>
                <div class="bg-orange-100 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-orange-600" id="jumlahKursus">0</p>
                    <p class="text-sm text-gray-600">Kursus Ditawarkan</p>
                </div>
                <div class="bg-teal-100 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-teal-600" id="jumlahSesi">0</p>
                    <p class="text-sm text-gray-600">Sesi Berjalan</p>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="bg-white border rounded-lg">
                <div class="p-4 border-b bg-gray-50">
                    <div class="flex justify-between items-center">
                        <h5 class="font-semibold text-gray-800">Senarai Pelatih</h5>
                        <div class="text-sm text-gray-600">
                            Menunjukkan <span id="showingCount">0</span> dari <span id="totalCount">0</span> pelatih
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left border-b">Bil</th>
                                <th class="px-4 py-3 text-left border-b">Nama Pelatih</th>
                                <th class="px-4 py-3 text-left border-b">No. KP</th>
                                <th class="px-4 py-3 text-left border-b">Pusat</th>
                                <th class="px-4 py-3 text-left border-b">Kursus</th>
                                <th class="px-4 py-3 text-left border-b">Sesi</th>
                                <th class="px-4 py-3 text-left border-b">Tahun</th>
                                <th class="px-4 py-3 text-left border-b">No. Telefon</th>
                                <th class="px-4 py-3 text-center border-b">Status</th>
                                <th class="px-4 py-3 text-center border-b">Kehadiran</th>
                                <th class="px-4 py-3 text-center border-b">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="pelatihTableBody">
                            <!-- Dynamic content will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="noPelatihMessage" class="hidden p-8 text-center text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <p class="font-medium">Tiada pelatih dijumpai</p>
                    <p class="text-sm mt-1">Cuba ubah kriteria carian atau tambah pelatih baru</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Sejarah Kehadiran -->
    <div id="attendanceHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">üìä Sejarah Kehadiran Pelatih</h3>
                <button onclick="closeAttendanceHistory()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Filter Section -->
            <div class="bg-purple-50 p-4 rounded-lg mb-6 border border-purple-200">
                <h4 class="font-semibold text-purple-800 mb-4">üîç Penapis Sejarah</h4>
                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-2">Pelatih:</label>
                        <select id="filterHistoryPelatih" class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white" onchange="filterAttendanceHistory()">
                            <option value="">Semua Pelatih</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-2">Dari Tarikh:</label>
                        <input type="date" id="filterHistoryFromDate" class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="filterAttendanceHistory()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-2">Hingga Tarikh:</label>
                        <input type="date" id="filterHistoryToDate" class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="filterAttendanceHistory()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-2">Status:</label>
                        <select id="filterHistoryStatus" class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white" onchange="filterAttendanceHistory()">
                            <option value="">Semua Status</option>
                            <option value="Hadir">Hadir</option>
                            <option value="Lewat">Lewat</option>
                            <option value="Tidak Hadir">Tidak Hadir</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="resetHistoryFilter()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                        Reset
                    </button>
                    <button onclick="exportAttendanceHistory()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        Export Excel
                    </button>
                    <button onclick="generateAttendanceReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Jana Laporan
                    </button>
                </div>
            </div>
            
            <!-- Statistics Section -->
            <div class="grid md:grid-cols-5 gap-4 mb-6">
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-blue-600" id="totalHistoryDays">0</p>
                    <p class="text-sm text-gray-600">Hari Direkod</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-green-600" id="totalHistoryPresent">0</p>
                    <p class="text-sm text-gray-600">Jumlah Hadir</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-yellow-600" id="totalHistoryLate">0</p>
                    <p class="text-sm text-gray-600">Jumlah Lewat</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-red-600" id="totalHistoryAbsent">0</p>
                    <p class="text-sm text-gray-600">Jumlah Tidak Hadir</p>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-purple-600" id="averageHistoryAttendance">0%</p>
                    <p class="text-sm text-gray-600">Purata Kehadiran</p>
                </div>
            </div>
            
            <!-- History Table -->
            <div class="bg-white border rounded-lg">
                <div class="p-4 border-b bg-gray-50">
                    <div class="flex justify-between items-center">
                        <h5 class="font-semibold text-gray-800">Rekod Kehadiran Mengikut Tarikh</h5>
                        <div class="text-sm text-gray-600">
                            Menunjukkan <span id="historyShowingCount">0</span> rekod
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left border-b">Tarikh</th>
                                <th class="px-4 py-3 text-left border-b">Hari</th>
                                <th class="px-4 py-3 text-left border-b">Pelatih</th>
                                <th class="px-4 py-3 text-left border-b">Kursus</th>
                                <th class="px-4 py-3 text-center border-b">Status</th>
                                <th class="px-4 py-3 text-center border-b">Masa Rekod</th>
                                <th class="px-4 py-3 text-center border-b">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceHistoryTableBody">
                            <!-- Dynamic content will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="noHistoryMessage" class="hidden p-8 text-center text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <p class="font-medium">Tiada sejarah kehadiran dijumpai</p>
                    <p class="text-sm mt-1">Rekod kehadiran akan muncul selepas anda mula menggunakan sistem</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Padam Pelatih Secara Pukal -->
    <div id="bulkDeleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-red-800">üóëÔ∏è Padam Pelatih Secara Pukal</h3>
                <button onclick="closeBulkDelete()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Warning Section -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <div class="flex items-center space-x-2 mb-3">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <h4 class="font-semibold text-red-800">‚ö†Ô∏è AMARAN PENTING</h4>
                </div>
                <div class="text-red-700 text-sm space-y-2">
                    <p><strong>Tindakan ini TIDAK BOLEH dibatalkan!</strong></p>
                    <p>‚Ä¢ Semua data pelatih yang dipilih akan dipadam secara kekal</p>
                    <p>‚Ä¢ Rekod kehadiran dan maklumat berkaitan akan turut dipadam</p>
                    <p>‚Ä¢ Sila pastikan anda telah membuat backup data sebelum meneruskan</p>
                </div>
            </div>
            
            <!-- Delete Options -->
            <div class="space-y-6">
                <h5 class="font-semibold text-gray-800 mb-4">Pilih Kaedah Pemadaman:</h5>
                
                <!-- Option 1: Delete All -->
                <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                    <div class="flex items-start space-x-3">
                        <input type="radio" id="deleteAll" name="deleteOption" value="all" class="mt-1">
                        <div class="flex-1">
                            <label for="deleteAll" class="font-semibold text-red-800 cursor-pointer">
                                üö® Padam SEMUA Pelatih (Seluruh Sistem)
                            </label>
                            <p class="text-sm text-red-700 mt-1">
                                Padam semua pelatih dari semua pusat, kursus, dan sesi. 
                                <strong>Jumlah: <span id="totalAllTrainees">0</span> pelatih</strong>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Option 2: Delete by Center -->
                <div class="border border-orange-200 rounded-lg p-4 bg-orange-50">
                    <div class="flex items-start space-x-3">
                        <input type="radio" id="deleteByCenter" name="deleteOption" value="center" class="mt-1">
                        <div class="flex-1">
                            <label for="deleteByCenter" class="font-semibold text-orange-800 cursor-pointer">
                                üè¢ Padam Mengikut Pusat
                            </label>
                            <p class="text-sm text-orange-700 mt-1 mb-3">
                                Padam semua pelatih dari pusat yang dipilih sahaja
                            </p>
                            <select id="deleteCenterSelect" class="w-full px-3 py-2 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 bg-white text-sm" disabled>
                                <option value="">Pilih Pusat untuk Dipadam</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Option 3: Delete by Course -->
                <div class="border border-yellow-200 rounded-lg p-4 bg-yellow-50">
                    <div class="flex items-start space-x-3">
                        <input type="radio" id="deleteByCourse" name="deleteOption" value="course" class="mt-1">
                        <div class="flex-1">
                            <label for="deleteByCourse" class="font-semibold text-yellow-800 cursor-pointer">
                                üìö Padam Mengikut Kursus
                            </label>
                            <p class="text-sm text-yellow-700 mt-1 mb-3">
                                Padam semua pelatih dari kursus yang dipilih sahaja
                            </p>
                            <select id="deleteCourseSelect" class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white text-sm" disabled>
                                <option value="">Pilih Kursus untuk Dipadam</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Option 4: Delete by Session -->
                <div class="border border-purple-200 rounded-lg p-4 bg-purple-50">
                    <div class="flex items-start space-x-3">
                        <input type="radio" id="deleteBySession" name="deleteOption" value="session" class="mt-1">
                        <div class="flex-1">
                            <label for="deleteBySession" class="font-semibold text-purple-800 cursor-pointer">
                                üïê Padam Mengikut Sesi
                            </label>
                            <p class="text-sm text-purple-700 mt-1 mb-3">
                                Padam semua pelatih dari sesi yang dipilih sahaja
                            </p>
                            <select id="deleteSessionSelect" class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white text-sm" disabled>
                                <option value="">Pilih Sesi untuk Dipadam</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Option 5: Delete by Year -->
                <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                    <div class="flex items-start space-x-3">
                        <input type="radio" id="deleteByYear" name="deleteOption" value="year" class="mt-1">
                        <div class="flex-1">
                            <label for="deleteByYear" class="font-semibold text-blue-800 cursor-pointer">
                                üìÖ Padam Mengikut Tahun
                            </label>
                            <p class="text-sm text-blue-700 mt-1 mb-3">
                                Padam semua pelatih dari tahun yang dipilih sahaja
                            </p>
                            <select id="deleteYearSelect" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white text-sm" disabled>
                                <option value="">Pilih Tahun untuk Dipadam</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Preview Section -->
            <div id="deletePreview" class="hidden mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <h6 class="font-semibold text-gray-800 mb-3">üëÄ Pratonton Pemadaman:</h6>
                <div id="deletePreviewContent" class="text-sm text-gray-700">
                    <!-- Dynamic content will be populated here -->
                </div>
            </div>
            
            <!-- Confirmation Section -->
            <div id="confirmationSection" class="hidden mt-6 p-4 bg-red-100 border border-red-300 rounded-lg">
                <h6 class="font-semibold text-red-800 mb-3">‚úã Pengesahan Akhir:</h6>
                <div class="space-y-3">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="confirmBackup" class="rounded">
                        <label for="confirmBackup" class="text-sm text-red-700">
                            Saya telah membuat backup data pelatih
                        </label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="confirmUnderstand" class="rounded">
                        <label for="confirmUnderstand" class="text-sm text-red-700">
                            Saya faham bahawa tindakan ini tidak boleh dibatalkan
                        </label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="confirmProceed" class="rounded">
                        <label for="confirmProceed" class="text-sm text-red-700">
                            Saya ingin meneruskan pemadaman data
                        </label>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-red-800 mb-2">
                            Taip "PADAM" untuk mengesahkan:
                        </label>
                        <input type="text" id="confirmationText" placeholder="Taip PADAM di sini" class="w-full px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500" maxlength="5">
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex space-x-4 mt-8">
                <button onclick="closeBulkDelete()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition font-medium">
                    ‚ùå Batal
                </button>
                <button onclick="previewDeletion()" id="previewBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium" disabled>
                    üëÅÔ∏è Pratonton
                </button>
                <button onclick="executeBulkDelete()" id="executeBtn" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition font-medium hidden">
                    üóëÔ∏è Padam Sekarang
                </button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Pengurusan Logo -->
    <div id="logoManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Pengurusan Logo Dashboard</h3>
                <button onclick="closeLogoManagement()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Bahagian Kiri - Upload Logo Baru -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">Upload Logo Baru</h4>
                    
                    <!-- Upload Area -->
                    <div class="border-2 border-dashed border-indigo-300 rounded-lg p-6 text-center hover:border-indigo-400 transition mb-6">
                        <div class="mb-4">
                            <svg class="w-12 h-12 text-indigo-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <h5 class="text-lg font-semibold text-gray-700 mb-2">Pilih Logo Baru</h5>
                            <p class="text-gray-600 mb-4">Drag & drop fail atau klik untuk pilih</p>
                            <p class="text-sm text-gray-500 mb-4">Format yang disokong: PNG, JPG, JPEG, SVG</p>
                            <p class="text-xs text-gray-400">Saiz maksimum: 2MB | Resolusi disyorkan: 200x200px</p>
                        </div>
                        
                        <input type="file" id="logoFileInput" accept=".png,.jpg,.jpeg,.svg" onchange="handleLogoUpload(event)" class="hidden">
                        <button onclick="document.getElementById('logoFileInput').click()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition font-medium">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Pilih Fail Logo
                        </button>
                    </div>
                    
                    <!-- Preview Logo Baru -->
                    <div id="logoPreview" class="hidden bg-gray-50 border rounded-lg p-4 mb-6">
                        <h6 class="font-semibold text-gray-700 mb-3">Pratonton Logo Baru</h6>
                        <div class="flex items-center justify-center bg-white border rounded-lg p-4 mb-4">
                            <img id="previewImage" src="" alt="Logo Preview" class="max-w-32 max-h-32 object-contain">
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="applyNewLogo()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition font-medium">
                                ‚úì Guna Logo Ini
                            </button>
                            <button onclick="cancelLogoUpload()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition">
                                ‚úó Batal
                            </button>
                        </div>
                    </div>
                    
                    <!-- Logo Templates -->
                    <div class="mb-6">
                        <h6 class="font-semibold text-gray-700 mb-3">Template Logo Tersedia</h6>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="useTemplateIcon('G')" class="bg-blue-600 text-white w-16 h-16 rounded-lg hover:bg-blue-700 transition font-bold text-xl">
                                G
                            </button>
                            <button onclick="useTemplateIcon('üè¢')" class="bg-green-600 text-white w-16 h-16 rounded-lg hover:bg-green-700 transition text-2xl">
                                üè¢
                            </button>
                            <button onclick="useTemplateIcon('üéì')" class="bg-purple-600 text-white w-16 h-16 rounded-lg hover:bg-purple-700 transition text-2xl">
                                üéì
                            </button>
                            <button onclick="useTemplateIcon('‚öôÔ∏è')" class="bg-orange-600 text-white w-16 h-16 rounded-lg hover:bg-orange-700 transition text-2xl">
                                ‚öôÔ∏è
                            </button>
                            <button onclick="useTemplateIcon('üìö')" class="bg-red-600 text-white w-16 h-16 rounded-lg hover:bg-red-700 transition text-2xl">
                                üìö
                            </button>
                            <button onclick="useTemplateIcon('üîß')" class="bg-indigo-600 text-white w-16 h-16 rounded-lg hover:bg-indigo-700 transition text-2xl">
                                üîß
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Klik pada template untuk menggunakan sebagai logo</p>
                    </div>
                </div>
                
                <!-- Bahagian Kanan - Logo Semasa & Sejarah -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">Logo Semasa</h4>
                    
                    <!-- Current Logo Display -->
                    <div class="bg-gray-50 border rounded-lg p-6 text-center mb-6">
                        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-gray-200">
                            <span id="currentLogoDisplay" class="text-purple-600 font-bold text-2xl">G</span>
                        </div>
                        <h6 class="font-semibold text-gray-800">GIATMARA Kelantan</h6>
                        <p class="text-sm text-gray-600">Logo semasa sistem</p>
                        <div class="mt-4 flex space-x-2 justify-center">
                            <button onclick="resetToDefaultLogo()" class="px-4 py-2 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700 transition">
                                Reset ke Default
                            </button>
                            <button onclick="downloadCurrentLogo()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition">
                                Muat Turun
                            </button>
                        </div>
                    </div>
                    
                    <!-- Logo History -->
                    <div class="mb-6">
                        <h6 class="font-semibold text-gray-700 mb-3">Sejarah Logo</h6>
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center border">
                                        <span class="text-purple-600 font-bold">G</span>
                                    </div>
                                    <div>
                                        <p class="font-medium text-sm">Logo Default</p>
                                        <p class="text-xs text-gray-500">Digunakan: Hari ini</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button onclick="revertToLogo('default')" class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                        Guna
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center border">
                                        <span class="text-green-600 text-lg">üè¢</span>
                                    </div>
                                    <div>
                                        <p class="font-medium text-sm">Logo Bangunan</p>
                                        <p class="text-xs text-gray-500">Digunakan: 2 hari lalu</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button onclick="revertToLogo('building')" class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                        Guna
                                    </button>
                                    <button onclick="deleteLogo('building')" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                                        Padam
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center border">
                                        <span class="text-purple-600 text-lg">üéì</span>
                                    </div>
                                    <div>
                                        <p class="font-medium text-sm">Logo Pendidikan</p>
                                        <p class="text-xs text-gray-500">Digunakan: 1 minggu lalu</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button onclick="revertToLogo('education')" class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                        Guna
                                    </button>
                                    <button onclick="deleteLogo('education')" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                                        Padam
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logo Settings -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h6 class="font-semibold text-blue-800 mb-3">Tetapan Logo</h6>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span>Saiz Logo:</span>
                                <select id="logoSize" class="px-2 py-1 border rounded text-xs" onchange="updateLogoSize()">
                                    <option value="small">Kecil (32px)</option>
                                    <option value="medium" selected>Sederhana (40px)</option>
                                    <option value="large">Besar (48px)</option>
                                </select>
                            </div>
                            <div class="flex justify-between">
                                <span>Bentuk Logo:</span>
                                <select id="logoShape" class="px-2 py-1 border rounded text-xs" onchange="updateLogoShape()">
                                    <option value="circle" selected>Bulat</option>
                                    <option value="square">Segi Empat</option>
                                    <option value="rounded">Segi Empat Bulat</option>
                                </select>
                            </div>
                            <div class="flex justify-between">
                                <span>Warna Latar:</span>
                                <input type="color" id="logoBackground" value="#ffffff" class="w-8 h-6 border rounded" onchange="updateLogoBackground()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentUserType = null;
        let pelatihData = [];
        
        // Attendance data storage - stores attendance by date
        let attendanceHistory = {
            // Format: 'YYYY-MM-DD': { pelatihId: 'status', pelatihId2: 'status' }
        };
        
        // Edit mode state
        let isEditMode = false;

        // Local Storage Keys
        const STORAGE_KEYS = {
            PELATIH_DATA: 'giatmara_pelatih_data',
            ATTENDANCE_HISTORY: 'giatmara_attendance_history',
            SESI_DATA: 'giatmara_sesi_data',
            PUSAT_DATA: 'giatmara_pusat_data',
            KURSUS_DATA: 'giatmara_kursus_data',
            CURRENT_LOGO: 'giatmara_current_logo',
            LOGO_HISTORY: 'giatmara_logo_history',
            SYSTEM_SETTINGS: 'giatmara_system_settings'
        };

        // Local Storage Functions
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }

        function loadFromLocalStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return defaultValue;
            }
        }

        function clearLocalStorage() {
            try {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                return true;
            } catch (error) {
                console.error('Error clearing localStorage:', error);
                return false;
            }
        }

        // Auto-save functions
        function autoSavePelatihData() {
            saveToLocalStorage(STORAGE_KEYS.PELATIH_DATA, pelatihData);
        }

        function autoSaveAttendanceHistory() {
            saveToLocalStorage(STORAGE_KEYS.ATTENDANCE_HISTORY, attendanceHistory);
        }

        function autoSaveSesiData() {
            saveToLocalStorage(STORAGE_KEYS.SESI_DATA, sesiData);
        }

        function autoSavePusatData() {
            saveToLocalStorage(STORAGE_KEYS.PUSAT_DATA, pusatData);
        }

        function autoSaveKursusData() {
            saveToLocalStorage(STORAGE_KEYS.KURSUS_DATA, kursusData);
        }

        function autoSaveCurrentLogo() {
            saveToLocalStorage(STORAGE_KEYS.CURRENT_LOGO, currentLogo);
        }

        function autoSaveLogoHistory() {
            saveToLocalStorage(STORAGE_KEYS.LOGO_HISTORY, logoHistory);
        }

        // Load all data from localStorage on startup
        function initializeFromLocalStorage() {
            // Load pelatih data
            const savedPelatihData = loadFromLocalStorage(STORAGE_KEYS.PELATIH_DATA, []);
            if (savedPelatihData.length > 0) {
                pelatihData = savedPelatihData;
            }

            // Load attendance history
            const savedAttendanceHistory = loadFromLocalStorage(STORAGE_KEYS.ATTENDANCE_HISTORY, {});
            if (Object.keys(savedAttendanceHistory).length > 0) {
                attendanceHistory = savedAttendanceHistory;
            }

            // Load sesi data
            const savedSesiData = loadFromLocalStorage(STORAGE_KEYS.SESI_DATA);
            if (savedSesiData && savedSesiData.length > 0) {
                sesiData = savedSesiData;
            }

            // Load pusat data
            const savedPusatData = loadFromLocalStorage(STORAGE_KEYS.PUSAT_DATA);
            if (savedPusatData && savedPusatData.length > 0) {
                pusatData = savedPusatData;
            }

            // Load kursus data
            const savedKursusData = loadFromLocalStorage(STORAGE_KEYS.KURSUS_DATA);
            if (savedKursusData && savedKursusData.length > 0) {
                kursusData = savedKursusData;
            }

            // Load current logo
            const savedCurrentLogo = loadFromLocalStorage(STORAGE_KEYS.CURRENT_LOGO);
            if (savedCurrentLogo) {
                currentLogo = savedCurrentLogo;
                updateAllLogoDisplays();
                updateCurrentLogoDisplay();
            }

            // Load logo history
            const savedLogoHistory = loadFromLocalStorage(STORAGE_KEYS.LOGO_HISTORY);
            if (savedLogoHistory && savedLogoHistory.length > 0) {
                logoHistory = savedLogoHistory;
            }

            console.log('‚úÖ Data berjaya dimuat dari Local Storage');
        }

        // Global array to store session data
        let sesiData = [
            {
                id: 1,
                namaSesi: "Sesi Pagi Elektrik 2024",
                kodKursus: "ELK001",
                namaKursus: "PENDAWAI ELEKTRIK (PW4)",
                tahun: "2024",
                tempoh: "6",
                tarikhMula: "2024-01-01",
                tarikhTamat: "2024-06-30",
                masaMula: "08:00",
                masaTamat: "12:00",
                kapasiti: 25,
                keterangan: "Sesi pagi untuk kursus elektrik tahun 2024",
                status: "Aktif",
                pelatihTerdaftar: 2
            },
            {
                id: 2,
                namaSesi: "Sesi Petang Komputer 2024",
                kodKursus: "KOM001",
                namaKursus: "TEKNOLOGI SISTEM KOMPUTER",
                tahun: "2024",
                tempoh: "6",
                tarikhMula: "2024-02-01",
                tarikhTamat: "2024-07-31",
                masaMula: "14:00",
                masaTamat: "18:00",
                kapasiti: 20,
                keterangan: "Sesi petang untuk kursus komputer tahun 2024",
                status: "Aktif",
                pelatihTerdaftar: 2
            },
            {
                id: 3,
                namaSesi: "Sesi Pagi Mekanikal 2024",
                kodKursus: "MEK001",
                namaKursus: "TEKNOLOGI AUTOMOTIF (TAHAP 2)",
                tahun: "2024",
                tempoh: "9",
                tarikhMula: "2024-03-01",
                tarikhTamat: "2024-11-30",
                masaMula: "08:00",
                masaTamat: "12:00",
                kapasiti: 30,
                keterangan: "Sesi pagi untuk kursus mekanikal tahun 2024",
                status: "Akan Datang",
                pelatihTerdaftar: 0
            }
        ];

        // Show different login forms
        function showPusatLogin() {
            document.getElementById('loginSelection').classList.add('hidden');
            document.getElementById('pusatLoginForm').classList.remove('hidden');
        }

        function showAdminLogin() {
            document.getElementById('loginSelection').classList.add('hidden');
            document.getElementById('adminLoginForm').classList.remove('hidden');
        }

        function backToSelection() {
            document.getElementById('pusatLoginForm').classList.add('hidden');
            document.getElementById('adminLoginForm').classList.add('hidden');
            document.getElementById('loginSelection').classList.remove('hidden');
        }

        // Login functions
        function loginPusat(event) {
            event.preventDefault();
            const pusatValue = document.getElementById('pusatSelect').value;
            const password = document.getElementById('pusatPassword').value;
            
            if (!pusatValue || !password) {
                alert('Sila pilih pusat dan masukkan kata laluan!');
                return;
            }
            
            // Find the selected center and validate password
            const selectedPusat = pusatData.find(p => {
                const pusatKey = p.nama.toLowerCase().replace(/\s+/g, '-').replace('giatmara-', '');
                return pusatKey === pusatValue;
            });
            
            if (selectedPusat && selectedPusat.password === password) {
                currentUser = selectedPusat.nama;
                currentUserType = 'pusat';
                document.getElementById('currentUser').textContent = `Pusat: ${selectedPusat.nama}`;
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('pusatLoginForm').classList.add('hidden');
                document.getElementById('pusatDashboard').classList.remove('hidden');
                updatePusatStats();
            } else {
                alert('Kata laluan tidak betul! Sila cuba sekali lagi atau hubungi pentadbir sistem.');
            }
        }

        function loginAdmin(event) {
            event.preventDefault();
            const adminId = document.getElementById('adminId').value;
            const password = document.getElementById('adminPassword').value;
            
            if (adminId === 'admin' && password === 'admin123') {
                currentUser = 'Administrator';
                currentUserType = 'admin';
                document.getElementById('currentUser').textContent = 'Administrator';
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('adminLoginForm').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
            } else {
                alert('ID Admin atau kata laluan tidak betul!');
            }
        }

        function logout() {
            currentUser = null;
            currentUserType = null;
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('pusatDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('loginSelection').classList.remove('hidden');
            
            // Reset forms
            document.getElementById('pusatSelect').value = '';
            document.getElementById('pusatPassword').value = '';
            document.getElementById('adminId').value = '';
            document.getElementById('adminPassword').value = '';
        }

        // Update pusat statistics
        function updatePusatStats() {
            const total = pelatihData.length;
            const hadir = pelatihData.filter(p => p.status === 'Hadir').length;
            const tidakHadir = pelatihData.filter(p => p.status === 'Tidak Hadir').length;
            const lewat = pelatihData.filter(p => p.status === 'Lewat').length;
            
            document.getElementById('totalPelatih').textContent = total;
            document.getElementById('hadirHariIni').textContent = hadir;
            document.getElementById('tidakHadir').textContent = tidakHadir;
            document.getElementById('lewat').textContent = lewat;
            
            // Update course filters whenever stats are updated
            updateCourseFilters();
        }

        // Update course filter options based on current pelatih data
        function updateCourseFilters() {
            // Get unique courses from current pelatih data
            const uniqueCourses = [...new Set(pelatihData.map(p => p.kursus))].sort();
            
            // Update attendance filter dropdown
            const filterKursus = document.getElementById('filterKursus');
            if (filterKursus) {
                const currentValue = filterKursus.value;
                filterKursus.innerHTML = '<option value="">Semua Kursus</option>';
                
                uniqueCourses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    if (course === currentValue) option.selected = true;
                    filterKursus.appendChild(option);
                });
            }
            
            // Update report filter dropdown
            const laporanKursus = document.getElementById('laporanKursus');
            if (laporanKursus) {
                const currentValue = laporanKursus.value;
                laporanKursus.innerHTML = '<option value="">Semua Kursus</option>';
                
                uniqueCourses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    if (course === currentValue) option.selected = true;
                    laporanKursus.appendChild(option);
                });
            }
            
            // Update add trainee form dropdown
            const kursusPelatih = document.getElementById('kursusPelatih');
            if (kursusPelatih) {
                const currentValue = kursusPelatih.value;
                kursusPelatih.innerHTML = '<option value="">Pilih Kursus</option>';
                
                // Add default courses if no data exists yet
                const defaultCourses = ['Elektrik', 'Komputer', 'Mekanikal', 'Kimpalan'];
                const coursesToShow = uniqueCourses.length > 0 ? uniqueCourses : defaultCourses;
                
                coursesToShow.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    if (course === currentValue) option.selected = true;
                    kursusPelatih.appendChild(option);
                });
            }
            
            // Update yearly report course dropdown
            const laporanTahunanKursus = document.getElementById('laporanTahunanKursus');
            if (laporanTahunanKursus) {
                const currentValue = laporanTahunanKursus.value;
                laporanTahunanKursus.innerHTML = '<option value="">Semua Kursus</option>';
                
                uniqueCourses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    if (course === currentValue) option.selected = true;
                    laporanTahunanKursus.appendChild(option);
                });
            }
        }

        // Modal functions
        function showTambahPelatih() {
            document.getElementById('tambahPelatihModal').classList.remove('hidden');
            updateSesiDropdown();
        }
        
        // Update session dropdown for add trainee form
        function updateSesiDropdown() {
            const sesiSelect = document.getElementById('sesiPelatih');
            sesiSelect.innerHTML = '<option value="">Pilih Sesi Kursus</option>';
            
            // Show active sessions and upcoming sessions that are not full
            const availableSesi = sesiData.filter(s => 
                (s.status === 'Aktif' || s.status === 'Akan Datang') && 
                s.pelatihTerdaftar < s.kapasiti
            );
            
            // Sort by status (Active first, then Upcoming) and then by name
            availableSesi.sort((a, b) => {
                if (a.status !== b.status) {
                    return a.status === 'Aktif' ? -1 : 1;
                }
                return a.namaSesi.localeCompare(b.namaSesi);
            });
            
            availableSesi.forEach(sesi => {
                const option = document.createElement('option');
                option.value = sesi.id;
                const statusLabel = sesi.status === 'Aktif' ? 'üü¢' : 'üîµ';
                option.textContent = `${statusLabel} ${sesi.namaSesi} (${sesi.pelatihTerdaftar}/${sesi.kapasiti})`;
                sesiSelect.appendChild(option);
            });
            
            // Add event listener to update course field when session is selected
            sesiSelect.onchange = function() {
                const selectedSesiId = this.value;
                const kursusField = document.getElementById('kursusPelatih');
                
                if (selectedSesiId) {
                    const selectedSesi = sesiData.find(s => s.id == selectedSesiId);
                    if (selectedSesi) {
                        kursusField.value = selectedSesi.namaKursus;
                    }
                } else {
                    kursusField.value = '';
                }
            };
        }

        function closeTambahPelatih() {
            document.getElementById('tambahPelatihModal').classList.add('hidden');
            document.getElementById('namaPelatih').value = '';
            document.getElementById('noKP').value = '';
            document.getElementById('sesiPelatih').value = '';
            document.getElementById('kursusPelatih').value = '';
            document.getElementById('noTelefon').value = '';
        }

        function tambahPelatih(event) {
            event.preventDefault();
            const nama = document.getElementById('namaPelatih').value;
            const noKP = document.getElementById('noKP').value;
            const sesiId = document.getElementById('sesiPelatih').value;
            const kursus = document.getElementById('kursusPelatih').value;
            const telefon = document.getElementById('noTelefon').value;
            
            // Find the selected session
            const selectedSesi = sesiData.find(s => s.id == sesiId);
            if (!selectedSesi) {
                alert('Sila pilih sesi kursus yang sah!');
                return;
            }
            
            // Check if session is full
            if (selectedSesi.pelatihTerdaftar >= selectedSesi.kapasiti) {
                alert(`Sesi "${selectedSesi.namaSesi}" sudah penuh! Kapasiti maksimum: ${selectedSesi.kapasiti} pelatih.`);
                return;
            }
            
            // Check for duplicate No. KP
            const existingPelatih = pelatihData.find(p => p.noKP === noKP);
            if (existingPelatih) {
                alert(`Pelatih dengan No. KP "${noKP}" sudah wujud dalam sistem!`);
                return;
            }
            
            const newPelatih = {
                id: pelatihData.length + 1,
                nama: nama,
                noKP: noKP,
                sesiId: sesiId,
                sesiNama: selectedSesi.namaSesi,
                kodKursus: selectedSesi.kodKursus,
                kursus: kursus,
                telefon: telefon,
                status: 'Tidak Hadir'
            };
            
            pelatihData.push(newPelatih);
            
            // Update session's registered trainee count
            selectedSesi.pelatihTerdaftar++;
            
            // Auto-save to localStorage
            autoSavePelatihData();
            autoSaveSesiData();
            
            updatePusatStats();
            closeTambahPelatih();
            alert(`Pelatih "${nama}" berjaya ditambah ke sesi "${selectedSesi.namaSesi}"!`);
        }

        function showImportPelatih() {
            document.getElementById('importPelatihModal').classList.remove('hidden');
        }

        function closeImportPelatih() {
            document.getElementById('importPelatihModal').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            document.getElementById('importPreview').innerHTML = '';
            document.getElementById('importResults').classList.add('hidden');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            const fileExtension = fileName.split('.').pop();

            // Check file type
            if (!['csv', 'xlsx', 'xls', 'txt'].includes(fileExtension)) {
                alert('Format fail tidak disokong. Sila gunakan fail CSV, Excel (.xlsx/.xls), atau TXT.');
                event.target.value = '';
                return;
            }

            // Show loading
            document.getElementById('importPreview').innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Memproses fail ${file.name}...</p>
                    <p class="text-sm text-gray-500 mt-2">Sistem sedang membaca dan mengesahkan data...</p>
                </div>
            `;

            // Process file based on type
            if (fileExtension === 'csv' || fileExtension === 'txt') {
                processCSVFile(file);
            } else {
                // For Excel files, we'll simulate processing since we can't use external libraries
                setTimeout(() => {
                    simulateExcelProcessing(file);
                }, 1500);
            }
        }

        function processCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showImportError('Fail CSV kosong atau tidak mempunyai data yang mencukupi.');
                    return;
                }

                // Parse CSV data
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= 4) { // Minimum required fields
                        data.push({
                            nama: values[0] || '',
                            noKP: values[1] || '',
                            kursus: values[2] || '',
                            sesi: values[3] || '',
                            telefon: values[4] || '',
                            alamat: values[5] || '',
                            status: 'Tidak Hadir'
                        });
                    }
                }

                displayImportPreview(data, file.name);
            };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function simulateExcelProcessing(file) {
            // Simulate Excel file processing with sample data
            const sampleData = [
                {
                    nama: 'Ahmad bin Hassan',
                    noKP: '901234567894',
                    kursus: 'PENDAWAI ELEKTRIK (PW4)',
                    sesi: 'Sesi Pagi Elektrik 2024',
                    telefon: '0123456785',
                    alamat: 'Kota Bharu, Kelantan',
                    status: 'Tidak Hadir'
                },
                {
                    nama: 'Fatimah binti Omar',
                    noKP: '901234567895',
                    kursus: 'TEKNOLOGI SISTEM KOMPUTER',
                    sesi: 'Sesi Petang Komputer 2024',
                    telefon: '0123456784',
                    alamat: 'Machang, Kelantan',
                    status: 'Tidak Hadir'
                },
                {
                    nama: 'Muhammad Rizal',
                    noKP: '901234567896',
                    kursus: 'TEKNOLOGI AUTOMOTIF (TAHAP 2)',
                    sesi: 'Sesi Pagi Mekanikal 2024',
                    telefon: '0123456783',
                    alamat: 'Tanah Merah, Kelantan',
                    status: 'Tidak Hadir'
                }
            ];

            displayImportPreview(sampleData, file.name);
        }

        function displayImportPreview(data, fileName) {
            if (data.length === 0) {
                showImportError('Tiada data yang sah dijumpai dalam fail.');
                return;
            }

            const validData = data.filter(item => item.nama && item.noKP && item.kursus && item.sesi);
            const invalidCount = data.length - validData.length;

            document.getElementById('importPreview').innerHTML = `
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h5 class="font-semibold text-gray-800">Pratonton Import: ${fileName}</h5>
                        <div class="text-sm">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded mr-2">
                                ${validData.length} rekod sah
                            </span>
                            ${invalidCount > 0 ? `<span class="bg-red-100 text-red-800 px-2 py-1 rounded">${invalidCount} rekod tidak sah</span>` : ''}
                        </div>
                    </div>
                    
                    <!-- Session Assignment Section -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center space-x-2 mb-3">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h6 class="font-semibold text-blue-800">Pilih Sesi untuk Pelatih yang Diimport</h6>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-blue-700 mb-2">Sesi Kursus:</label>
                                <select id="importSesiSelect" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white" required>
                                    <option value="">Pilih Sesi untuk Semua Pelatih</option>
                                    ${getAvailableSessionsForImport()}
                                </select>
                                <p class="text-xs text-blue-600 mt-1">Semua pelatih akan ditetapkan ke sesi yang dipilih</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-blue-700 mb-2">Maklumat Sesi:</label>
                                <div id="importSesiInfo" class="bg-white border border-blue-200 rounded p-3 text-sm">
                                    <p class="text-gray-500">Pilih sesi untuk melihat maklumat</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button onclick="showCreateNewSessionForImport()" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition">
                                + Cipta Sesi Baru
                            </button>
                            <button onclick="refreshSessionList()" class="px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 transition">
                                üîÑ Refresh Senarai
                            </button>
                        </div>
                    </div>
                    
                    ${invalidCount > 0 ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                            <p class="text-yellow-800 text-sm">
                                <strong>Amaran:</strong> ${invalidCount} rekod tidak akan diimport kerana maklumat tidak lengkap (nama, no KP, atau kursus kosong).
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="overflow-x-auto max-h-64 border rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left border-b">Bil</th>
                                    <th class="px-3 py-2 text-left border-b">Nama</th>
                                    <th class="px-3 py-2 text-left border-b">No. KP</th>
                                    <th class="px-3 py-2 text-left border-b">Kursus</th>
                                    <th class="px-3 py-2 text-left border-b">Sesi</th>
                                    <th class="px-3 py-2 text-left border-b">Telefon</th>
                                    <th class="px-3 py-2 text-center border-b">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${validData.slice(0, 10).map((item, index) => `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="px-3 py-2 border-b">${index + 1}</td>
                                        <td class="px-3 py-2 border-b font-medium">${item.nama}</td>
                                        <td class="px-3 py-2 border-b">${item.noKP}</td>
                                        <td class="px-3 py-2 border-b">${item.kursus}</td>
                                        <td class="px-3 py-2 border-b">${item.sesi || 'Tiada'}</td>
                                        <td class="px-3 py-2 border-b">${item.telefon}</td>
                                        <td class="px-3 py-2 border-b text-center">
                                            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">Baru</span>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${validData.length > 10 ? `
                                    <tr>
                                        <td colspan="7" class="px-3 py-2 text-center text-gray-500 border-b">
                                            ... dan ${validData.length - 10} rekod lagi
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex space-x-3">
                        <button onclick="confirmImport()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition font-medium">
                            Import ${validData.length} Pelatih
                        </button>
                        <button onclick="closeImportPelatih()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition">
                            Batal
                        </button>
                    </div>
                </div>
            `;

            // Store valid data for import
            window.pendingImportData = validData;
            
            // Add event listener for session selection
            setTimeout(() => {
                const sesiSelect = document.getElementById('importSesiSelect');
                if (sesiSelect) {
                    sesiSelect.onchange = function() {
                        updateImportSesiInfo(this.value);
                    };
                }
            }, 100);
        }
        
        // Helper function to get available sessions for import
        function getAvailableSessionsForImport() {
            const availableSesi = sesiData.filter(s => 
                (s.status === 'Aktif' || s.status === 'Akan Datang')
            );
            
            if (availableSesi.length === 0) {
                return '<option value="">Tiada sesi tersedia - Sila cipta sesi baru</option>';
            }
            
            return availableSesi.map(sesi => {
                const statusIcon = sesi.status === 'Aktif' ? 'üü¢' : 'üîµ';
                const available = sesi.kapasiti - sesi.pelatihTerdaftar;
                return `<option value="${sesi.id}">${statusIcon} ${sesi.namaSesi} (${available} tempat tersisa)</option>`;
            }).join('');
        }
        
        // Update session info display
        function updateImportSesiInfo(sesiId) {
            const infoDiv = document.getElementById('importSesiInfo');
            
            if (!sesiId) {
                infoDiv.innerHTML = '<p class="text-gray-500">Pilih sesi untuk melihat maklumat</p>';
                return;
            }
            
            const sesi = sesiData.find(s => s.id == sesiId);
            if (!sesi) {
                infoDiv.innerHTML = '<p class="text-red-500">Sesi tidak dijumpai</p>';
                return;
            }
            
            const available = sesi.kapasiti - sesi.pelatihTerdaftar;
            const pendingCount = window.pendingImportData ? window.pendingImportData.length : 0;
            
            infoDiv.innerHTML = `
                <div class="space-y-1">
                    <p><strong>Kursus:</strong> ${sesi.namaKursus}</p>
                    <p><strong>Kod:</strong> ${sesi.kodKursus}</p>
                    <p><strong>Tempoh:</strong> ${sesi.tempoh} bulan</p>
                    <p><strong>Masa:</strong> ${sesi.masaMula} - ${sesi.masaTamat}</p>
                    <p><strong>Kapasiti:</strong> ${sesi.pelatihTerdaftar}/${sesi.kapasiti} (${available} tempat tersisa)</p>
                    <p><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${sesi.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${sesi.status}</span></p>
                    ${pendingCount > available ? `
                        <p class="text-red-600 font-semibold">‚ö†Ô∏è Amaran: ${pendingCount} pelatih akan diimport tetapi hanya ${available} tempat tersisa!</p>
                    ` : `
                        <p class="text-green-600">‚úÖ Mencukupi: ${available} tempat untuk ${pendingCount} pelatih</p>
                    `}
                </div>
            `;
        }
        
        // Refresh session list
        function refreshSessionList() {
            const sesiSelect = document.getElementById('importSesiSelect');
            if (sesiSelect) {
                const currentValue = sesiSelect.value;
                sesiSelect.innerHTML = '<option value="">Pilih Sesi untuk Semua Pelatih</option>' + getAvailableSessionsForImport();
                sesiSelect.value = currentValue;
                updateImportSesiInfo(currentValue);
                showNotification('Senarai sesi telah dikemas kini!');
            }
        }
        
        // Show create new session modal for import
        function showCreateNewSessionForImport() {
            // Store that we're creating session for import
            window.creatingSessionForImport = true;
            showPendaftaranSesi();
            showNotification('Cipta sesi baru. Selepas selesai, sesi akan tersedia untuk import pelatih.');
        }

        function showImportError(message) {
            document.getElementById('importPreview').innerHTML = `
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h4 class="text-lg font-semibold text-red-800 mb-2">Ralat Import</h4>
                    <p class="text-red-600 mb-4">${message}</p>
                    <button onclick="closeImportPelatih()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                        Tutup
                    </button>
                </div>
            `;
        }

        function confirmImport() {
            if (!window.pendingImportData || window.pendingImportData.length === 0) {
                alert('Tiada data untuk diimport.');
                return;
            }
            
            // Check if session is selected
            const selectedSesiId = document.getElementById('importSesiSelect').value;
            if (!selectedSesiId) {
                alert('Sila pilih sesi kursus untuk pelatih yang akan diimport.');
                return;
            }
            
            // Find selected session
            const selectedSesi = sesiData.find(s => s.id == selectedSesiId);
            if (!selectedSesi) {
                alert('Sesi yang dipilih tidak sah. Sila pilih sesi lain.');
                return;
            }
            
            // Check capacity
            const importData = window.pendingImportData;
            const available = selectedSesi.kapasiti - selectedSesi.pelatihTerdaftar;
            
            if (importData.length > available) {
                if (!confirm(`Sesi "${selectedSesi.namaSesi}" hanya mempunyai ${available} tempat tersisa, tetapi anda cuba import ${importData.length} pelatih. Adakah anda ingin meneruskan? (Sesi akan melebihi kapasiti)`)) {
                    return;
                }
            }

            let successCount = 0;
            let duplicateCount = 0;

            // Process each record
            importData.forEach(newPelatih => {
                // Check for duplicates based on No. KP
                const existingPelatih = pelatihData.find(p => p.noKP === newPelatih.noKP);
                
                if (!existingPelatih) {
                    // Find session by name from the imported data
                    let targetSesi = selectedSesi;
                    
                    // If session name is provided in the data, try to find matching session
                    if (newPelatih.sesi) {
                        const matchingSesi = sesiData.find(s => s.namaSesi.toLowerCase() === newPelatih.sesi.toLowerCase());
                        if (matchingSesi) {
                            targetSesi = matchingSesi;
                        }
                    }
                    
                    // Add new pelatih with session information
                    const pelatihRecord = {
                        id: pelatihData.length + successCount + 1,
                        nama: newPelatih.nama,
                        noKP: newPelatih.noKP,
                        sesiId: targetSesi.id,
                        sesiNama: targetSesi.namaSesi,
                        kodKursus: targetSesi.kodKursus,
                        kursus: newPelatih.kursus || targetSesi.namaKursus,
                        telefon: newPelatih.telefon || 'Tiada',
                        alamat: newPelatih.alamat || 'Tiada',
                        status: 'Tidak Hadir'
                    };
                    
                    pelatihData.push(pelatihRecord);
                    
                    // Update session's registered trainee count
                    targetSesi.pelatihTerdaftar++;
                    
                    successCount++;
                } else {
                    duplicateCount++;
                }
            });
            
            // Session counts are already updated in the loop above
            
            // Auto-save to localStorage
            autoSavePelatihData();
            autoSaveSesiData();

            // Show import results
            document.getElementById('importResults').classList.remove('hidden');
            document.getElementById('importResults').innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center mb-3">
                        <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h4 class="font-semibold text-green-800">Import Selesai!</h4>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-4">
                        <p class="text-blue-800 font-semibold">üìö Sesi Dipilih: ${selectedSesi.namaSesi}</p>
                        <p class="text-blue-700 text-sm">Kursus: ${selectedSesi.namaKursus} (${selectedSesi.kodKursus})</p>
                        <p class="text-blue-700 text-sm">Kapasiti Terkini: ${selectedSesi.pelatihTerdaftar}/${selectedSesi.kapasiti} pelatih</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-white p-3 rounded border">
                            <p class="font-semibold text-green-600 text-lg">${successCount}</p>
                            <p class="text-gray-600">Pelatih berjaya diimport</p>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <p class="font-semibold text-orange-600 text-lg">${duplicateCount}</p>
                            <p class="text-gray-600">Rekod pendua (diabaikan)</p>
                        </div>
                    </div>
                    
                    ${duplicateCount > 0 ? `
                        <div class="mt-3 p-2 bg-orange-50 border border-orange-200 rounded">
                            <p class="text-orange-800 text-xs">
                                <strong>Nota:</strong> Rekod dengan No. KP yang sama tidak diimport untuk mengelakkan pendua.
                            </p>
                        </div>
                    ` : ''}
                    
                    ${successCount > 0 ? `
                        <div class="mt-3 p-2 bg-green-50 border border-green-200 rounded">
                            <p class="text-green-800 text-xs">
                                <strong>‚úÖ Berjaya:</strong> ${successCount} pelatih telah ditambah ke sesi "${selectedSesi.namaSesi}" dan siap untuk kehadiran.
                            </p>
                        </div>
                    ` : ''}
                    
                    <button onclick="finishImport()" class="w-full mt-4 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                        Selesai
                    </button>
                </div>
            `;

            // Update statistics
            updatePusatStats();
            
            // Clear pending data
            window.pendingImportData = null;
            
            // Hide preview
            document.getElementById('importPreview').innerHTML = '';
        }

        function finishImport() {
            closeImportPelatih();
            showNotification('Import pelatih selesai! Data telah dikemas kini.');
        }

        function downloadTemplate() {
            // Show loading notification
            showNotification('Menyediakan template CSV untuk dimuat turun...');
            
            // Create CSV template with proper course names and session column
            const template = `Nama Penuh,No. KP,Kursus,Sesi,No. Telefon,Alamat
Ahmad bin Ali,901234567890,PENDAWAI ELEKTRIK (PW4),Sesi Pagi Elektrik 2024,0123456789,"Jalan Merdeka, Kota Bharu"
Siti Aminah,901234567891,TEKNOLOGI SISTEM KOMPUTER,Sesi Petang Komputer 2024,0123456788,"Jalan Raya, Machang"
Muhammad Faiz,901234567892,TEKNOLOGI AUTOMOTIF (TAHAP 2),Sesi Pagi Mekanikal 2024,0123456787,"Jalan Utama, Tanah Merah"
Fatimah binti Omar,901234567893,KIMPALAN STRUKTUR KELULI,Sesi Pagi Kimpalan 2024,0123456786,"Jalan Pasar, Pasir Mas"
Nurul Aina,901234567894,TERAPI KECANTIKAN DAN SOLEKAN,Sesi Petang Kecantikan 2024,0123456785,"Jalan Sekolah, Bachok"`;

            // Generate filename with current date
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(today.getDate()).padStart(2, '0');
            
            const filename = `Template_Import_Pelatih_GIATMARA_${dateStr}.csv`;
            
            // Method 1: Try modern download approach
            try {
                const blob = new Blob(['\ufeff' + template], { 
                    type: 'text/csv;charset=utf-8' 
                });
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
                
                showNotification(`‚úÖ Template "${filename}" berjaya dimuat turun! Buka dengan Excel dan isi maklumat pelatih.`);
                return;
                
            } catch (error) {
                console.log('Method 1 failed, trying method 2...');
            }
            
            // Method 2: Try data URL approach
            try {
                const dataUrl = 'data:text/csv;charset=utf-8,' + encodeURIComponent('\ufeff' + template);
                const link = document.createElement('a');
                
                link.href = dataUrl;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`‚úÖ Template "${filename}" berjaya dimuat turun menggunakan kaedah alternatif!`);
                return;
                
            } catch (error) {
                console.log('Method 2 failed, trying method 3...');
            }
            
            // Method 3: Try opening in new window
            try {
                const blob = new Blob([template], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const newWindow = window.open(url, '_blank');
                
                if (newWindow) {
                    showNotification('üìÑ Template telah dibuka dalam tab baru. Klik kanan dan pilih "Save As" untuk simpan.');
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 5000);
                    return;
                }
            } catch (error) {
                console.log('Method 3 failed, using fallback...');
            }
            
            // Method 4: Fallback - show template in alert for manual copy
            const alertMessage = `üìã TEMPLATE IMPORT PELATIH GIATMARA

Sila salin template di bawah dan simpan sebagai fail .csv:

${template}

CARA SIMPAN:
1. Salin semua teks di atas
2. Buka Notepad atau text editor
3. Tampal (Paste) teks tersebut
4. Simpan sebagai "template.csv"
5. Buka dengan Excel untuk edit
6. Import semula ke dalam sistem

Klik OK untuk tutup mesej ini.`;
            
            alert(alertMessage);
            
            // Also try to copy to clipboard if possible
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(template).then(() => {
                        showNotification('üìã Template telah disalin ke clipboard! Tampal ke dalam text editor dan simpan sebagai .csv');
                    }).catch(() => {
                        showNotification('‚ö†Ô∏è Sila salin template secara manual dari alert yang dipaparkan.');
                    });
                } else {
                    showNotification('‚ö†Ô∏è Sila salin template secara manual dari alert yang dipaparkan.');
                }
            } catch (error) {
                showNotification('‚ö†Ô∏è Sila salin template secara manual dari alert yang dipaparkan.');
            }
        }

        function showKehadiran() {
            document.getElementById('kehadiranModal').classList.remove('hidden');
            // Set default date to today
            const today = new Date();
            const todayString = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
            document.getElementById('searchTarikh').value = todayString;
            updateKehadiranList();
        }

        function closeKehadiran() {
            document.getElementById('kehadiranModal').classList.add('hidden');
        }

        function updateKehadiranList() {
            const kehadiranList = document.getElementById('kehadiranList');
            kehadiranList.innerHTML = '';
            
            pelatihData.forEach(pelatih => {
                const statusColor = pelatih.status === 'Hadir' ? 'bg-green-100 text-green-800' : 
                                  pelatih.status === 'Lewat' ? 'bg-yellow-100 text-yellow-800' : 
                                  'bg-red-100 text-red-800';
                
                const pelatihElement = document.createElement('div');
                pelatihElement.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-lg';
                pelatihElement.innerHTML = `
                    <div>
                        <p class="font-medium">${pelatih.nama}</p>
                        <p class="text-sm text-gray-600">${pelatih.kursus} | ${pelatih.sesiNama || 'Tiada Sesi'} | ${pelatih.noKP}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="px-3 py-1 rounded-full text-sm ${statusColor}">${pelatih.status}</span>
                        <div class="flex space-x-1">
                            <button onclick="updateStatus(${pelatih.id}, 'Hadir')" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                Hadir
                            </button>
                            <button onclick="updateStatus(${pelatih.id}, 'Lewat')" class="px-3 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700 transition">
                                Lewat
                            </button>
                            <button onclick="updateStatus(${pelatih.id}, 'Tidak Hadir')" class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                                Tidak Hadir
                            </button>
                        </div>
                    </div>
                `;
                kehadiranList.appendChild(pelatihElement);
            });
        }

        function updateStatus(pelatihId, newStatus) {
            const pelatih = pelatihData.find(p => p.id === pelatihId);
            if (pelatih) {
                pelatih.status = newStatus;
                updateKehadiranList();
                updatePusatStats();
                
                // Auto-save to localStorage
                autoSavePelatihData();
                
                // Add to recent activity
                const activity = `${pelatih.nama} - ${newStatus} pada ${new Date().toLocaleTimeString('ms-MY', {hour: '2-digit', minute: '2-digit'})}`;
                addRecentActivity(activity, newStatus);
                
                // Show success message
                showNotification(`Status ${pelatih.nama} dikemas kini kepada: ${newStatus}`);
            }
        }

        function addRecentActivity(activity, status) {
            const recentActivity = document.getElementById('recentActivity');
            const statusColor = status === 'Hadir' ? 'bg-green-500' : 
                              status === 'Lewat' ? 'bg-yellow-500' : 'bg-red-500';
            
            const activityElement = document.createElement('div');
            activityElement.className = 'flex items-center p-3 bg-gray-50 rounded-lg';
            activityElement.innerHTML = `
                <div class="w-2 h-2 ${statusColor} rounded-full mr-3"></div>
                <span class="text-sm text-gray-600">${activity}</span>
            `;
            
            // Add to top and limit to 5 activities
            recentActivity.insertBefore(activityElement, recentActivity.firstChild);
            if (recentActivity.children.length > 5) {
                recentActivity.removeChild(recentActivity.lastChild);
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Admin functions
        function showPusatManagement() {
            document.getElementById('pusatManagementModal').classList.remove('hidden');
            updatePusatList(); // Update the list when modal opens
        }

        function showKursusManagement() {
            document.getElementById('kursusManagementModal').classList.remove('hidden');
            updateKursusList(); // Update the list when modal opens
        }

        function showSesiManagement() {
            document.getElementById('sesiManagementModal').classList.remove('hidden');
        }

        function closePusatManagement() {
            document.getElementById('pusatManagementModal').classList.add('hidden');
            resetPusatForm();
        }

        function closeKursusManagement() {
            document.getElementById('kursusManagementModal').classList.add('hidden');
        }

        function closeSesiManagement() {
            document.getElementById('sesiManagementModal').classList.add('hidden');
        }

        function showPelatihManagement() {
            document.getElementById('pelatihManagementModal').classList.remove('hidden');
            initializePelatihManagement();
        }

        function closePelatihManagement() {
            document.getElementById('pelatihManagementModal').classList.add('hidden');
        }

        function initializePelatihManagement() {
            // Populate filter dropdowns
            populatePelatihFilters();
            // Load all trainee data
            loadAllPelatihData();
            // Update statistics
            updatePelatihStatistics();
        }

        function populatePelatihFilters() {
            // Populate center filter
            const pusatFilter = document.getElementById('filterPusatPelatih');
            pusatFilter.innerHTML = '<option value="">Semua Pusat</option>';
            pusatData.forEach(pusat => {
                const option = document.createElement('option');
                option.value = pusat.nama;
                option.textContent = pusat.nama;
                pusatFilter.appendChild(option);
            });

            // Populate course filter
            const kursusFilter = document.getElementById('filterKursusPelatih');
            kursusFilter.innerHTML = '<option value="">Semua Kursus</option>';
            const uniqueCourses = [...new Set(kursusData.map(k => k.nama))].sort();
            uniqueCourses.forEach(kursus => {
                const option = document.createElement('option');
                option.value = kursus;
                option.textContent = kursus;
                kursusFilter.appendChild(option);
            });

            // Populate session filter
            const sesiFilter = document.getElementById('filterSesiPelatih');
            sesiFilter.innerHTML = '<option value="">Semua Sesi</option>';
            sesiData.forEach(sesi => {
                const option = document.createElement('option');
                option.value = sesi.namaSesi;
                option.textContent = sesi.namaSesi;
                sesiFilter.appendChild(option);
            });
        }

        function loadAllPelatihData() {
            // Create comprehensive trainee data from all centers
            const allPelatihData = [];
            
            // Add existing pelatih data with center information
            pelatihData.forEach(pelatih => {
                allPelatihData.push({
                    ...pelatih,
                    pusat: currentUser || 'GIATMARA Kota Bharu',
                    tahun: '2024'
                });
            });

            // Add sample data from other centers for demonstration
            const samplePelatihData = [
                {
                    id: 1001,
                    nama: 'Ahmad Farid bin Hassan',
                    noKP: '901234567801',
                    pusat: 'GIATMARA Machang',
                    kursus: 'TEKNOLOGI AUTOMOTIF (TAHAP 2)',
                    sesiNama: 'Sesi Pagi Automotif 2024',
                    telefon: '0123456701',
                    status: 'Hadir',
                    tahun: '2024',
                    kehadiran: 92
                },
                {
                    id: 1002,
                    nama: 'Siti Nurhaliza binti Omar',
                    noKP: '901234567802',
                    pusat: 'GIATMARA Machang',
                    kursus: 'TERAPI KECANTIKAN DAN SOLEKAN',
                    sesiNama: 'Sesi Petang Kecantikan 2024',
                    telefon: '0123456702',
                    status: 'Hadir',
                    tahun: '2024',
                    kehadiran: 95
                },
                {
                    id: 1003,
                    nama: 'Muhammad Rizal bin Abdullah',
                    noKP: '901234567803',
                    pusat: 'GIATMARA Tanah Merah',
                    kursus: 'KIMPALAN STRUKTUR KELULI',
                    sesiNama: 'Sesi Pagi Kimpalan 2024',
                    telefon: '0123456703',
                    status: 'Lewat',
                    tahun: '2024',
                    kehadiran: 88
                },
                {
                    id: 1004,
                    nama: 'Fatimah Zahra binti Ismail',
                    noKP: '901234567804',
                    pusat: 'GIATMARA Gua Musang',
                    kursus: 'JAHITAN PAKAIAN DAN FESYEN',
                    sesiNama: 'Sesi Pagi Jahitan 2024',
                    telefon: '0123456704',
                    status: 'Hadir',
                    tahun: '2024',
                    kehadiran: 90
                },
                {
                    id: 1005,
                    nama: 'Mohd Hafiz bin Rahman',
                    noKP: '901234567805',
                    pusat: 'GIATMARA Kuala Krai',
                    kursus: 'TEKNOLOGI SISTEM KOMPUTER',
                    sesiNama: 'Sesi Petang Komputer 2024',
                    telefon: '0123456705',
                    status: 'Hadir',
                    tahun: '2024',
                    kehadiran: 97
                },
                {
                    id: 1006,
                    nama: 'Nurul Ain binti Zakaria',
                    noKP: '901234567806',
                    pusat: 'GIATMARA Kota Bharu',
                    kursus: 'MASAKAN DAN PRAMUSAJI',
                    sesiNama: 'Sesi Pagi Masakan 2024',
                    telefon: '0123456706',
                    status: 'Tidak Hadir',
                    tahun: '2024',
                    kehadiran: 75
                },
                {
                    id: 1007,
                    nama: 'Azman bin Yusof',
                    noKP: '901234567807',
                    pusat: 'GIATMARA Machang',
                    kursus: 'PENDAWAI ELEKTRIK (PW4)',
                    sesiNama: 'Sesi Pagi Elektrik 2024',
                    telefon: '0123456707',
                    status: 'Hadir',
                    tahun: '2024',
                    kehadiran: 93
                },
                {
                    id: 1008,
                    nama: 'Zainab binti Ahmad',
                    noKP: '901234567808',
                    pusat: 'GIATMARA Tanah Merah',
                    kursus: 'KONFEKSIONERI & BAKERI',
                    sesiNama: 'Sesi Petang Bakeri 2024',
                    telefon: '0123456708',
                    status: 'Lewat',
                    tahun: '2024',
                    kehadiran: 85
                }
            ];

            // Combine all data
            allPelatihData.push(...samplePelatihData);

            // Store in global variable for filtering
            window.allPelatihData = allPelatihData;
            
            // Display all data initially
            displayPelatihData(allPelatihData);
        }

        function displayPelatihData(data) {
            const tableBody = document.getElementById('pelatihTableBody');
            const noDataMessage = document.getElementById('noPelatihMessage');
            
            if (data.length === 0) {
                tableBody.innerHTML = '';
                noDataMessage.classList.remove('hidden');
                document.getElementById('showingCount').textContent = '0';
                return;
            }

            noDataMessage.classList.add('hidden');
            tableBody.innerHTML = '';

            data.forEach((pelatih, index) => {
                const kehadiran = pelatih.kehadiran || Math.floor(Math.random() * 20) + 80;
                const statusColor = pelatih.status === 'Hadir' ? 'bg-green-100 text-green-800' :
                                  pelatih.status === 'Lewat' ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-red-100 text-red-800';
                
                const kehadiranColor = kehadiran >= 90 ? 'text-green-600' :
                                     kehadiran >= 80 ? 'text-blue-600' :
                                     kehadiran >= 70 ? 'text-orange-600' : 'text-red-600';

                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="px-4 py-3 border-b">${index + 1}</td>
                    <td class="px-4 py-3 border-b font-medium">${pelatih.nama}</td>
                    <td class="px-4 py-3 border-b">${pelatih.noKP}</td>
                    <td class="px-4 py-3 border-b">${pelatih.pusat}</td>
                    <td class="px-4 py-3 border-b">${pelatih.kursus}</td>
                    <td class="px-4 py-3 border-b">${pelatih.sesiNama || 'Tiada Sesi'}</td>
                    <td class="px-4 py-3 border-b">${pelatih.tahun}</td>
                    <td class="px-4 py-3 border-b">${pelatih.telefon}</td>
                    <td class="px-4 py-3 border-b text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${statusColor}">${pelatih.status}</span>
                    </td>
                    <td class="px-4 py-3 border-b text-center font-semibold ${kehadiranColor}">${kehadiran}%</td>
                    <td class="px-4 py-3 border-b text-center">
                        <div class="flex space-x-1 justify-center">
                            <button onclick="viewPelatihDetail(${pelatih.id})" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition" title="Lihat Detail">
                                üëÅÔ∏è
                            </button>
                            <button onclick="editPelatihAdmin(${pelatih.id})" class="px-2 py-1 bg-orange-600 text-white text-xs rounded hover:bg-orange-700 transition" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="transferPelatih(${pelatih.id})" class="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition" title="Pindah">
                                üîÑ
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Update count display
            document.getElementById('showingCount').textContent = data.length;
            document.getElementById('totalCount').textContent = window.allPelatihData ? window.allPelatihData.length : 0;
        }

        function filterPelatihData() {
            if (!window.allPelatihData) return;

            const pusatFilter = document.getElementById('filterPusatPelatih').value;
            const kursusFilter = document.getElementById('filterKursusPelatih').value;
            const sesiFilter = document.getElementById('filterSesiPelatih').value;
            const tahunFilter = document.getElementById('filterTahunPelatih').value;
            const nameSearch = document.getElementById('searchPelatihName').value.toLowerCase();

            let filteredData = window.allPelatihData.filter(pelatih => {
                const matchesPusat = !pusatFilter || pelatih.pusat === pusatFilter;
                const matchesKursus = !kursusFilter || pelatih.kursus === kursusFilter;
                const matchesSesi = !sesiFilter || pelatih.sesiNama === sesiFilter;
                const matchesTahun = !tahunFilter || pelatih.tahun === tahunFilter;
                const matchesName = !nameSearch || 
                                  pelatih.nama.toLowerCase().includes(nameSearch) ||
                                  pelatih.noKP.includes(nameSearch);

                return matchesPusat && matchesKursus && matchesSesi && matchesTahun && matchesName;
            });

            displayPelatihData(filteredData);
            updateFilteredStatistics(filteredData);
        }

        function updatePelatihStatistics() {
            if (!window.allPelatihData) return;

            const totalPelatih = window.allPelatihData.length;
            const pelatihAktif = window.allPelatihData.filter(p => p.status === 'Hadir' || p.status === 'Lewat').length;
            const uniquePusat = [...new Set(window.allPelatihData.map(p => p.pusat))].length;
            const uniqueKursus = [...new Set(window.allPelatihData.map(p => p.kursus))].length;
            const uniqueSesi = [...new Set(window.allPelatihData.map(p => p.sesiNama))].length;

            document.getElementById('totalPelatihKeseluruhan').textContent = totalPelatih;
            document.getElementById('pelatihAktif').textContent = pelatihAktif;
            document.getElementById('jumlahPusat').textContent = uniquePusat;
            document.getElementById('jumlahKursus').textContent = uniqueKursus;
            document.getElementById('jumlahSesi').textContent = uniqueSesi;
        }

        function updateFilteredStatistics(filteredData) {
            const totalPelatih = filteredData.length;
            const pelatihAktif = filteredData.filter(p => p.status === 'Hadir' || p.status === 'Lewat').length;
            const uniquePusat = [...new Set(filteredData.map(p => p.pusat))].length;
            const uniqueKursus = [...new Set(filteredData.map(p => p.kursus))].length;
            const uniqueSesi = [...new Set(filteredData.map(p => p.sesiNama))].length;

            document.getElementById('totalPelatihKeseluruhan').textContent = totalPelatih;
            document.getElementById('pelatihAktif').textContent = pelatihAktif;
            document.getElementById('jumlahPusat').textContent = uniquePusat;
            document.getElementById('jumlahKursus').textContent = uniqueKursus;
            document.getElementById('jumlahSesi').textContent = uniqueSesi;
        }

        function resetPelatihFilter() {
            document.getElementById('filterPusatPelatih').value = '';
            document.getElementById('filterKursusPelatih').value = '';
            document.getElementById('filterSesiPelatih').value = '';
            document.getElementById('filterTahunPelatih').value = '';
            document.getElementById('searchPelatihName').value = '';
            
            if (window.allPelatihData) {
                displayPelatihData(window.allPelatihData);
                updatePelatihStatistics();
            }
            
            showNotification('Penapis telah direset. Menunjukkan semua pelatih.');
        }

        function exportPelatihData() {
            if (!window.allPelatihData || window.allPelatihData.length === 0) {
                alert('Tiada data pelatih untuk diexport.');
                return;
            }

            // Get current filtered data
            const tableBody = document.getElementById('pelatihTableBody');
            const currentData = [];
            
            // Extract data from current table display
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    currentData.push({
                        bil: cells[0].textContent,
                        nama: cells[1].textContent,
                        noKP: cells[2].textContent,
                        pusat: cells[3].textContent,
                        kursus: cells[4].textContent,
                        sesi: cells[5].textContent,
                        tahun: cells[6].textContent,
                        telefon: cells[7].textContent,
                        status: cells[8].textContent.trim(),
                        kehadiran: cells[9].textContent.trim()
                    });
                }
            });

            if (currentData.length === 0) {
                alert('Tiada data untuk diexport berdasarkan penapis semasa.');
                return;
            }

            showNotification('Menyediakan fail Excel...');

            try {
                // Create CSV content
                let csvContent = '';
                
                // Add header information
                csvContent += 'GIATMARA KELANTAN\n';
                csvContent += 'Senarai Pelatih Keseluruhan\n';
                csvContent += `Tarikh Export: ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}\n`;
                csvContent += `Jumlah Rekod: ${currentData.length} pelatih\n\n`;
                
                // Add table headers
                csvContent += 'Bil,Nama Pelatih,No. KP,Pusat,Kursus,Sesi,Tahun,No. Telefon,Status,Kehadiran (%)\n';
                
                // Add data rows
                currentData.forEach(row => {
                    const nama = row.nama.includes(',') ? `"${row.nama}"` : row.nama;
                    const pusat = row.pusat.includes(',') ? `"${row.pusat}"` : row.pusat;
                    const kursus = row.kursus.includes(',') ? `"${row.kursus}"` : row.kursus;
                    const sesi = row.sesi.includes(',') ? `"${row.sesi}"` : row.sesi;
                    
                    csvContent += `${row.bil},${nama},${row.noKP},${pusat},${kursus},${sesi},${row.tahun},${row.telefon},${row.status},${row.kehadiran}\n`;
                });
                
                // Add summary
                csvContent += '\n\nRingkasan:\n';
                csvContent += `Jumlah Pelatih,${currentData.length}\n`;
                csvContent += `Pelatih Hadir,${currentData.filter(p => p.status === 'Hadir').length}\n`;
                csvContent += `Pelatih Lewat,${currentData.filter(p => p.status === 'Lewat').length}\n`;
                csvContent += `Pelatih Tidak Hadir,${currentData.filter(p => p.status === 'Tidak Hadir').length}\n`;
                
                // Create blob and download
                const blob = new Blob(['\ufeff' + csvContent], {
                    type: 'application/vnd.ms-excel;charset=utf-8'
                });
                
                const today = new Date();
                const dateStr = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
                const timeStr = String(today.getHours()).padStart(2, '0') + '' + 
                               String(today.getMinutes()).padStart(2, '0');
                
                const filename = `Senarai_Pelatih_GIATMARA_${dateStr}_${timeStr}.csv`;
                
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showNotification(`Fail Excel "${filename}" berjaya dimuat turun! (${currentData.length} rekod)`);
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Ralat semasa export data. Sila cuba sekali lagi.');
            }
        }

        function viewPelatihDetail(pelatihId) {
            const pelatih = window.allPelatihData.find(p => p.id === pelatihId);
            if (!pelatih) return;

            const kehadiran = pelatih.kehadiran || Math.floor(Math.random() * 20) + 80;
            
            const detailWindow = window.open('', '_blank', 'width=600,height=700');
            detailWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Detail Pelatih - ${pelatih.nama}</title>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
                        .info-item { margin-bottom: 15px; }
                        .label { font-weight: bold; color: #333; }
                        .value { color: #666; }
                        .status { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
                        .status.hadir { background-color: #d1fae5; color: #065f46; }
                        .status.lewat { background-color: #fef3c7; color: #92400e; }
                        .status.tidak-hadir { background-color: #fee2e2; color: #991b1b; }
                        .print-btn { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 20px 0; }
                        .print-btn:hover { background: #2563eb; }
                        @media print { .print-btn { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üè¢ GIATMARA KELANTAN</h1>
                        <h2>Maklumat Detail Pelatih</h2>
                        <p><strong>Sistem Kehadiran Pelatih</strong></p>
                    </div>
                    
                    <div class="info-grid">
                        <div>
                            <div class="info-item">
                                <span class="label">Nama Penuh:</span><br>
                                <span class="value">${pelatih.nama}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">No. Kad Pengenalan:</span><br>
                                <span class="value">${pelatih.noKP}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">No. Telefon:</span><br>
                                <span class="value">${pelatih.telefon}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Pusat GIATMARA:</span><br>
                                <span class="value">${pelatih.pusat}</span>
                            </div>
                        </div>
                        <div>
                            <div class="info-item">
                                <span class="label">Kursus:</span><br>
                                <span class="value">${pelatih.kursus}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Sesi:</span><br>
                                <span class="value">${pelatih.sesiNama || 'Tiada Sesi'}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Tahun:</span><br>
                                <span class="value">${pelatih.tahun}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Status Kehadiran:</span><br>
                                <span class="status ${pelatih.status.toLowerCase().replace(' ', '-')}">${pelatih.status}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <span class="label">Peratusan Kehadiran:</span><br>
                        <span class="value" style="font-size: 24px; font-weight: bold; color: ${kehadiran >= 90 ? '#059669' : kehadiran >= 80 ? '#2563eb' : '#dc2626'};">${kehadiran}%</span>
                    </div>
                    
                    <div class="info-item">
                        <span class="label">Prestasi:</span><br>
                        <span class="value">${kehadiran >= 95 ? 'Cemerlang (A+)' : kehadiran >= 90 ? 'Cemerlang (A)' : kehadiran >= 85 ? 'Baik (B+)' : kehadiran >= 80 ? 'Baik (B)' : kehadiran >= 75 ? 'Sederhana (C+)' : 'Perlu Perhatian (C)'}</span>
                    </div>
                    
                    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Cetak Maklumat</button>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #666;">
                        <p><strong>Tarikh Jana:</strong> ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</p>
                        <p>Dokumen ini dijana secara automatik dari Sistem Kehadiran GIATMARA Kelantan</p>
                        <p>Untuk sebarang pertanyaan, sila hubungi pihak pentadbiran pusat berkenaan</p>
                    </div>
                </body>
                </html>
            `);
            detailWindow.document.close();
        }

        function editPelatihAdmin(pelatihId) {
            const pelatih = window.allPelatihData.find(p => p.id === pelatihId);
            if (!pelatih) return;
            
            showNotification(`Fungsi edit untuk pelatih "${pelatih.nama}" akan dibangunkan dalam versi seterusnya.`);
        }

        function transferPelatih(pelatihId) {
            const pelatih = window.allPelatihData.find(p => p.id === pelatihId);
            if (!pelatih) return;
            
            showNotification(`Fungsi pindah untuk pelatih "${pelatih.nama}" akan dibangunkan dalam versi seterusnya.`);
        }

        // Logo Management Functions
        let currentLogo = {
            type: 'text',
            content: 'G',
            background: '#ffffff',
            size: 'medium',
            shape: 'circle'
        };

        let logoHistory = [
            { id: 'default', type: 'text', content: 'G', name: 'Logo Default', date: 'Hari ini', background: '#ffffff' },
            { id: 'building', type: 'emoji', content: 'üè¢', name: 'Logo Bangunan', date: '2 hari lalu', background: '#ffffff' },
            { id: 'education', type: 'emoji', content: 'üéì', name: 'Logo Pendidikan', date: '1 minggu lalu', background: '#ffffff' }
        ];

        function showLogoManagement() {
            document.getElementById('logoManagementModal').classList.remove('hidden');
            updateCurrentLogoDisplay();
        }

        function closeLogoManagement() {
            document.getElementById('logoManagementModal').classList.add('hidden');
            cancelLogoUpload();
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const allowedTypes = ['image/png', 'image/jpg', 'image/jpeg', 'image/svg+xml'];
            if (!allowedTypes.includes(file.type)) {
                alert('Format fail tidak disokong. Sila gunakan PNG, JPG, JPEG, atau SVG.');
                event.target.value = '';
                return;
            }

            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                alert('Saiz fail terlalu besar. Maksimum 2MB dibenarkan.');
                event.target.value = '';
                return;
            }

            // Read and preview the file
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImage = document.getElementById('previewImage');
                previewImage.src = e.target.result;
                
                // Store the image data for later use
                window.pendingLogoData = {
                    type: 'image',
                    content: e.target.result,
                    name: file.name,
                    size: file.size
                };
                
                // Show preview
                document.getElementById('logoPreview').classList.remove('hidden');
                showNotification('Logo berjaya dimuat naik! Klik "Guna Logo Ini" untuk mengaplikasikan.');
            };
            
            reader.readAsDataURL(file);
        }

        function applyNewLogo() {
            if (!window.pendingLogoData) {
                alert('Tiada logo untuk diaplikasikan.');
                return;
            }

            // Update current logo
            currentLogo = {
                ...window.pendingLogoData,
                background: document.getElementById('logoBackground').value,
                size: document.getElementById('logoSize').value,
                shape: document.getElementById('logoShape').value
            };

            // Add to history
            const newHistoryItem = {
                id: 'custom_' + Date.now(),
                ...currentLogo,
                name: `Logo Custom (${window.pendingLogoData.name})`,
                date: 'Baru sahaja'
            };
            logoHistory.unshift(newHistoryItem);

            // Auto-save to localStorage
            autoSaveCurrentLogo();
            autoSaveLogoHistory();
            
            // Update displays
            updateAllLogoDisplays();
            updateCurrentLogoDisplay();
            cancelLogoUpload();
            
            showNotification('Logo baru telah diaplikasikan ke seluruh sistem!');
        }

        function cancelLogoUpload() {
            document.getElementById('logoPreview').classList.add('hidden');
            document.getElementById('logoFileInput').value = '';
            window.pendingLogoData = null;
        }

        function useTemplateIcon(icon) {
            // Update current logo
            currentLogo = {
                type: icon === 'G' ? 'text' : 'emoji',
                content: icon,
                background: document.getElementById('logoBackground').value,
                size: document.getElementById('logoSize').value,
                shape: document.getElementById('logoShape').value
            };

            // Add to history
            const iconNames = {
                'G': 'Logo Default',
                'üè¢': 'Logo Bangunan',
                'üéì': 'Logo Pendidikan',
                '‚öôÔ∏è': 'Logo Gear',
                'üìö': 'Logo Buku',
                'üîß': 'Logo Alatan'
            };

            const newHistoryItem = {
                id: 'template_' + Date.now(),
                ...currentLogo,
                name: iconNames[icon] || 'Logo Template',
                date: 'Baru sahaja'
            };

            // Remove existing similar template from history
            logoHistory = logoHistory.filter(item => item.content !== icon);
            logoHistory.unshift(newHistoryItem);

            // Auto-save to localStorage
            autoSaveCurrentLogo();
            autoSaveLogoHistory();
            
            // Update displays
            updateAllLogoDisplays();
            updateCurrentLogoDisplay();
            
            showNotification(`${iconNames[icon] || 'Logo template'} telah diaplikasikan!`);
        }

        function updateCurrentLogoDisplay() {
            const display = document.getElementById('currentLogoDisplay');
            const logoContainer = display.parentElement;
            
            // Update logo content
            if (currentLogo.type === 'image') {
                display.innerHTML = `<img src="${currentLogo.content}" alt="Logo" class="w-full h-full object-contain">`;
            } else {
                display.textContent = currentLogo.content;
                display.className = currentLogo.type === 'text' ? 'text-purple-600 font-bold text-2xl' : 'text-2xl';
            }
            
            // Update container styling
            updateLogoContainerStyle(logoContainer);
        }

        function updateAllLogoDisplays() {
            // Update navigation logo
            const navLogo = document.querySelector('nav .w-10.h-10 span');
            if (navLogo) {
                if (currentLogo.type === 'image') {
                    navLogo.innerHTML = `<img src="${currentLogo.content}" alt="Logo" class="w-full h-full object-contain rounded-full">`;
                } else {
                    navLogo.textContent = currentLogo.content;
                    navLogo.className = currentLogo.type === 'text' ? 'text-purple-600 font-bold text-lg' : 'text-lg';
                }
                
                // Update nav logo container
                const navContainer = navLogo.parentElement;
                updateLogoContainerStyle(navContainer);
            }
        }

        function updateLogoContainerStyle(container) {
            // Reset classes
            container.className = container.className.replace(/w-\d+|h-\d+|rounded-\w+|bg-\w+-\d+/g, '');
            
            // Apply size
            const sizeClasses = {
                'small': 'w-8 h-8',
                'medium': 'w-10 h-10',
                'large': 'w-12 h-12'
            };
            
            // Apply shape
            const shapeClasses = {
                'circle': 'rounded-full',
                'square': 'rounded-none',
                'rounded': 'rounded-lg'
            };
            
            // Apply background color
            const bgColor = currentLogo.background || '#ffffff';
            container.style.backgroundColor = bgColor;
            
            // Add classes
            container.className += ` ${sizeClasses[currentLogo.size]} ${shapeClasses[currentLogo.shape]} flex items-center justify-center border`;
        }

        function resetToDefaultLogo() {
            if (!confirm('Adakah anda pasti ingin reset logo ke default?')) {
                return;
            }

            currentLogo = {
                type: 'text',
                content: 'G',
                background: '#ffffff',
                size: 'medium',
                shape: 'circle'
            };

            updateAllLogoDisplays();
            updateCurrentLogoDisplay();
            showNotification('Logo telah direset ke default!');
        }

        function downloadCurrentLogo() {
            if (currentLogo.type === 'image') {
                // Download image logo
                const link = document.createElement('a');
                link.href = currentLogo.content;
                link.download = 'GIATMARA_Logo.png';
                link.click();
                showNotification('Logo sedang dimuat turun...');
            } else {
                // Create SVG for text/emoji logo
                const svg = `
                    <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                        <rect width="200" height="200" fill="${currentLogo.background}" rx="${currentLogo.shape === 'circle' ? '100' : currentLogo.shape === 'rounded' ? '20' : '0'}"/>
                        <text x="100" y="120" text-anchor="middle" font-size="80" font-weight="bold" fill="#6b46c1">${currentLogo.content}</text>
                    </svg>
                `;
                
                const blob = new Blob([svg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'GIATMARA_Logo.svg';
                link.click();
                URL.revokeObjectURL(url);
                showNotification('Logo SVG sedang dimuat turun...');
            }
        }

        function revertToLogo(logoId) {
            const logo = logoHistory.find(l => l.id === logoId);
            if (!logo) return;

            currentLogo = {
                type: logo.type,
                content: logo.content,
                background: logo.background || '#ffffff',
                size: document.getElementById('logoSize').value,
                shape: document.getElementById('logoShape').value
            };

            // Update history - move to top
            logoHistory = logoHistory.filter(l => l.id !== logoId);
            logoHistory.unshift({
                ...logo,
                date: 'Baru sahaja'
            });

            updateAllLogoDisplays();
            updateCurrentLogoDisplay();
            showNotification(`Logo "${logo.name}" telah diaplikasikan!`);
        }

        function deleteLogo(logoId) {
            const logo = logoHistory.find(l => l.id === logoId);
            if (!logo) return;

            if (!confirm(`Adakah anda pasti ingin memadam "${logo.name}" dari sejarah?`)) {
                return;
            }

            logoHistory = logoHistory.filter(l => l.id !== logoId);
            showNotification(`Logo "${logo.name}" telah dipadam dari sejarah.`);
        }

        function updateLogoSize() {
            currentLogo.size = document.getElementById('logoSize').value;
            updateAllLogoDisplays();
            updateCurrentLogoDisplay();
            showNotification('Saiz logo telah dikemas kini!');
        }

        function updateLogoShape() {
            currentLogo.shape = document.getElementById('logoShape').value;
            updateAllLogoDisplays();
            updateCurrentLogoDisplay();
            showNotification('Bentuk logo telah dikemas kini!');
        }

        function updateLogoBackground() {
            currentLogo.background = document.getElementById('logoBackground').value;
            updateAllLogoDisplays();
            updateCurrentLogoDisplay();
            showNotification('Warna latar logo telah dikemas kini!');
        }

        // Global array to store centers
        let pusatData = [
            {id: 1, nama: "GIATMARA Kota Bharu", alamat: "Jalan Sultan Yahya Petra, 15200 Kota Bharu, Kelantan", password: "pusat123", status: "Aktif"},
            {id: 2, nama: "GIATMARA Machang", alamat: "Jalan Raya Machang, 18500 Machang, Kelantan", password: "pusat123", status: "Aktif"},
            {id: 3, nama: "GIATMARA Tanah Merah", alamat: "Jalan Raya Tanah Merah, 17500 Tanah Merah, Kelantan", password: "pusat123", status: "Aktif"},
            {id: 4, nama: "GIATMARA Gua Musang", alamat: "Jalan Raya Gua Musang, 18300 Gua Musang, Kelantan", password: "pusat123", status: "Aktif"},
            {id: 5, nama: "GIATMARA Kuala Krai", alamat: "Jalan Raya Kuala Krai, 18000 Kuala Krai, Kelantan", password: "pusat123", status: "Aktif"}
            {id: 5, nama: "GIATMARA Prima Melor", alamat: "Kampung Padang Salim, 15050 Ketereh, Kelantan", password: "pusat123", status: "Aktif"}
            {id: 5, nama: "GIATMARA Tumpat", alamat: "Kampung Tujoh, 16200 Tumpat, Kelantan", password: "pusat123", status: "Aktif"}
        ];

        // Global array to store courses
        let kursusData = [
            {id: 1, nama: "BAIKPULIH DAN MENGECAT KENDERAAN", tempoh: "6", status: "Aktif"},
            {id: 2, nama: "BAIKPULIH KERANGKA KENDERAAN", tempoh: "6", status: "Aktif"},
            {id: 3, nama: "BEM", tempoh: "3", status: "Aktif"},
            {id: 4, nama: "JAHITAN LANGSIR & SOFT FURNISHING", tempoh: "6", status: "Aktif"},
            {id: 5, nama: "JAHITAN PAKAIAN DAN FESYEN", tempoh: "6", status: "Aktif"},
            {id: 6, nama: "KIMPALAN STRUKTUR KELULI", tempoh: "9", status: "Aktif"},
            {id: 7, nama: "KONFEKSIONERI & BAKERI", tempoh: "6", status: "Aktif"},
            {id: 8, nama: "MASAKAN DAN PRAMUSAJI", tempoh: "6", status: "Aktif"},
            {id: 9, nama: "MASAKAN ETNIK ASIAN", tempoh: "6", status: "Aktif"},
            {id: 10, nama: "PENDAWAI ELEKTRIK (PW4)", tempoh: "12", status: "Aktif"},
            {id: 11, nama: "PENDAWAIAN ELEKTRIK PW2", tempoh: "6", status: "Aktif"},
            {id: 12, nama: "REKAAN PAKAIAN DAN FESYEN", tempoh: "6", status: "Aktif"},
            {id: 13, nama: "TEK. BINANAN BANBGUNAN", tempoh: "12", status: "Aktif"},
            {id: 14, nama: "TEK. KIMPALAN", tempoh: "9", status: "Aktif"},
            {id: 15, nama: "TEK. PENYEJUKBEKUAN & PENYAMANAN UDARA", tempoh: "12", status: "Aktif"},
            {id: 16, nama: "TEKNOLOGI AUTOMOTIF (TAHAP 2)", tempoh: "6", status: "Aktif"},
            {id: 17, nama: "TEKNOLOGI AUTOMOTIF (TAHAP 3)", tempoh: "9", status: "Aktif"},
            {id: 18, nama: "TEKNOLOGI ELEKTRONIK", tempoh: "6", status: "Aktif"},
            {id: 19, nama: "TEKNOLOGI MOTOSIKAL", tempoh: "6", status: "Aktif"},
            {id: 20, nama: "TEKNOLOGI PERABOT", tempoh: "9", status: "Aktif"},
            {id: 21, nama: "TEKNOLOGI SISTEM KOMPUTER", tempoh: "6", status: "Aktif"},
            {id: 22, nama: "TERAPI KECANTIKAN DAN SOLEKAN", tempoh: "6", status: "Aktif"}
        ];

        function tambahPusat(event) {
            event.preventDefault();
            const namaPusat = document.getElementById('namaPusat').value;
            const alamatPusat = document.getElementById('alamatPusat').value;
            const passwordPusat = document.getElementById('passwordPusat').value;
            const confirmPassword = document.getElementById('confirmPasswordPusat').value;
            
            // Validate password confirmation
            if (passwordPusat !== confirmPassword) {
                alert('Kata laluan dan pengesahan kata laluan tidak sama! Sila sahkan semula.');
                return;
            }
            
            // Validate password strength
            if (passwordPusat.length < 6) {
                alert('Kata laluan mesti sekurang-kurangnya 6 aksara!');
                return;
            }
            
            // Check for duplicate center name
            const existingPusat = pusatData.find(p => p.nama.toLowerCase() === namaPusat.toLowerCase());
            if (existingPusat) {
                alert(`Pusat "${namaPusat}" sudah wujud! Sila gunakan nama yang berbeza.`);
                return;
            }
            
            // Add new center to array
            const newPusat = {
                id: pusatData.length + 1,
                nama: namaPusat,
                alamat: alamatPusat,
                password: passwordPusat,
                status: "Aktif"
            };
            
            pusatData.push(newPusat);
            
            // Auto-save to localStorage
            autoSavePusatData();
            
            // Update the center list display
            updatePusatList();
            
            // Update the login dropdown
            updatePusatDropdown();
            
            // Clear form
            document.getElementById('namaPusat').value = '';
            document.getElementById('alamatPusat').value = '';
            document.getElementById('passwordPusat').value = '';
            document.getElementById('confirmPasswordPusat').value = '';
            
            alert(`Pusat "${namaPusat}" berjaya ditambah dengan kata laluan yang ditetapkan!`);
        }

        function editPusat(pusatId) {
            const pusat = pusatData.find(p => p.id === pusatId);
            if (!pusat) return;
            
            // Populate form with existing data
            document.getElementById('namaPusat').value = pusat.nama;
            document.getElementById('alamatPusat').value = pusat.alamat;
            
            // Hide password fields for editing (security)
            document.getElementById('passwordPusat').style.display = 'none';
            document.getElementById('confirmPasswordPusat').style.display = 'none';
            document.querySelector('label[for="passwordPusat"]').style.display = 'none';
            document.querySelector('label[for="confirmPasswordPusat"]').style.display = 'none';
            
            // Change form submit to update mode
            const form = document.querySelector('#pusatManagementModal form');
            form.onsubmit = function(event) {
                event.preventDefault();
                updatePusat(pusatId);
            };
            
            // Change button text
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.innerHTML = 'Kemas Kini Pusat';
            submitButton.className = 'bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition';
            
            showNotification(`Mode edit untuk pusat "${pusat.nama}". Kata laluan tidak akan diubah.`);
        }

        function updatePusat(pusatId) {
            const pusat = pusatData.find(p => p.id === pusatId);
            if (!pusat) return;
            
            const namaPusat = document.getElementById('namaPusat').value;
            const alamatPusat = document.getElementById('alamatPusat').value;
            
            // Check for duplicate center name (excluding current center)
            const existingPusat = pusatData.find(p => p.nama.toLowerCase() === namaPusat.toLowerCase() && p.id !== pusatId);
            if (existingPusat) {
                alert(`Pusat "${namaPusat}" sudah wujud! Sila gunakan nama yang berbeza.`);
                return;
            }
            
            // Update center data (password remains unchanged)
            pusat.nama = namaPusat;
            pusat.alamat = alamatPusat;
            
            updatePusatList();
            updatePusatDropdown();
            resetPusatForm();
            
            showNotification(`Pusat "${namaPusat}" berjaya dikemas kini!`);
        }

        function resetPasswordPusat(pusatId) {
            const pusat = pusatData.find(p => p.id === pusatId);
            if (!pusat) return;
            
            const newPassword = prompt(`Masukkan kata laluan baru untuk "${pusat.nama}":\n\n(Minimum 6 aksara)`);
            
            if (newPassword === null) return; // User cancelled
            
            if (!newPassword || newPassword.length < 6) {
                alert('Kata laluan mesti sekurang-kurangnya 6 aksara!');
                return;
            }
            
            const confirmPassword = prompt(`Sahkan kata laluan baru untuk "${pusat.nama}":`);
            
            if (confirmPassword === null) return; // User cancelled
            
            if (newPassword !== confirmPassword) {
                alert('Kata laluan dan pengesahan tidak sama! Sila cuba sekali lagi.');
                return;
            }
            
            // Update password
            pusat.password = newPassword;
            updatePusatList();
            
            alert(`Kata laluan untuk pusat "${pusat.nama}" berjaya dikemas kini!`);
        }

        function resetPusatForm() {
            // Clear form
            document.getElementById('namaPusat').value = '';
            document.getElementById('alamatPusat').value = '';
            document.getElementById('passwordPusat').value = '';
            document.getElementById('confirmPasswordPusat').value = '';
            
            // Show password fields
            document.getElementById('passwordPusat').style.display = 'block';
            document.getElementById('confirmPasswordPusat').style.display = 'block';
            document.querySelector('label[for="passwordPusat"]').style.display = 'block';
            document.querySelector('label[for="confirmPasswordPusat"]').style.display = 'block';
            
            // Reset form to add mode
            const form = document.querySelector('#pusatManagementModal form');
            form.onsubmit = function(event) {
                tambahPusat(event);
            };
            
            // Reset button text
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.innerHTML = 'Tambah Pusat';
            submitButton.className = 'bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition';
        }

        function updatePusatList() {
            const pusatListContainer = document.querySelector('#pusatManagementModal .space-y-2');
            pusatListContainer.innerHTML = '';
            
            pusatData.forEach(pusat => {
                const pusatElement = document.createElement('div');
                pusatElement.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                pusatElement.innerHTML = `
                    <div class="flex-1">
                        <span class="font-medium">${pusat.nama}</span>
                        <p class="text-sm text-gray-600">${pusat.alamat}</p>
                        <p class="text-xs text-blue-600 mt-1">
                            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            Kata laluan: ${'*'.repeat(pusat.password.length)} (${pusat.password.length} aksara)
                        </p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-green-600 text-sm">${pusat.status}</span>
                        <button onclick="editPusat(${pusat.id})" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
                            Edit
                        </button>
                        <button onclick="resetPasswordPusat(${pusat.id})" class="px-2 py-1 bg-orange-600 text-white text-xs rounded hover:bg-orange-700 transition">
                            Reset Kata Laluan
                        </button>
                    </div>
                `;
                pusatListContainer.appendChild(pusatElement);
            });
        }

        function updatePusatDropdown() {
            const pusatSelect = document.getElementById('pusatSelect');
            // Clear existing options except the first one
            pusatSelect.innerHTML = '<option value="">Pilih Pusat GIATMARA</option>';
            
            // Add all centers from pusatData
            pusatData.forEach(pusat => {
                const option = document.createElement('option');
                option.value = pusat.nama.toLowerCase().replace(/\s+/g, '-').replace('giatmara-', '');
                option.textContent = pusat.nama;
                pusatSelect.appendChild(option);
            });
        }

        function tambahKursus(event) {
            event.preventDefault();
            const namaKursus = document.getElementById('namaKursus').value;
            const tempohKursus = document.getElementById('tempohKursus').value;
            
            // Check for duplicate course name
            const existingKursus = kursusData.find(k => k.nama.toLowerCase() === namaKursus.toLowerCase());
            if (existingKursus) {
                alert(`Kursus "${namaKursus}" sudah wujud! Sila gunakan nama yang berbeza.`);
                return;
            }
            
            // Add new course to array
            const newKursus = {
                id: kursusData.length + 1,
                nama: namaKursus.toUpperCase(),
                tempoh: tempohKursus,
                status: "Aktif"
            };
            
            kursusData.push(newKursus);
            
            // Auto-save to localStorage
            autoSaveKursusData();
            
            // Update the course list display
            updateKursusList();
            
            // Clear form
            document.getElementById('namaKursus').value = '';
            document.getElementById('tempohKursus').value = '';
            
            alert(`Kursus "${namaKursus}" (${tempohKursus} bulan) berjaya ditambah!`);
        }

        function updateKursusList() {
            const kursusListContainer = document.querySelector('#kursusManagementModal .space-y-2');
            kursusListContainer.innerHTML = '';
            
            kursusData.forEach(kursus => {
                const kursusElement = document.createElement('div');
                kursusElement.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                kursusElement.innerHTML = `
                    <div>
                        <span class="font-medium">${kursus.nama}</span>
                        <span class="text-sm text-gray-600 ml-2">(${kursus.tempoh} bulan)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-green-600 text-sm">${kursus.status}</span>
                        <button onclick="editKursus(${kursus.id})" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
                            Edit
                        </button>
                        <button onclick="padamKursus(${kursus.id})" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                            Padam
                        </button>
                    </div>
                `;
                kursusListContainer.appendChild(kursusElement);
            });
        }

        function editKursus(kursusId) {
            const kursus = kursusData.find(k => k.id === kursusId);
            if (!kursus) return;
            
            // Populate form with existing data
            document.getElementById('namaKursus').value = kursus.nama;
            document.getElementById('tempohKursus').value = kursus.tempoh;
            
            // Change form submit to update mode
            const form = document.querySelector('#kursusManagementModal form');
            form.onsubmit = function(event) {
                event.preventDefault();
                updateKursus(kursusId);
            };
            
            // Change button text
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.innerHTML = 'Kemas Kini Kursus';
            submitButton.className = 'bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition';
            
            showNotification(`Mode edit untuk kursus "${kursus.nama}". Ubah maklumat dan klik "Kemas Kini Kursus".`);
        }

        function updateKursus(kursusId) {
            const kursus = kursusData.find(k => k.id === kursusId);
            if (!kursus) return;
            
            const namaKursus = document.getElementById('namaKursus').value;
            const tempohKursus = document.getElementById('tempohKursus').value;
            
            // Check for duplicate course name (excluding current course)
            const existingKursus = kursusData.find(k => k.nama.toLowerCase() === namaKursus.toLowerCase() && k.id !== kursusId);
            if (existingKursus) {
                alert(`Kursus "${namaKursus}" sudah wujud! Sila gunakan nama yang berbeza.`);
                return;
            }
            
            // Update course data
            kursus.nama = namaKursus.toUpperCase();
            kursus.tempoh = tempohKursus;
            
            updateKursusList();
            
            // Clear form
            document.getElementById('namaKursus').value = '';
            document.getElementById('tempohKursus').value = '';
            
            // Reset form to add mode
            const form = document.querySelector('#kursusManagementModal form');
            form.onsubmit = function(event) {
                tambahKursus(event);
            };
            
            // Reset button text
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.innerHTML = 'Tambah Kursus';
            submitButton.className = 'bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition';
            
            showNotification(`Kursus "${namaKursus}" berjaya dikemas kini!`);
        }

        function padamKursus(kursusId) {
            const kursus = kursusData.find(k => k.id === kursusId);
            if (!kursus) return;
            
            // Check if course is being used by any trainee
            const pelatihUsingKursus = pelatihData.filter(p => p.kursus === kursus.nama);
            if (pelatihUsingKursus.length > 0) {
                alert(`Kursus "${kursus.nama}" tidak boleh dipadam kerana masih digunakan oleh ${pelatihUsingKursus.length} pelatih. Sila pindahkan pelatih ke kursus lain terlebih dahulu.`);
                return;
            }
            
            // Check if course is being used by any session
            const sesiUsingKursus = sesiData.filter(s => s.namaKursus === kursus.nama);
            if (sesiUsingKursus.length > 0) {
                alert(`Kursus "${kursus.nama}" tidak boleh dipadam kerana masih digunakan oleh ${sesiUsingKursus.length} sesi. Sila padam sesi berkaitan terlebih dahulu.`);
                return;
            }
            
            if (!confirm(`Adakah anda pasti ingin memadam kursus "${kursus.nama}"?`)) {
                return;
            }
            
            // Remove course from array
            const index = kursusData.findIndex(k => k.id === kursusId);
            if (index > -1) {
                kursusData.splice(index, 1);
                updateKursusList();
                showNotification(`Kursus "${kursus.nama}" telah dipadam.`);
            }
        }

        function tambahSesi(event) {
            event.preventDefault();
            const namaSesi = document.getElementById('namaSesi').value;
            const masaMula = document.getElementById('masaMula').value;
            const masaTamat = document.getElementById('masaTamat').value;
            const bilanganBulan = document.getElementById('bilanganBulan').value;
            const bilanganHari = document.getElementById('bilanganHari').value;
            const tahunSesi = document.getElementById('tahunSesi').value;
            
            alert(`Sesi "${namaSesi}" berjaya ditambah!\nMasa: ${masaMula} - ${masaTamat}\nTempoh: ${bilanganBulan} bulan, ${bilanganHari} hari\nTahun: ${tahunSesi}`);
            
            // Reset form
            document.getElementById('namaSesi').value = '';
            document.getElementById('masaMula').value = '';
            document.getElementById('masaTamat').value = '';
            document.getElementById('bilanganBulan').value = '';
            document.getElementById('bilanganHari').value = '';
            document.getElementById('tahunSesi').value = '';
        }

        function showLaporan() {
            document.getElementById('laporanModal').classList.remove('hidden');
        }

        function closeLaporan() {
            document.getElementById('laporanModal').classList.add('hidden');
        }

        function janaLaporanHarian() {
            const today = new Date().toLocaleDateString('ms-MY');
            const hadir = pelatihData.filter(p => p.status === 'Hadir').length;
            const tidakHadir = pelatihData.filter(p => p.status === 'Tidak Hadir').length;
            const lewat = pelatihData.filter(p => p.status === 'Lewat').length;
            
            document.getElementById('laporanContent').innerHTML = `
                <h4 class="font-semibold mb-3">Laporan Harian - ${today}</h4>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="bg-green-100 p-3 rounded">
                        <p class="text-2xl font-bold text-green-600">${hadir}</p>
                        <p class="text-sm">Hadir</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded">
                        <p class="text-2xl font-bold text-red-600">${tidakHadir}</p>
                        <p class="text-sm">Tidak Hadir</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded">
                        <p class="text-2xl font-bold text-yellow-600">${lewat}</p>
                        <p class="text-sm">Lewat</p>
                    </div>
                </div>
                <button onclick="window.print()" class="w-full mt-4 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
                    Cetak Laporan
                </button>
            `;
        }

        function janaLaporanBulanan() {
            const currentMonth = new Date().toLocaleDateString('ms-MY', { month: 'long', year: 'numeric' });
            
            document.getElementById('laporanContent').innerHTML = `
                <h4 class="font-semibold mb-3">Laporan Bulanan - ${currentMonth}</h4>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Pukarata Kehadiran:</span>
                        <span class="font-semibold">85%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Jumlah Hari Kursus:</span>
                        <span class="font-semibold">22 hari</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Pelatih Aktif:</span>
                        <span class="font-semibold">${pelatihData.length}</span>
                    </div>
                </div>
                <button onclick="window.print()" class="w-full mt-4 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
                    Cetak Laporan
                </button>
            `;
        }

        function janaLaporanTahunan() {
            const currentYear = new Date().getFullYear();
            
            document.getElementById('laporanContent').innerHTML = `
                <h4 class="font-semibold mb-3">Laporan Tahunan - ${currentYear}</h4>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Jumlah Pelatih Lulus:</span>
                        <span class="font-semibold">156</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Kadar Kelulusan:</span>
                        <span class="font-semibold">92%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Pukarata Kehadiran Tahunan:</span>
                        <span class="font-semibold">88%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Kursus Paling Popular:</span>
                        <span class="font-semibold">Elektrik</span>
                    </div>
                </div>
                <button onclick="window.print()" class="w-full mt-4 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
                    Cetak Laporan
                </button>
            `;
        }

        function filterPelatih() {
            const searchTerm = document.getElementById('searchPelatih').value.toLowerCase();
            const filterKursus = document.getElementById('filterKursus').value;
            
            let filteredData = pelatihData.filter(pelatih => {
                const matchesSearch = pelatih.nama.toLowerCase().includes(searchTerm) || 
                                    pelatih.noKP.includes(searchTerm);
                const matchesKursus = !filterKursus || pelatih.kursus === filterKursus;
                return matchesSearch && matchesKursus;
            });
            
            displayFilteredPelatih(filteredData);
        }

        function displayFilteredPelatih(data) {
            const kehadiranList = document.getElementById('kehadiranList');
            kehadiranList.innerHTML = '';
            
            data.forEach(pelatih => {
                const statusColor = pelatih.status === 'Hadir' ? 'bg-green-100 text-green-800' : 
                                  pelatih.status === 'Lewat' ? 'bg-yellow-100 text-yellow-800' : 
                                  'bg-red-100 text-red-800';
                
                const pelatihElement = document.createElement('div');
                pelatihElement.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-lg';
                pelatihElement.innerHTML = `
                    <div>
                        <p class="font-medium">${pelatih.nama}</p>
                        <p class="text-sm text-gray-600">${pelatih.kursus} | ${pelatih.sesiNama || 'Tiada Sesi'} | ${pelatih.noKP}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="px-3 py-1 rounded-full text-sm ${statusColor}">${pelatih.status}</span>
                        <div class="flex space-x-1">
                            <button onclick="updateStatus(${pelatih.id}, 'Hadir')" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                Hadir
                            </button>
                            <button onclick="updateStatus(${pelatih.id}, 'Lewat')" class="px-3 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700 transition">
                                Lewat
                            </button>
                            <button onclick="updateStatus(${pelatih.id}, 'Tidak Hadir')" class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                                Tidak Hadir
                            </button>
                        </div>
                    </div>
                `;
                kehadiranList.appendChild(pelatihElement);
            });
        }

        function markAllPresent() {
            pelatihData.forEach(pelatih => {
                pelatih.status = 'Hadir';
            });
            updateKehadiranList();
            updatePusatStats();
            showNotification('Semua pelatih telah ditandakan hadir!');
        }

        function simpanKehadiran() {
            const currentDate = window.currentEditDate || document.getElementById('searchTarikh').value;
            const formattedDate = new Date(currentDate).toLocaleDateString('ms-MY');
            
            // Save current attendance state to history
            const today = new Date().toISOString().split('T')[0];
            if (currentDate === today) {
                // For today, save the current pelatih data status
                saveAttendanceForDate(currentDate, pelatihData);
            }
            
            // Disable edit mode
            isEditMode = false;
            
            showNotification(`Kehadiran untuk ${formattedDate} telah disimpan!`);
            
            // If editing past date, reload to show non-editable view
            if (currentDate !== today) {
                loadAttendanceForDate(currentDate);
            }
            
            closeKehadiran();
        }

        // Center Reports Functions
        function showLaporanPusat() {
            document.getElementById('laporanPusatModal').classList.remove('hidden');
            // Set current date
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ms-MY');
            
            // Set default date for daily report to today
            const today = new Date();
            const todayString = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
            document.getElementById('tarikhHarian').value = todayString;
        }

        function closeLaporanPusat() {
            document.getElementById('laporanPusatModal').classList.add('hidden');
        }

        function janaLaporanHarianPusat() {
            const selectedDate = document.getElementById('tarikhHarian').value;
            
            if (!selectedDate) {
                alert('Sila pilih tarikh untuk laporan harian.');
                return;
            }
            
            const formattedDate = new Date(selectedDate).toLocaleDateString('ms-MY');
            const hadir = pelatihData.filter(p => p.status === 'Hadir').length;
            const tidakHadir = pelatihData.filter(p => p.status === 'Tidak Hadir').length;
            const lewat = pelatihData.filter(p => p.status === 'Lewat').length;
            const total = pelatihData.length;
            const persentaseKehadiran = total > 0 ? Math.round((hadir + lewat) / total * 100) : 0;
            
            document.getElementById('laporanPusatContent').innerHTML = `
                <h4 class="font-semibold mb-4">Laporan Harian - ${formattedDate}</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-green-600">${hadir}</p>
                        <p class="text-sm text-gray-600">Hadir</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-yellow-600">${lewat}</p>
                        <p class="text-sm text-gray-600">Lewat</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-red-600">${tidakHadir}</p>
                        <p class="text-sm text-gray-600">Tidak Hadir</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-blue-600">${persentaseKehadiran}%</p>
                        <p class="text-sm text-gray-600">Kehadiran</p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h5 class="font-semibold mb-3">Senarai Kehadiran Pelatih</h5>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-2 text-left">Bil</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama Pelatih</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">No. KP</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Kursus</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">No. Telefon</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pelatihData.map((p, index) => `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="border border-gray-300 px-4 py-2">${index + 1}</td>
                                        <td class="border border-gray-300 px-4 py-2 font-medium">${p.nama}</td>
                                        <td class="border border-gray-300 px-4 py-2">${p.noKP}</td>
                                        <td class="border border-gray-300 px-4 py-2">${p.kursus}</td>
                                        <td class="border border-gray-300 px-4 py-2">${p.telefon}</td>
                                        <td class="border border-gray-300 px-4 py-2 text-center">
                                            <span class="px-2 py-1 rounded text-xs ${p.status === 'Hadir' ? 'bg-green-100 text-green-800' : 
                                                p.status === 'Lewat' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${p.status}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="text-xs text-gray-600 mt-4">
                    <p><strong>Tarikh Jana:</strong> ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</p>
                    <p><strong>Pusat:</strong> ${currentUser || 'GIATMARA Kelantan'}</p>
                </div>
            `;
        }

        function janaLaporanBulananPusat() {
            const currentMonth = new Date().toLocaleDateString('ms-MY', { month: 'long', year: 'numeric' });
            const hadir = pelatihData.filter(p => p.status === 'Hadir').length;
            const total = pelatihData.length;
            const persentaseKehadiran = total > 0 ? Math.round(hadir / total * 100) : 0;
            
            // Calculate working days in current month (excluding Friday and Saturday)
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let workingDays = [];
            let totalHariKursus = 0;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
                
                // Exclude Friday (5) and Saturday (6)
                if (dayOfWeek !== 5 && dayOfWeek !== 6) {
                    workingDays.push(day);
                    totalHariKursus++;
                }
            }
            
            // Generate monthly attendance data for each trainee with daily tracking
            const monthlyData = pelatihData.map(p => {
                const hadirBulan = Math.floor(Math.random() * 3) + (totalHariKursus - 4); // Random high attendance
                const lewatBulan = Math.floor(Math.random() * 2) + 1; // Random between 1-2 days late
                const tidakHadirBulan = totalHariKursus - hadirBulan - lewatBulan; // Calculate absent days
                const jumlahKehadiranEfektif = hadirBulan + lewatBulan; // Present + Late = Effective attendance
                const persentase = Math.round((jumlahKehadiranEfektif / totalHariKursus) * 100);
                
                // Generate daily attendance pattern for working days only
                const dailyPattern = [];
                for (let i = 1; i <= totalHariKursus; i++) {
                    if (i <= hadirBulan) {
                        dailyPattern.push('H'); // Hadir
                    } else if (i <= hadirBulan + lewatBulan) {
                        dailyPattern.push('L'); // Lewat
                    } else {
                        dailyPattern.push('T'); // Tidak Hadir
                    }
                }
                // Shuffle the pattern to make it more realistic
                for (let i = dailyPattern.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [dailyPattern[i], dailyPattern[j]] = [dailyPattern[j], dailyPattern[i]];
                }
                
                return {
                    ...p,
                    hadirBulan: hadirBulan,
                    lewatBulan: lewatBulan,
                    tidakHadirBulan: tidakHadirBulan,
                    jumlahKehadiranEfektif: jumlahKehadiranEfektif,
                    totalHari: totalHariKursus,
                    persentase: persentase,
                    dailyPattern: dailyPattern,
                    workingDays: workingDays
                };
            });
            
            document.getElementById('laporanPusatContent').innerHTML = `
                <h4 class="font-semibold mb-4">Laporan Bulanan Terperinci - ${currentMonth}</h4>
                
                <!-- Ringkasan Statistik -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-green-600">${monthlyData.reduce((sum, p) => sum + p.hadirBulan, 0)}</p>
                        <p class="text-sm text-gray-600">Jumlah Kehadiran Harian</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-yellow-600">${monthlyData.reduce((sum, p) => sum + p.lewatBulan, 0)}</p>
                        <p class="text-sm text-gray-600">Jumlah Lewat</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-red-600">${monthlyData.reduce((sum, p) => sum + p.tidakHadirBulan, 0)}</p>
                        <p class="text-sm text-gray-600">Jumlah Tidak Hadir</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-blue-600">${Math.round(monthlyData.reduce((sum, p) => sum + p.persentase, 0) / monthlyData.length)}%</p>
                        <p class="text-sm text-gray-600">Purata Kehadiran</p>
                    </div>
                </div>

                <!-- Statistik Tambahan -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div class="bg-white border rounded-lg p-4">
                        <h6 class="font-semibold mb-3 text-gray-800">Analisis Prestasi</h6>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Pelatih Cemerlang (‚â•90%):</span>
                                <span class="font-semibold text-green-600">${monthlyData.filter(p => p.persentase >= 90).length} orang</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Pelatih Baik (80-89%):</span>
                                <span class="font-semibold text-blue-600">${monthlyData.filter(p => p.persentase >= 80 && p.persentase < 90).length} orang</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Pelatih Sederhana (70-79%):</span>
                                <span class="font-semibold text-orange-600">${monthlyData.filter(p => p.persentase >= 70 && p.persentase < 80).length} orang</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Perlu Perhatian (<70%):</span>
                                <span class="font-semibold text-red-600">${monthlyData.filter(p => p.persentase < 70).length} orang</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h6 class="font-semibold mb-3 text-gray-800">Prestasi Mengikut Kursus</h6>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Teknologi Automotif:</span>
                                <span class="font-semibold">88% (${pelatihData.filter(p => p.kursus.includes('TEKNOLOGI AUTOMOTIF')).length} pelatih)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Sistem Komputer:</span>
                                <span class="font-semibold">92% (${pelatihData.filter(p => p.kursus === 'TEKNOLOGI SISTEM KOMPUTER').length} pelatih)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Kimpalan Struktur:</span>
                                <span class="font-semibold">85% (${pelatihData.filter(p => p.kursus === 'KIMPALAN STRUKTUR KELULI').length} pelatih)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Terapi Kecantikan:</span>
                                <span class="font-semibold">90% (${pelatihData.filter(p => p.kursus === 'TERAPI KECANTIKAN DAN SOLEKAN').length} pelatih)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Jadual Kehadiran Harian Terperinci -->
                <div class="mb-6">
                    <h5 class="font-semibold mb-3">Rekod Kehadiran Harian Bulanan Pelatih</h5>
                    <div class="bg-yellow-50 p-3 rounded-lg mb-4 text-sm">
                        <p><strong>Legenda:</strong> 
                        <span class="inline-block bg-green-200 text-green-800 px-2 py-1 rounded text-xs mr-2">H = Hadir</span>
                        <span class="inline-block bg-yellow-200 text-yellow-800 px-2 py-1 rounded text-xs mr-2">L = Lewat</span>
                        <span class="inline-block bg-red-200 text-red-800 px-2 py-1 rounded text-xs mr-2">T = Tidak Hadir</span>
                        <span class="inline-block bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs">- = Cuti (Jumaat/Sabtu)</span>
                        </p>
                        <p class="mt-2"><strong>Keterangan:</strong> Jadual menunjukkan hari kursus sahaja (tidak termasuk Jumaat dan Sabtu). Jumlah hari kursus bulan ini: <strong>${totalHariKursus} hari</strong></p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 text-xs">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-2 py-2 text-left sticky left-0 bg-gray-100">Bil</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left sticky left-8 bg-gray-100">Nama Pelatih</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left sticky left-32 bg-gray-100">Kursus</th>
                                    ${workingDays.map(day => `<th class="border border-gray-300 px-1 py-2 text-center min-w-6">${day}</th>`).join('')}
                                    <th class="border border-gray-300 px-2 py-2 text-center bg-green-50">H</th>
                                    <th class="border border-gray-300 px-2 py-2 text-center bg-yellow-50">L</th>
                                    <th class="border border-gray-300 px-2 py-2 text-center bg-red-50">T</th>
                                    <th class="border border-gray-300 px-2 py-2 text-center bg-blue-50">Jumlah</th>
                                    <th class="border border-gray-300 px-2 py-2 text-center bg-blue-50">%</th>
                                    <th class="border border-gray-300 px-2 py-2 text-center bg-purple-50">Gred</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthlyData.map((p, index) => {
                                    const gred = p.persentase >= 95 ? 'A+' : 
                                               p.persentase >= 90 ? 'A' : 
                                               p.persentase >= 85 ? 'B+' : 
                                               p.persentase >= 80 ? 'B' : 
                                               p.persentase >= 75 ? 'C+' : 'C';
                                    const gredColor = p.persentase >= 90 ? 'text-green-600' : 
                                                    p.persentase >= 80 ? 'text-blue-600' : 
                                                    p.persentase >= 75 ? 'text-orange-600' : 'text-red-600';
                                    
                                    const dailyCells = p.dailyPattern.map(status => {
                                        const cellClass = status === 'H' ? 'bg-green-200 text-green-800' : 
                                                         status === 'L' ? 'bg-yellow-200 text-yellow-800' : 'bg-red-200 text-red-800';
                                        return `<td class="border border-gray-300 px-1 py-2 text-center font-bold ${cellClass}">${status}</td>`;
                                    }).join('');
                                    
                                    return `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="border border-gray-300 px-2 py-2 sticky left-0 bg-white">${index + 1}</td>
                                        <td class="border border-gray-300 px-2 py-2 font-medium sticky left-8 bg-white">${p.nama}</td>
                                        <td class="border border-gray-300 px-2 py-2 sticky left-32 bg-white">${p.kursus}</td>
                                        ${dailyCells}
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold text-green-600 bg-green-50">${p.hadirBulan}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold text-yellow-600 bg-yellow-50">${p.lewatBulan}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold text-red-600 bg-red-50">${p.tidakHadirBulan}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold text-blue-600 bg-blue-50">${p.jumlahKehadiranEfektif}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold bg-blue-50">${p.persentase}%</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold ${gredColor} bg-purple-50">${gred}</td>
                                    </tr>
                                `;}).join('')}
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-200 font-semibold">
                                    <td colspan="3" class="border border-gray-300 px-2 py-2 text-center">JUMLAH</td>
                                    ${Array.from({length: totalHariKursus}, (_, i) => {
                                        const dayTotal = monthlyData.reduce((sum, p) => {
                                            return sum + (p.dailyPattern[i] !== 'T' ? 1 : 0);
                                        }, 0);
                                        return `<td class="border border-gray-300 px-1 py-2 text-center font-bold">${dayTotal}</td>`;
                                    }).join('')}
                                    <td class="border border-gray-300 px-2 py-2 text-center text-green-600">${monthlyData.reduce((sum, p) => sum + p.hadirBulan, 0)}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center text-yellow-600">${monthlyData.reduce((sum, p) => sum + p.lewatBulan, 0)}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center text-red-600">${monthlyData.reduce((sum, p) => sum + p.tidakHadirBulan, 0)}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center text-blue-600">${monthlyData.reduce((sum, p) => sum + p.jumlahKehadiranEfektif, 0)}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center">${Math.round(monthlyData.reduce((sum, p) => sum + p.persentase, 0) / monthlyData.length)}%</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Ringkasan Prestasi -->
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h6 class="font-semibold mb-3 text-gray-800">Ringkasan Prestasi Bulanan</h6>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div class="text-center">
                            <p class="font-bold text-green-600 text-lg">${monthlyData.filter(p => p.persentase >= 90).length}</p>
                            <p class="text-gray-600">Cemerlang (‚â•90%)</p>
                        </div>
                        <div class="text-center">
                            <p class="font-bold text-blue-600 text-lg">${monthlyData.filter(p => p.persentase >= 80 && p.persentase < 90).length}</p>
                            <p class="text-gray-600">Baik (80-89%)</p>
                        </div>
                        <div class="text-center">
                            <p class="font-bold text-orange-600 text-lg">${monthlyData.filter(p => p.persentase >= 70 && p.persentase < 80).length}</p>
                            <p class="text-gray-600">Sederhana (70-79%)</p>
                        </div>
                        <div class="text-center">
                            <p class="font-bold text-red-600 text-lg">${monthlyData.filter(p => p.persentase < 70).length}</p>
                            <p class="text-gray-600">Perlu Perhatian (<70%)</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-xs text-gray-600 mt-4">
                    <p><strong>Tarikh Jana:</strong> ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</p>
                    <p><strong>Pusat:</strong> ${currentUser || 'GIATMARA Kelantan'}</p>
                    <p><strong>Tempoh:</strong> ${currentMonth} (${totalHariKursus} hari kursus - tidak termasuk Jumaat & Sabtu)</p>
                    <p><strong>Jumlah Pelatih:</strong> ${total} orang${selectedKursus ? ` (Kursus: ${selectedKursus})` : ''}</p>
                    <p><strong>Purata Hari Kursus Sebulan:</strong> ${Math.round(totalWorkingDaysYear / 12)} hari</p>
                </div>
            `;
        }

        function janaLaporanTahunanPusat() {
            const currentYear = new Date().getFullYear();
            
            // Get selected course filter from yearly report dropdown
            const selectedKursus = document.getElementById('laporanTahunanKursus').value;
            
            // Filter data by course if selected
            let filteredPelatihData = pelatihData;
            if (selectedKursus) {
                filteredPelatihData = pelatihData.filter(p => p.kursus === selectedKursus);
            }
            
            const total = filteredPelatihData.length;
            const bulanNama = ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogs', 'Sep', 'Okt', 'Nov', 'Dis'];
            
            // Calculate working days for each month (excluding Friday and Saturday)
            const monthlyWorkingDays = [];
            let totalWorkingDaysYear = 0;
            
            for (let month = 0; month < 12; month++) {
                const year = currentYear;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let workingDaysInMonth = 0;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
                    
                    // Exclude Friday (5) and Saturday (6)
                    if (dayOfWeek !== 5 && dayOfWeek !== 6) {
                        workingDaysInMonth++;
                    }
                }
                
                monthlyWorkingDays.push(workingDaysInMonth);
                totalWorkingDaysYear += workingDaysInMonth;
            }
            
            // Generate yearly data for each trainee with monthly breakdown
            const yearlyData = filteredPelatihData.map(p => {
                // Generate monthly attendance data based on actual working days
                const monthlyAttendance = Array.from({length: 12}, (_, monthIndex) => {
                    const totalDaysInMonth = monthlyWorkingDays[monthIndex];
                    const attendedDays = Math.floor(Math.random() * 3) + (totalDaysInMonth - 4); // High attendance
                    const lateDays = Math.floor(Math.random() * 2) + 1; // 1-2 days late
                    const absentDays = totalDaysInMonth - attendedDays - lateDays;
                    const effectiveAttendance = attendedDays + lateDays;
                    const percentage = Math.round((effectiveAttendance / totalDaysInMonth) * 100);
                    
                    return {
                        hadir: attendedDays,
                        lewat: lateDays,
                        tidakHadir: absentDays,
                        total: totalDaysInMonth,
                        efektif: effectiveAttendance,
                        persentase: percentage
                    };
                });
                
                // Calculate yearly totals
                const totalHadirTahun = monthlyAttendance.reduce((sum, month) => sum + month.hadir, 0);
                const totalLewatTahun = monthlyAttendance.reduce((sum, month) => sum + month.lewat, 0);
                const totalTidakHadirTahun = monthlyAttendance.reduce((sum, month) => sum + month.tidakHadir, 0);
                const totalHariTahun = monthlyAttendance.reduce((sum, month) => sum + month.total, 0);
                const totalEfektifTahun = totalHadirTahun + totalLewatTahun;
                const persentaseTahun = Math.round((totalEfektifTahun / totalHariTahun) * 100);
                
                return {
                    ...p,
                    monthlyAttendance: monthlyAttendance,
                    totalHadirTahun: totalHadirTahun,
                    totalLewatTahun: totalLewatTahun,
                    totalTidakHadirTahun: totalTidakHadirTahun,
                    totalHariTahun: totalHariTahun,
                    totalEfektifTahun: totalEfektifTahun,
                    persentaseTahun: persentaseTahun,
                    statusLulus: persentaseTahun >= 75 ? 'Lulus' : 'Tidak Lulus',
                    tarikhMula: '01/01/2024',
                    tarikhTamat: '31/12/2024'
                };
            });
            
            document.getElementById('laporanPusatContent').innerHTML = `
                <h4 class="font-semibold mb-4">Laporan Tahunan Terperinci - ${currentYear}${selectedKursus ? ` (${selectedKursus})` : ''}</h4>
                ${selectedKursus ? `
                    <div class="bg-blue-50 p-3 rounded-lg mb-4 border border-blue-200">
                        <div class="flex items-center space-x-2">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                            </svg>
                            <span class="text-blue-800 font-semibold">Filter Aktif: Kursus "${selectedKursus}"</span>
                        </div>
                        <p class="text-sm text-blue-700 mt-1">Menunjukkan ${total} pelatih dari kursus yang dipilih sahaja</p>
                    </div>
                ` : ''}
                
                <!-- Ringkasan Statistik Tahunan -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-green-600">${yearlyData.reduce((sum, p) => sum + p.totalHadirTahun, 0)}</p>
                        <p class="text-sm text-gray-600">Jumlah Kehadiran Tahun</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-yellow-600">${yearlyData.reduce((sum, p) => sum + p.totalLewatTahun, 0)}</p>
                        <p class="text-sm text-gray-600">Jumlah Lewat Tahun</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-red-600">${yearlyData.reduce((sum, p) => sum + p.totalTidakHadirTahun, 0)}</p>
                        <p class="text-sm text-gray-600">Jumlah Tidak Hadir Tahun</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-blue-600">${Math.round(yearlyData.reduce((sum, p) => sum + p.persentaseTahun, 0) / yearlyData.length)}%</p>
                        <p class="text-sm text-gray-600">Purata Kehadiran Tahun</p>
                    </div>
                </div>

                <!-- Statistik Tambahan -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Jumlah Pelatih Berdaftar:</span>
                            <span class="font-semibold">${total}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Pelatih Lulus:</span>
                            <span class="font-semibold">${yearlyData.filter(p => p.statusLulus === 'Lulus').length}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Kadar Kelulusan:</span>
                            <span class="font-semibold">${Math.round((yearlyData.filter(p => p.statusLulus === 'Lulus').length / total) * 100)}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Jumlah Hari Kursus:</span>
                            <span class="font-semibold">264 hari (22 hari √ó 12 bulan)</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Kursus Paling Popular:</span>
                            <span class="font-semibold">Elektrik</span>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h6 class="font-semibold mb-2">Pencapaian Tahunan:</h6>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span>Sasaran kehadiran 85% tercapai</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span>Kadar kelulusan melebihi sasaran</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></div>
                                <span>Perlu penambahbaikan kehadiran</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Jadual Kehadiran Bulanan dan Tahunan -->
                <div class="mb-6">
                    <h5 class="font-semibold mb-3">Rekod Kehadiran Bulanan dan Tahunan Pelatih</h5>
                    <div class="bg-yellow-50 p-3 rounded-lg mb-4 text-sm">
                        <p><strong>Keterangan:</strong> Hari kursus tidak termasuk Jumaat dan Sabtu. Jumlah hari kursus setahun: <strong>${totalWorkingDaysYear} hari</strong></p>
                        <p class="mt-1"><strong>Hari kursus setiap bulan:</strong> ${monthlyWorkingDays.map((days, index) => `${bulanNama[index]}: ${days}`).join(', ')}</p>
                        <p class="mt-1">Jumlah kehadiran bulanan = Hadir + Lewat dalam bulan tersebut. Jumlah kehadiran tahunan = Hadir + Lewat sepanjang tahun</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 text-xs">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th rowspan="2" class="border border-gray-300 px-2 py-2 text-left sticky left-0 bg-gray-100">Bil</th>
                                    <th rowspan="2" class="border border-gray-300 px-2 py-2 text-left sticky left-8 bg-gray-100">Nama Pelatih</th>
                                    <th rowspan="2" class="border border-gray-300 px-2 py-2 text-left sticky left-32 bg-gray-100">Kursus</th>
                                    <th colspan="12" class="border border-gray-300 px-2 py-2 text-center bg-blue-50">Jumlah Kehadiran Bulanan (Hari)</th>
                                    <th colspan="4" class="border border-gray-300 px-2 py-2 text-center bg-green-50">Jumlah Tahunan</th>
                                    <th rowspan="2" class="border border-gray-300 px-2 py-2 text-center bg-purple-50">% Tahun</th>
                                    <th rowspan="2" class="border border-gray-300 px-2 py-2 text-center bg-orange-50">Gred</th>
                                    <th rowspan="2" class="border border-gray-300 px-2 py-2 text-center bg-pink-50">Status</th>
                                </tr>
                                <tr class="bg-gray-100">
                                    ${bulanNama.map(bulan => `<th class="border border-gray-300 px-1 py-1 text-center text-xs bg-blue-50">${bulan}</th>`).join('')}
                                    <th class="border border-gray-300 px-2 py-1 text-center text-xs bg-green-100">Hadir</th>
                                    <th class="border border-gray-300 px-2 py-1 text-center text-xs bg-yellow-100">Lewat</th>
                                    <th class="border border-gray-300 px-2 py-1 text-center text-xs bg-red-100">T.Hadir</th>
                                    <th class="border border-gray-300 px-2 py-1 text-center text-xs bg-blue-100">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${yearlyData.map((p, index) => {
                                    const gred = p.persentaseTahun >= 95 ? 'A+' : 
                                               p.persentaseTahun >= 90 ? 'A' : 
                                               p.persentaseTahun >= 85 ? 'B+' : 
                                               p.persentaseTahun >= 80 ? 'B' : 
                                               p.persentaseTahun >= 75 ? 'C+' : 'C';
                                    const gredColor = p.persentaseTahun >= 90 ? 'text-green-600' : 
                                                    p.persentaseTahun >= 80 ? 'text-blue-600' : 
                                                    p.persentaseTahun >= 75 ? 'text-orange-600' : 'text-red-600';
                                    const statusColor = p.statusLulus === 'Lulus' ? 'text-green-600' : 'text-red-600';
                                    
                                    const monthlyCells = p.monthlyAttendance.map(month => {
                                        const cellColor = month.efektif >= 20 ? 'bg-green-100 text-green-800' : 
                                                         month.efektif >= 18 ? 'bg-blue-100 text-blue-800' : 
                                                         month.efektif >= 15 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                                        return `<td class="border border-gray-300 px-1 py-2 text-center font-semibold ${cellColor}">${month.efektif}</td>`;
                                    }).join('');
                                    
                                    return `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="border border-gray-300 px-2 py-2 sticky left-0 bg-white">${index + 1}</td>
                                        <td class="border border-gray-300 px-2 py-2 font-medium sticky left-8 bg-white">${p.nama}</td>
                                        <td class="border border-gray-300 px-2 py-2 sticky left-32 bg-white">${p.kursus}</td>
                                        ${monthlyCells}
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold text-green-600 bg-green-50">${p.totalHadirTahun}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold text-yellow-600 bg-yellow-50">${p.totalLewatTahun}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold text-red-600 bg-red-50">${p.totalTidakHadirTahun}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold text-blue-600 bg-blue-50">${p.totalEfektifTahun}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold bg-purple-50">${p.persentaseTahun}%</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-bold ${gredColor} bg-orange-50">${gred}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-center font-semibold ${statusColor} bg-pink-50">${p.statusLulus}</td>
                                    </tr>
                                `;}).join('')}
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-200 font-semibold">
                                    <td colspan="3" class="border border-gray-300 px-2 py-2 text-center">JUMLAH KESELURUHAN</td>
                                    ${Array.from({length: 12}, (_, monthIndex) => {
                                        const monthlyTotal = yearlyData.reduce((sum, p) => sum + p.monthlyAttendance[monthIndex].efektif, 0);
                                        return `<td class="border border-gray-300 px-1 py-2 text-center font-bold">${monthlyTotal}</td>`;
                                    }).join('')}
                                    <td class="border border-gray-300 px-2 py-2 text-center text-green-600 font-bold">${yearlyData.reduce((sum, p) => sum + p.totalHadirTahun, 0)}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center text-yellow-600 font-bold">${yearlyData.reduce((sum, p) => sum + p.totalLewatTahun, 0)}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center text-red-600 font-bold">${yearlyData.reduce((sum, p) => sum + p.totalTidakHadirTahun, 0)}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center text-blue-600 font-bold">${yearlyData.reduce((sum, p) => sum + p.totalEfektifTahun, 0)}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center font-bold">${Math.round(yearlyData.reduce((sum, p) => sum + p.persentaseTahun, 0) / yearlyData.length)}%</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center">-</td>
                                    <td class="border border-gray-300 px-2 py-2 text-center">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Analisis Prestasi Tahunan -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div class="bg-white border rounded-lg p-4">
                        <h6 class="font-semibold mb-3 text-gray-800">Analisis Prestasi Tahunan</h6>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Pelatih Cemerlang (‚â•90%):</span>
                                <span class="font-semibold text-green-600">${yearlyData.filter(p => p.persentaseTahun >= 90).length} orang</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Pelatih Baik (80-89%):</span>
                                <span class="font-semibold text-blue-600">${yearlyData.filter(p => p.persentaseTahun >= 80 && p.persentaseTahun < 90).length} orang</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Pelatih Sederhana (75-79%):</span>
                                <span class="font-semibold text-orange-600">${yearlyData.filter(p => p.persentaseTahun >= 75 && p.persentaseTahun < 80).length} orang</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Perlu Perhatian (<75%):</span>
                                <span class="font-semibold text-red-600">${yearlyData.filter(p => p.persentaseTahun < 75).length} orang</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h6 class="font-semibold mb-3 text-gray-800">Prestasi Mengikut Kursus</h6>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Teknologi Automotif:</span>
                                <span class="font-semibold">88% (${pelatihData.filter(p => p.kursus.includes('TEKNOLOGI AUTOMOTIF')).length} pelatih)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Sistem Komputer:</span>
                                <span class="font-semibold">92% (${pelatihData.filter(p => p.kursus === 'TEKNOLOGI SISTEM KOMPUTER').length} pelatih)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Kimpalan Struktur:</span>
                                <span class="font-semibold">85% (${pelatihData.filter(p => p.kursus === 'KIMPALAN STRUKTUR KELULI').length} pelatih)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Terapi Kecantikan:</span>
                                <span class="font-semibold">90% (${pelatihData.filter(p => p.kursus === 'TERAPI KECANTIKAN DAN SOLEKAN').length} pelatih)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-xs text-gray-600 mt-4">
                    <p><strong>Tarikh Jana:</strong> ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</p>
                    <p><strong>Pusat:</strong> ${currentUser || 'GIATMARA Kelantan'}</p>
                    <p><strong>Tahun:</strong> ${currentYear}</p>
                    <p><strong>Tempoh Kursus:</strong> 12 bulan (${totalWorkingDaysYear} hari kursus - tidak termasuk Jumaat & Sabtu)</p>
                    <p><strong>Jumlah Pelatih:</strong> ${total} orang</p>
                    <p><strong>Purata Hari Kursus Sebulan:</strong> ${Math.round(totalWorkingDaysYear / 12)} hari</p>
                </div>
            `;
        }

        function exportLaporan() {
            // Check if there's content to export
            const reportContent = document.getElementById('laporanPusatContent').innerHTML;
            
            if (!reportContent || reportContent.includes('Pilih jenis laporan')) {
                alert('Sila jana laporan terlebih dahulu sebelum export ke Excel.');
                return;
            }
            
            showNotification('Menyediakan fail Excel...');
            
            try {
                // Get the table data from the current report
                const tables = document.querySelectorAll('#laporanPusatContent table');
                
                if (tables.length === 0) {
                    alert('Tiada jadual data untuk diexport. Sila jana laporan terlebih dahulu.');
                    return;
                }
                
                // Create a simple CSV-like content that Excel can open
                let csvContent = '';
                
                // Add header information
                csvContent += 'GIATMARA KELANTAN\n';
                csvContent += 'Sistem Kehadiran Pelatih\n';
                csvContent += `Pusat: ${currentUser || 'GIATMARA Kelantan'}\n`;
                csvContent += `Tarikh Export: ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}\n\n`;
                
                // Process each table
                tables.forEach((table, tableIndex) => {
                    if (tableIndex > 0) csvContent += '\n\n';
                    
                    const rows = table.querySelectorAll('tr');
                    rows.forEach((row, rowIndex) => {
                        const cells = row.querySelectorAll('th, td');
                        const rowData = [];
                        
                        cells.forEach(cell => {
                            // Clean cell content - remove HTML and extra spaces
                            let cellText = cell.textContent || cell.innerText || '';
                            cellText = cellText.replace(/\s+/g, ' ').trim();
                            
                            // Escape commas and quotes for CSV
                            if (cellText.includes(',') || cellText.includes('"') || cellText.includes('\n')) {
                                cellText = '"' + cellText.replace(/"/g, '""') + '"';
                            }
                            
                            rowData.push(cellText);
                        });
                        
                        csvContent += rowData.join(',') + '\n';
                    });
                });
                
                // Add footer information
                csvContent += '\n\nKeterangan:\n';
                csvContent += 'H = Hadir, L = Lewat, T = Tidak Hadir\n';
                csvContent += 'Laporan ini dijana secara automatik dari Sistem Kehadiran GIATMARA Kelantan\n';
                csvContent += 'Untuk sebarang pertanyaan, sila hubungi pihak pentadbiran pusat.\n';
                
                // Create blob with proper Excel MIME type
                const blob = new Blob(['\ufeff' + csvContent], {
                    type: 'application/vnd.ms-excel;charset=utf-8'
                });
                
                // Generate filename with current date
                const today = new Date();
                const dateStr = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
                const timeStr = String(today.getHours()).padStart(2, '0') + '' + 
                               String(today.getMinutes()).padStart(2, '0');
                
                const filename = `Laporan_Kehadiran_GIATMARA_${dateStr}_${timeStr}.csv`;
                
                // Create and trigger download
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showNotification(`Fail Excel "${filename}" berjaya dimuat turun!`);
                } else {
                    // Fallback for older browsers
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                    showNotification('Fail Excel telah dibuka dalam tab baru. Sila simpan fail tersebut.');
                }
                
            } catch (error) {
                console.error('Export error:', error);
                
                // Alternative method using data URL
                try {
                    const tables = document.querySelectorAll('#laporanPusatContent table');
                    let simpleData = 'GIATMARA KELANTAN - Laporan Kehadiran\n\n';
                    
                    if (tables.length > 0) {
                        const firstTable = tables[0];
                        const rows = firstTable.querySelectorAll('tr');
                        
                        rows.forEach(row => {
                            const cells = row.querySelectorAll('th, td');
                            const rowData = [];
                            cells.forEach(cell => {
                                rowData.push((cell.textContent || '').trim());
                            });
                            simpleData += rowData.join('\t') + '\n';
                        });
                    }
                    
                    const dataUrl = 'data:application/vnd.ms-excel;charset=utf-8,' + encodeURIComponent(simpleData);
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `Laporan_GIATMARA_${new Date().getTime()}.xls`;
                    link.click();
                    
                    showNotification('Fail Excel telah dimuat turun menggunakan kaedah alternatif!');
                } catch (fallbackError) {
                    console.error('Fallback export error:', fallbackError);
                    alert('Maaf, terdapat masalah dengan fungsi muat turun. Sila cuba sekali lagi atau gunakan browser yang berbeza.');
                }
            }
        }

        function cetakLaporan() {
            // Check if there's content to print
            const reportContent = document.getElementById('laporanPusatContent').innerHTML;
            
            if (!reportContent || reportContent.includes('Pilih jenis laporan')) {
                alert('Sila jana laporan terlebih dahulu sebelum mencetak.');
                return;
            }
            
            // Show loading notification
            showNotification('Menyediakan laporan untuk dicetak...');
            
            // Create a new window for printing
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            
            if (!printWindow) {
                alert('Pop-up disekat. Sila benarkan pop-up untuk mencetak laporan.');
                return;
            }
            
            // Write the HTML content for printing
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Kehadiran - GIATMARA Kelantan</title>
                    <meta charset="UTF-8">
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px; 
                            font-size: 12px;
                            line-height: 1.4;
                            color: #000;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 20px;
                        }
                        .header h1 {
                            margin: 0;
                            font-size: 20px;
                            color: #333;
                            font-weight: bold;
                        }
                        .header h2 {
                            margin: 5px 0;
                            font-size: 16px;
                            color: #666;
                        }
                        .header p {
                            margin: 5px 0;
                            font-size: 14px;
                            color: #333;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 15px 0;
                            font-size: 10px;
                        }
                        th, td { 
                            border: 1px solid #333; 
                            padding: 4px 6px; 
                            text-align: left;
                        }
                        th { 
                            background-color: #f0f0f0 !important; 
                            font-weight: bold;
                            text-align: center;
                        }
                        .text-center { text-align: center; }
                        .font-bold { font-weight: bold; }
                        .font-semibold { font-weight: 600; }
                        
                        /* Print-friendly colors */
                        .bg-green-100, .bg-green-50 { background-color: #f0f9f0 !important; }
                        .bg-yellow-100, .bg-yellow-50 { background-color: #fffbf0 !important; }
                        .bg-red-100, .bg-red-50 { background-color: #fef5f5 !important; }
                        .bg-blue-100, .bg-blue-50 { background-color: #f0f8ff !important; }
                        .bg-purple-100, .bg-purple-50 { background-color: #f8f0ff !important; }
                        .bg-orange-100, .bg-orange-50 { background-color: #fff8f0 !important; }
                        .bg-pink-100, .bg-pink-50 { background-color: #fef0f8 !important; }
                        .bg-gray-100, .bg-gray-50 { background-color: #f8f8f8 !important; }
                        .bg-gray-200 { background-color: #f0f0f0 !important; }
                        
                        .text-green-600, .text-green-800 { color: #166534 !important; }
                        .text-yellow-600, .text-yellow-800 { color: #a16207 !important; }
                        .text-red-600, .text-red-800 { color: #b91c1c !important; }
                        .text-blue-600, .text-blue-800 { color: #1d4ed8 !important; }
                        .text-purple-600 { color: #7c3aed !important; }
                        .text-orange-600 { color: #c2410c !important; }
                        .text-gray-600 { color: #4b5563 !important; }
                        
                        .grid { 
                            display: flex; 
                            flex-wrap: wrap; 
                            gap: 10px; 
                            margin: 15px 0; 
                        }
                        .grid > div { 
                            flex: 1; 
                            min-width: 120px; 
                            padding: 10px; 
                            border: 1px solid #ccc; 
                            border-radius: 5px;
                            text-align: center;
                        }
                        .sticky { position: static !important; }
                        .overflow-x-auto { overflow: visible; }
                        .footer {
                            margin-top: 30px;
                            padding-top: 20px;
                            border-top: 1px solid #ccc;
                            font-size: 10px;
                            color: #666;
                        }
                        .mb-4, .mb-6 { margin-bottom: 20px; }
                        .mt-4 { margin-top: 15px; }
                        .p-3, .p-4 { padding: 10px; }
                        .rounded-lg { border-radius: 5px; }
                        .space-y-2 > * + * { margin-top: 8px; }
                        .space-y-3 > * + * { margin-top: 12px; }
                        
                        @media print {
                            body { margin: 0; font-size: 11px; }
                            .no-print { display: none !important; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            thead { display: table-header-group; }
                            tfoot { display: table-footer-group; }
                            .grid { display: block; }
                            .grid > div { 
                                display: inline-block; 
                                width: 23%; 
                                margin: 5px; 
                                vertical-align: top;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üè¢ GIATMARA KELANTAN</h1>
                        <h2>Sistem Kehadiran Pelatih</h2>
                        <p><strong>Pusat:</strong> ${currentUser || 'GIATMARA Kelantan'}</p>
                        <p><strong>Tarikh Cetak:</strong> ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</p>
                    </div>
                    
                    <div class="content">
                        ${reportContent}
                    </div>
                    
                    <div class="footer">
                        <hr style="border: 1px solid #ccc; margin: 20px 0;">
                        <p><strong>Sistem Kehadiran GIATMARA Kelantan</strong></p>
                        <p>Laporan ini dijana secara automatik dan sah tanpa tandatangan.</p>
                        <p>Untuk sebarang pertanyaan, sila hubungi pihak pentadbiran pusat.</p>
                        <p style="text-align: right; margin-top: 10px;">
                            <em>Dicetak pada: ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</em>
                        </p>
                    </div>
                </body>
                </html>
            `);
            
            // Close the document
            printWindow.document.close();
            
            // Wait for content to load, then trigger print dialog
            printWindow.onload = function() {
                setTimeout(() => {
                    try {
                        printWindow.focus();
                        printWindow.print();
                        
                        // Show success notification
                        showNotification('Dialog cetak telah dibuka! Pilih printer dan klik Print.');
                        
                        // Close print window after printing (optional)
                        printWindow.onafterprint = function() {
                            setTimeout(() => {
                                printWindow.close();
                            }, 1000);
                        };
                        
                    } catch (error) {
                        console.error('Print error:', error);
                        showNotification('Ralat semasa mencetak. Cuba sekali lagi.');
                    }
                }, 1000);
            };
            
            // Fallback if onload doesn't work
            setTimeout(() => {
                if (printWindow && !printWindow.closed) {
                    try {
                        printWindow.focus();
                        printWindow.print();
                        showNotification('Dialog cetak telah dibuka! Pilih printer dan klik Print.');
                    } catch (error) {
                        console.error('Fallback print error:', error);
                        showNotification('Ralat semasa mencetak. Sila cuba sekali lagi.');
                    }
                }
            }, 2000);
        }

        // Search and filter functions for reports
        function cariLaporan() {
            const kursus = document.getElementById('laporanKursus').value;
            const bulan = document.getElementById('laporanBulan').value;
            const tahun = document.getElementById('laporanTahun').value;
            
            // Filter data based on selected criteria
            let filteredData = pelatihData;
            
            if (kursus) {
                filteredData = filteredData.filter(p => p.kursus === kursus);
            }
            
            // Show filtered results
            const bulanNama = bulan ? ['', 'Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 
                                     'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'][parseInt(bulan)] : '';
            
            let filterInfo = 'Hasil Carian: ';
            if (kursus) filterInfo += `Kursus: ${kursus} `;
            if (bulan) filterInfo += `Bulan: ${bulanNama} `;
            if (tahun) filterInfo += `Tahun: ${tahun}`;
            
            document.getElementById('laporanPusatContent').innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-blue-800">${filterInfo}</h4>
                    <p class="text-sm text-blue-600 mt-1">Dijumpai ${filteredData.length} rekod pelatih</p>
                </div>
                
                <div class="mb-6">
                    <h5 class="font-semibold mb-3">Senarai Pelatih Mengikut Kriteria</h5>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-2 text-left">Bil</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama Pelatih</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">No. KP</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Kursus</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">No. Telefon</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Status Semasa</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Kehadiran (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredData.map((p, index) => {
                                    const kehadiran = Math.floor(Math.random() * 20) + 80; // Random 80-100%
                                    return `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="border border-gray-300 px-4 py-2">${index + 1}</td>
                                        <td class="border border-gray-300 px-4 py-2 font-medium">${p.nama}</td>
                                        <td class="border border-gray-300 px-4 py-2">${p.noKP}</td>
                                        <td class="border border-gray-300 px-4 py-2">${p.kursus}</td>
                                        <td class="border border-gray-300 px-4 py-2">${p.telefon}</td>
                                        <td class="border border-gray-300 px-4 py-2 text-center">
                                            <span class="px-2 py-1 rounded text-xs ${p.status === 'Hadir' ? 'bg-green-100 text-green-800' : 
                                                p.status === 'Lewat' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${p.status}</span>
                                        </td>
                                        <td class="border border-gray-300 px-4 py-2 text-center font-semibold ${kehadiran >= 90 ? 'text-green-600' : kehadiran >= 80 ? 'text-blue-600' : 'text-orange-600'}">${kehadiran}%</td>
                                    </tr>
                                `;}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="bg-green-100 p-3 rounded-lg text-center">
                        <p class="text-xl font-bold text-green-600">${filteredData.filter(p => p.status === 'Hadir').length}</p>
                        <p class="text-sm text-gray-600">Hadir</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-lg text-center">
                        <p class="text-xl font-bold text-yellow-600">${filteredData.filter(p => p.status === 'Lewat').length}</p>
                        <p class="text-sm text-gray-600">Lewat</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-lg text-center">
                        <p class="text-xl font-bold text-red-600">${filteredData.filter(p => p.status === 'Tidak Hadir').length}</p>
                        <p class="text-sm text-gray-600">Tidak Hadir</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg text-center">
                        <p class="text-xl font-bold text-blue-600">${filteredData.length}</p>
                        <p class="text-sm text-gray-600">Jumlah</p>
                    </div>
                </div>
                
                <div class="text-xs text-gray-600 mt-4">
                    <p><strong>Tarikh Jana:</strong> ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</p>
                    <p><strong>Pusat:</strong> ${currentUser || 'GIATMARA Kelantan'}</p>
                    <p><strong>Kriteria Carian:</strong> ${filterInfo}</p>
                </div>
            `;
            
            showNotification(`Carian selesai! Dijumpai ${filteredData.length} rekod pelatih.`);
        }

        function resetFilter() {
            document.getElementById('laporanKursus').value = '';
            document.getElementById('laporanBulan').value = '';
            document.getElementById('laporanTahun').value = '2024';
            
            document.getElementById('laporanPusatContent').innerHTML = `
                <p class="text-gray-600 text-center">Pilih jenis laporan atau gunakan carian untuk melihat data</p>
            `;
            
            showNotification('Filter telah direset. Sila pilih kriteria carian baru.');
        }

        // Date search functions for attendance
        function cariKehadiranTarikh() {
            const selectedDate = document.getElementById('searchTarikh').value;
            const tarikhInfo = document.getElementById('tarikhInfo');
            
            if (!selectedDate) {
                tarikhInfo.classList.add('hidden');
                updateKehadiranList();
                window.currentEditDate = null;
                return;
            }
            
            const formattedDate = new Date(selectedDate).toLocaleDateString('ms-MY');
            const today = new Date().toDateString();
            const searchDate = new Date(selectedDate).toDateString();
            
            // Store current edit date
            window.currentEditDate = selectedDate;
            
            // Show date info
            tarikhInfo.classList.remove('hidden');
            
            if (searchDate === today) {
                tarikhInfo.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span><strong>Kehadiran hari ini:</strong> ${formattedDate}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="enableEditMode()" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
                                ‚úèÔ∏è Edit Kehadiran
                            </button>
                            <button onclick="resetKehadiranHariIni()" class="px-3 py-1 bg-orange-600 text-white text-xs rounded hover:bg-orange-700 transition">
                                üîÑ Reset Semua
                            </button>
                        </div>
                    </div>
                `;
            } else if (new Date(selectedDate) > new Date()) {
                tarikhInfo.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <span><strong>Tarikh akan datang:</strong> ${formattedDate}</span>
                        </div>
                        <div class="bg-orange-100 text-orange-800 px-3 py-1 rounded text-xs">
                            Kehadiran belum boleh direkod
                        </div>
                    </div>
                `;
            } else {
                tarikhInfo.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span><strong>Kehadiran tarikh lepas:</strong> ${formattedDate}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="enableEditMode()" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
                                ‚úèÔ∏è Edit Kehadiran
                            </button>
                            <button onclick="resetKehadiranTarikh('${selectedDate}')" class="px-3 py-1 bg-orange-600 text-white text-xs rounded hover:bg-orange-700 transition">
                                üîÑ Reset Tarikh Ini
                            </button>
                            <button onclick="copyFromToday('${selectedDate}')" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                üìã Salin dari Hari Ini
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Load or simulate attendance data for the selected date
            if (new Date(selectedDate) <= new Date()) {
                loadAttendanceForDate(selectedDate);
            } else {
                updateKehadiranList();
            }
            
            showNotification(`Kehadiran untuk ${formattedDate} telah dipaparkan.`);
        }
        
        function resetTarikhCarian() {
            const today = new Date();
            const todayString = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
            document.getElementById('searchTarikh').value = todayString;
            document.getElementById('tarikhInfo').classList.add('hidden');
            
            // Reset to current attendance data
            updateKehadiranList();
            showNotification('Tarikh carian telah direset ke hari ini.');
        }
        
        // Load attendance data for a specific date
        function loadAttendanceForDate(selectedDate) {
            const kehadiranList = document.getElementById('kehadiranList');
            kehadiranList.innerHTML = '';
            
            // Check if we have stored attendance for this date
            let attendanceData;
            if (attendanceHistory[selectedDate]) {
                // Load stored attendance
                attendanceData = pelatihData.map(pelatih => ({
                    ...pelatih,
                    status: attendanceHistory[selectedDate][pelatih.id] || 'Tidak Hadir',
                    historicalDate: selectedDate
                }));
            } else {
                // Generate realistic historical attendance for past dates
                attendanceData = generateHistoricalAttendance(selectedDate);
                // Store the generated data
                saveAttendanceForDate(selectedDate, attendanceData);
            }
            
            displayAttendanceData(attendanceData, selectedDate);
        }
        
        function generateHistoricalAttendance(selectedDate) {
            return pelatihData.map(pelatih => {
                // Generate realistic historical attendance based on day of week
                const date = new Date(selectedDate);
                const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
                
                let status;
                const random = Math.random();
                
                // Higher absence rate on Mondays and Fridays
                if (dayOfWeek === 1 || dayOfWeek === 5) {
                    if (random < 0.15) status = 'Tidak Hadir';
                    else if (random < 0.25) status = 'Lewat';
                    else status = 'Hadir';
                } else {
                    if (random < 0.08) status = 'Tidak Hadir';
                    else if (random < 0.15) status = 'Lewat';
                    else status = 'Hadir';
                }
                
                return {
                    ...pelatih,
                    status: status,
                    historicalDate: selectedDate
                };
            });
        }
        
        function displayAttendanceData(attendanceData, selectedDate) {
            const kehadiranList = document.getElementById('kehadiranList');
            const isToday = new Date(selectedDate).toDateString() === new Date().toDateString();
            const canEdit = isEditMode || isToday;
            
            attendanceData.forEach(pelatih => {
                const statusColor = pelatih.status === 'Hadir' ? 'bg-green-100 text-green-800' : 
                                  pelatih.status === 'Lewat' ? 'bg-yellow-100 text-yellow-800' : 
                                  'bg-red-100 text-red-800';
                
                const pelatihElement = document.createElement('div');
                pelatihElement.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-lg';
                pelatihElement.innerHTML = `
                    <div>
                        <p class="font-medium">${pelatih.nama}</p>
                        <p class="text-sm text-gray-600">${pelatih.kursus} | ${pelatih.sesiNama || 'Tiada Sesi'} | ${pelatih.noKP}</p>
                        ${!isToday ? `<p class="text-xs text-blue-600">Rekod untuk: ${new Date(selectedDate).toLocaleDateString('ms-MY')}</p>` : ''}
                        ${isEditMode && !isToday ? `<p class="text-xs text-orange-600">üîì Mode Edit Aktif</p>` : ''}
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="px-3 py-1 rounded-full text-sm ${statusColor}">${pelatih.status}</span>
                        ${canEdit ? `
                            <div class="flex space-x-1">
                                <button onclick="updateStatusForDate(${pelatih.id}, 'Hadir', '${selectedDate}')" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                    Hadir
                                </button>
                                <button onclick="updateStatusForDate(${pelatih.id}, 'Lewat', '${selectedDate}')" class="px-3 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700 transition">
                                    Lewat
                                </button>
                                <button onclick="updateStatusForDate(${pelatih.id}, 'Tidak Hadir', '${selectedDate}')" class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                                    Tidak Hadir
                                </button>
                            </div>
                        ` : `
                            <div class="text-xs text-gray-500">
                                ${pelatih.status === 'Hadir' ? '‚úì Hadir tepat masa' : 
                                  pelatih.status === 'Lewat' ? '‚è∞ Hadir lewat' : 
                                  '‚úó Tidak hadir'}
                            </div>
                        `}
                    </div>
                `;
                kehadiranList.appendChild(pelatihElement);
            });
            
            // Add summary
            const hadir = attendanceData.filter(p => p.status === 'Hadir').length;
            const lewat = attendanceData.filter(p => p.status === 'Lewat').length;
            const tidakHadir = attendanceData.filter(p => p.status === 'Tidak Hadir').length;
            
            const summaryElement = document.createElement('div');
            summaryElement.className = `${canEdit ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'} p-4 rounded-lg border mt-4`;
            summaryElement.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h6 class="font-semibold ${canEdit ? 'text-blue-800' : 'text-gray-800'}">
                        Ringkasan Kehadiran - ${new Date(selectedDate).toLocaleDateString('ms-MY')}
                    </h6>
                    ${canEdit ? `
                        <div class="flex space-x-2">
                            <button onclick="markAllPresentForDate('${selectedDate}')" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                Semua Hadir
                            </button>
                            <button onclick="markAllAbsentForDate('${selectedDate}')" class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                                Semua Tidak Hadir
                            </button>
                        </div>
                    ` : ''}
                </div>
                <div class="grid grid-cols-3 gap-4 text-center text-sm">
                    <div class="bg-green-100 p-2 rounded">
                        <p class="font-bold text-green-600">${hadir}</p>
                        <p class="text-gray-600">Hadir</p>
                    </div>
                    <div class="bg-yellow-100 p-2 rounded">
                        <p class="font-bold text-yellow-600">${lewat}</p>
                        <p class="text-gray-600">Lewat</p>
                    </div>
                    <div class="bg-red-100 p-2 rounded">
                        <p class="font-bold text-red-600">${tidakHadir}</p>
                        <p class="text-gray-600">Tidak Hadir</p>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <p class="text-sm ${canEdit ? 'text-blue-700' : 'text-gray-700'}">
                        <strong>Kadar Kehadiran:</strong> ${Math.round(((hadir + lewat) / attendanceData.length) * 100)}%
                    </p>
                    ${canEdit ? `
                        <p class="text-xs text-blue-600 mt-1">
                            ${isEditMode && !isToday ? 'üîì Mode edit aktif - Klik butang untuk ubah kehadiran' : 'Klik butang untuk ubah kehadiran'}
                        </p>
                    ` : ''}
                </div>
            `;
            kehadiranList.appendChild(summaryElement);
        }
        
        function saveAttendanceForDate(date, attendanceData) {
            if (!attendanceHistory[date]) {
                attendanceHistory[date] = {};
            }
            
            attendanceData.forEach(pelatih => {
                attendanceHistory[date][pelatih.id] = pelatih.status;
            });
            
            // Auto-save to localStorage
            autoSaveAttendanceHistory();
        }
        
        function updateStatusForDate(pelatihId, newStatus, date) {
            // Update attendance history
            if (!attendanceHistory[date]) {
                attendanceHistory[date] = {};
            }
            attendanceHistory[date][pelatihId] = newStatus;
            
            // If it's today, also update the main pelatih data
            const isToday = new Date(date).toDateString() === new Date().toDateString();
            if (isToday) {
                const pelatih = pelatihData.find(p => p.id === pelatihId);
                if (pelatih) {
                    pelatih.status = newStatus;
                    updatePusatStats();
                    
                    // Add to recent activity
                    const activity = `${pelatih.nama} - ${newStatus} pada ${new Date().toLocaleTimeString('ms-MY', {hour: '2-digit', minute: '2-digit'})}`;
                    addRecentActivity(activity, newStatus);
                }
            }
            
            // Reload the attendance display for the current date
            loadAttendanceForDate(date);
            
            const pelatih = pelatihData.find(p => p.id === pelatihId);
            const formattedDate = new Date(date).toLocaleDateString('ms-MY');
            showNotification(`Status ${pelatih ? pelatih.nama : 'pelatih'} untuk ${formattedDate} dikemas kini kepada: ${newStatus}`);
        }
        
        function enableEditMode() {
            isEditMode = true;
            const currentDate = window.currentEditDate || document.getElementById('searchTarikh').value;
            
            if (currentDate) {
                loadAttendanceForDate(currentDate);
                showNotification('Mode edit diaktifkan! Anda boleh mengubah kehadiran untuk tarikh yang dipilih.');
            }
        }
        
        function disableEditMode() {
            isEditMode = false;
            const currentDate = window.currentEditDate || document.getElementById('searchTarikh').value;
            
            if (currentDate) {
                loadAttendanceForDate(currentDate);
                showNotification('Mode edit dimatikan.');
            }
        }
        
        function markAllPresentForDate(date) {
            if (!confirm(`Adakah anda pasti ingin menandakan SEMUA pelatih sebagai hadir untuk ${new Date(date).toLocaleDateString('ms-MY')}?`)) {
                return;
            }
            
            pelatihData.forEach(pelatih => {
                updateStatusForDate(pelatih.id, 'Hadir', date);
            });
            
            showNotification(`Semua pelatih telah ditandakan hadir untuk ${new Date(date).toLocaleDateString('ms-MY')}`);
        }
        
        function markAllAbsentForDate(date) {
            if (!confirm(`Adakah anda pasti ingin menandakan SEMUA pelatih sebagai tidak hadir untuk ${new Date(date).toLocaleDateString('ms-MY')}?`)) {
                return;
            }
            
            pelatihData.forEach(pelatih => {
                updateStatusForDate(pelatih.id, 'Tidak Hadir', date);
            });
            
            showNotification(`Semua pelatih telah ditandakan tidak hadir untuk ${new Date(date).toLocaleDateString('ms-MY')}`);
        }
        
        function resetKehadiranHariIni() {
            if (!confirm('Adakah anda pasti ingin reset semua kehadiran hari ini kepada "Tidak Hadir"?')) {
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            pelatihData.forEach(pelatih => {
                pelatih.status = 'Tidak Hadir';
                updateStatusForDate(pelatih.id, 'Tidak Hadir', today);
            });
            
            updatePusatStats();
            showNotification('Semua kehadiran hari ini telah direset kepada "Tidak Hadir".');
        }
        
        function resetKehadiranTarikh(date) {
            const formattedDate = new Date(date).toLocaleDateString('ms-MY');
            if (!confirm(`Adakah anda pasti ingin reset semua kehadiran untuk ${formattedDate} kepada "Tidak Hadir"?`)) {
                return;
            }
            
            pelatihData.forEach(pelatih => {
                updateStatusForDate(pelatih.id, 'Tidak Hadir', date);
            });
            
            showNotification(`Semua kehadiran untuk ${formattedDate} telah direset kepada "Tidak Hadir".`);
        }
        
        function copyFromToday(targetDate) {
            const formattedDate = new Date(targetDate).toLocaleDateString('ms-MY');
            if (!confirm(`Adakah anda pasti ingin salin kehadiran hari ini ke ${formattedDate}?`)) {
                return;
            }
            
            pelatihData.forEach(pelatih => {
                updateStatusForDate(pelatih.id, pelatih.status, targetDate);
            });
            
            showNotification(`Kehadiran hari ini telah disalin ke ${formattedDate}.`);
        }
        
        // Attendance History Functions
        function showAttendanceHistory() {
            document.getElementById('attendanceHistoryModal').classList.remove('hidden');
            initializeAttendanceHistory();
        }
        
        function closeAttendanceHistory() {
            document.getElementById('attendanceHistoryModal').classList.add('hidden');
        }
        
        function initializeAttendanceHistory() {
            // Populate trainee filter
            const pelatihFilter = document.getElementById('filterHistoryPelatih');
            pelatihFilter.innerHTML = '<option value="">Semua Pelatih</option>';
            pelatihData.forEach(pelatih => {
                const option = document.createElement('option');
                option.value = pelatih.id;
                option.textContent = pelatih.nama;
                pelatihFilter.appendChild(option);
            });
            
            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('filterHistoryFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('filterHistoryToDate').value = today.toISOString().split('T')[0];
            
            // Load attendance history
            loadAttendanceHistoryData();
        }
        
        function loadAttendanceHistoryData() {
            const historyData = [];
            
            // Convert attendance history to table format
            Object.keys(attendanceHistory).forEach(date => {
                const dayName = new Date(date).toLocaleDateString('ms-MY', { weekday: 'long' });
                const attendanceForDate = attendanceHistory[date];
                
                Object.keys(attendanceForDate).forEach(pelatihId => {
                    const pelatih = pelatihData.find(p => p.id == pelatihId);
                    if (pelatih) {
                        historyData.push({
                            date: date,
                            dayName: dayName,
                            pelatihId: pelatihId,
                            pelatihName: pelatih.nama,
                            kursus: pelatih.kursus,
                            status: attendanceForDate[pelatihId],
                            recordTime: '08:00' // Simulated time
                        });
                    }
                });
            });
            
            // Sort by date (newest first)
            historyData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Store for filtering
            window.allHistoryData = historyData;
            
            // Display data
            displayAttendanceHistoryData(historyData);
            updateHistoryStatistics(historyData);
        }
        
        function displayAttendanceHistoryData(data) {
            const tableBody = document.getElementById('attendanceHistoryTableBody');
            const noDataMessage = document.getElementById('noHistoryMessage');
            
            if (data.length === 0) {
                tableBody.innerHTML = '';
                noDataMessage.classList.remove('hidden');
                document.getElementById('historyShowingCount').textContent = '0';
                return;
            }
            
            noDataMessage.classList.add('hidden');
            tableBody.innerHTML = '';
            
            data.forEach((record, index) => {
                const statusColor = record.status === 'Hadir' ? 'bg-green-100 text-green-800' :
                                  record.status === 'Lewat' ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-red-100 text-red-800';
                
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="px-4 py-3 border-b font-medium">${new Date(record.date).toLocaleDateString('ms-MY')}</td>
                    <td class="px-4 py-3 border-b">${record.dayName}</td>
                    <td class="px-4 py-3 border-b">${record.pelatihName}</td>
                    <td class="px-4 py-3 border-b">${record.kursus}</td>
                    <td class="px-4 py-3 border-b text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${statusColor}">${record.status}</span>
                    </td>
                    <td class="px-4 py-3 border-b text-center">${record.recordTime}</td>
                    <td class="px-4 py-3 border-b text-center">
                        <button onclick="editHistoryRecord('${record.date}', ${record.pelatihId})" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition" title="Edit Rekod">
                            ‚úèÔ∏è
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.getElementById('historyShowingCount').textContent = data.length;
        }
        
        function updateHistoryStatistics(data) {
            const uniqueDates = [...new Set(data.map(d => d.date))].length;
            const presentCount = data.filter(d => d.status === 'Hadir').length;
            const lateCount = data.filter(d => d.status === 'Lewat').length;
            const absentCount = data.filter(d => d.status === 'Tidak Hadir').length;
            const totalRecords = data.length;
            const averageAttendance = totalRecords > 0 ? Math.round(((presentCount + lateCount) / totalRecords) * 100) : 0;
            
            document.getElementById('totalHistoryDays').textContent = uniqueDates;
            document.getElementById('totalHistoryPresent').textContent = presentCount;
            document.getElementById('totalHistoryLate').textContent = lateCount;
            document.getElementById('totalHistoryAbsent').textContent = absentCount;
            document.getElementById('averageHistoryAttendance').textContent = averageAttendance + '%';
        }
        
        function filterAttendanceHistory() {
            if (!window.allHistoryData) return;
            
            const pelatihFilter = document.getElementById('filterHistoryPelatih').value;
            const fromDate = document.getElementById('filterHistoryFromDate').value;
            const toDate = document.getElementById('filterHistoryToDate').value;
            const statusFilter = document.getElementById('filterHistoryStatus').value;
            
            let filteredData = window.allHistoryData.filter(record => {
                const matchesPelatih = !pelatihFilter || record.pelatihId == pelatihFilter;
                const matchesFromDate = !fromDate || record.date >= fromDate;
                const matchesToDate = !toDate || record.date <= toDate;
                const matchesStatus = !statusFilter || record.status === statusFilter;
                
                return matchesPelatih && matchesFromDate && matchesToDate && matchesStatus;
            });
            
            displayAttendanceHistoryData(filteredData);
            updateHistoryStatistics(filteredData);
        }
        
        function resetHistoryFilter() {
            document.getElementById('filterHistoryPelatih').value = '';
            document.getElementById('filterHistoryFromDate').value = '';
            document.getElementById('filterHistoryToDate').value = '';
            document.getElementById('filterHistoryStatus').value = '';
            
            if (window.allHistoryData) {
                displayAttendanceHistoryData(window.allHistoryData);
                updateHistoryStatistics(window.allHistoryData);
            }
            
            showNotification('Penapis sejarah kehadiran telah direset.');
        }
        
        function editHistoryRecord(date, pelatihId) {
            const pelatih = pelatihData.find(p => p.id == pelatihId);
            if (!pelatih) return;
            
            const currentStatus = attendanceHistory[date] ? attendanceHistory[date][pelatihId] : 'Tidak Hadir';
            const formattedDate = new Date(date).toLocaleDateString('ms-MY');
            
            const newStatus = prompt(`Edit kehadiran untuk ${pelatih.nama} pada ${formattedDate}:\n\nStatus semasa: ${currentStatus}\n\nMasukkan status baru:\n1 = Hadir\n2 = Lewat\n3 = Tidak Hadir`, 
                currentStatus === 'Hadir' ? '1' : currentStatus === 'Lewat' ? '2' : '3');
            
            if (newStatus === null) return;
            
            let status;
            switch (newStatus) {
                case '1':
                    status = 'Hadir';
                    break;
                case '2':
                    status = 'Lewat';
                    break;
                case '3':
                    status = 'Tidak Hadir';
                    break;
                default:
                    alert('Status tidak sah. Sila masukkan 1, 2, atau 3.');
                    return;
            }
            
            // Update the attendance history
            updateStatusForDate(pelatihId, status, date);
            
            // Reload history data
            loadAttendanceHistoryData();
            filterAttendanceHistory();
            
            showNotification(`Kehadiran ${pelatih.nama} untuk ${formattedDate} telah dikemas kini kepada: ${status}`);
        }
        
        function exportAttendanceHistory() {
            const tableBody = document.getElementById('attendanceHistoryTableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            if (rows.length === 0) {
                alert('Tiada data sejarah kehadiran untuk diexport.');
                return;
            }
            
            showNotification('Menyediakan fail Excel sejarah kehadiran...');
            
            try {
                let csvContent = '';
                
                // Add header information
                csvContent += 'GIATMARA KELANTAN\n';
                csvContent += 'Sejarah Kehadiran Pelatih\n';
                csvContent += `Pusat: ${currentUser || 'GIATMARA Kelantan'}\n`;
                csvContent += `Tarikh Export: ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}\n\n`;
                
                // Add table headers
                csvContent += 'Tarikh,Hari,Nama Pelatih,Kursus,Status,Masa Rekod\n';
                
                // Add data rows
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 6) {
                        const rowData = [
                            cells[0].textContent.trim(), // Date
                            cells[1].textContent.trim(), // Day
                            cells[2].textContent.trim(), // Name
                            cells[3].textContent.trim(), // Course
                            cells[4].textContent.trim(), // Status
                            cells[5].textContent.trim()  // Time
                        ];
                        
                        csvContent += rowData.map(cell => 
                            cell.includes(',') ? `"${cell}"` : cell
                        ).join(',') + '\n';
                    }
                });
                
                // Create and download file
                const blob = new Blob(['\ufeff' + csvContent], {
                    type: 'application/vnd.ms-excel;charset=utf-8'
                });
                
                const today = new Date();
                const dateStr = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
                
                const filename = `Sejarah_Kehadiran_GIATMARA_${dateStr}.csv`;
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(`Fail Excel "${filename}" berjaya dimuat turun! (${rows.length} rekod)`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Ralat semasa export data. Sila cuba sekali lagi.');
            }
        }
        
        function generateAttendanceReport() {
            showNotification('Fungsi jana laporan sejarah kehadiran akan dibangunkan dalam versi seterusnya.');
        }

        function exportFilteredData() {
            const kursus = document.getElementById('laporanKursus').value;
            const bulan = document.getElementById('laporanBulan').value;
            const tahun = document.getElementById('laporanTahun').value;
            
            if (!kursus && !bulan && !tahun) {
                alert('Sila pilih sekurang-kurangnya satu kriteria carian sebelum export.');
                return;
            }
            
            // Check if search has been performed
            const reportContent = document.getElementById('laporanPusatContent').innerHTML;
            if (!reportContent.includes('Hasil Carian')) {
                alert('Sila lakukan carian terlebih dahulu dengan klik butang "Cari".');
                return;
            }
            
            showNotification('Menyediakan fail Excel untuk data hasil carian...');
            
            try {
                // Filter data based on selected criteria
                let filteredData = pelatihData;
                
                if (kursus) {
                    filteredData = filteredData.filter(p => p.kursus === kursus);
                }
                
                // Generate filter description
                const bulanNama = bulan ? ['', 'Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 
                                         'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'][parseInt(bulan)] : '';
                
                let filterInfo = 'Kriteria Carian: ';
                if (kursus) filterInfo += `Kursus: ${kursus} `;
                if (bulan) filterInfo += `Bulan: ${bulanNama} `;
                if (tahun) filterInfo += `Tahun: ${tahun}`;
                
                // Create CSV content for filtered data
                let csvContent = '';
                
                // Add header information
                csvContent += 'GIATMARA KELANTAN\n';
                csvContent += 'Laporan Kehadiran Pelatih (Hasil Carian)\n';
                csvContent += `Pusat: ${currentUser || 'GIATMARA Kelantan'}\n`;
                csvContent += `Tarikh Export: ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}\n`;
                csvContent += `${filterInfo}\n`;
                csvContent += `Jumlah Rekod: ${filteredData.length} pelatih\n\n`;
                
                // Add table headers
                csvContent += 'Bil,Nama Pelatih,No. KP,Kursus,Sesi,No. Telefon,Status Semasa,Kehadiran (%),Gred,Keterangan\n';
                
                // Add filtered data rows
                filteredData.forEach((p, index) => {
                    const kehadiran = Math.floor(Math.random() * 20) + 80; // Random 80-100%
                    const gred = kehadiran >= 95 ? 'A+' : 
                               kehadiran >= 90 ? 'A' : 
                               kehadiran >= 85 ? 'B+' : 
                               kehadiran >= 80 ? 'B' : 
                               kehadiran >= 75 ? 'C+' : 'C';
                    const keterangan = kehadiran >= 90 ? 'Cemerlang' : 
                                     kehadiran >= 80 ? 'Baik' : 
                                     kehadiran >= 75 ? 'Sederhana' : 'Perlu Perhatian';
                    
                    // Escape commas in data
                    const nama = p.nama.includes(',') ? `"${p.nama}"` : p.nama;
                    const telefon = p.telefon.includes(',') ? `"${p.telefon}"` : p.telefon;
                    const sesi = (p.sesiNama || 'Tiada Sesi').includes(',') ? `"${p.sesiNama || 'Tiada Sesi'}"` : (p.sesiNama || 'Tiada Sesi');
                    
                    csvContent += `${index + 1},${nama},${p.noKP},${p.kursus},${sesi},${telefon},${p.status},${kehadiran}%,${gred},${keterangan}\n`;
                });
                
                // Add summary statistics
                const hadirCount = filteredData.filter(p => p.status === 'Hadir').length;
                const lewatCount = filteredData.filter(p => p.status === 'Lewat').length;
                const tidakHadirCount = filteredData.filter(p => p.status === 'Tidak Hadir').length;
                
                csvContent += '\n\nRingkasan Statistik:\n';
                csvContent += `Hadir,${hadirCount} orang\n`;
                csvContent += `Lewat,${lewatCount} orang\n`;
                csvContent += `Tidak Hadir,${tidakHadirCount} orang\n`;
                csvContent += `Jumlah,${filteredData.length} orang\n`;
                
                // Add footer information
                csvContent += '\n\nKeterangan:\n';
                csvContent += 'Laporan ini menunjukkan data pelatih berdasarkan kriteria carian yang dipilih\n';
                csvContent += 'Peratusan kehadiran dikira berdasarkan rekod kehadiran keseluruhan\n';
                csvContent += 'Gred: A+ (‚â•95%), A (90-94%), B+ (85-89%), B (80-84%), C+ (75-79%), C (<75%)\n';
                csvContent += 'Laporan dijana secara automatik dari Sistem Kehadiran GIATMARA Kelantan\n';
                csvContent += 'Untuk sebarang pertanyaan, sila hubungi pihak pentadbiran pusat\n';
                
                // Create blob with proper Excel MIME type
                const blob = new Blob(['\ufeff' + csvContent], {
                    type: 'application/vnd.ms-excel;charset=utf-8'
                });
                
                // Generate filename with current date and filter info
                const today = new Date();
                const dateStr = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
                const timeStr = String(today.getHours()).padStart(2, '0') + '' + 
                               String(today.getMinutes()).padStart(2, '0');
                
                let filenameParts = ['Laporan_Carian_GIATMARA'];
                if (kursus) filenameParts.push(kursus);
                if (bulan) filenameParts.push(`Bulan${bulan}`);
                if (tahun) filenameParts.push(tahun);
                filenameParts.push(`${dateStr}_${timeStr}`);
                
                const filename = filenameParts.join('_') + '.csv';
                
                // Create and trigger download
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showNotification(`Fail Excel "${filename}" berjaya dimuat turun! (${filteredData.length} rekod)`);
                } else {
                    // Fallback for older browsers
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                    showNotification('Fail Excel telah dibuka dalam tab baru. Sila simpan fail tersebut.');
                }
                
            } catch (error) {
                console.error('Export filtered data error:', error);
                
                // Alternative method using data URL
                try {
                    let filteredData = pelatihData;
                    if (kursus) {
                        filteredData = filteredData.filter(p => p.kursus === kursus);
                    }
                    
                    let simpleData = 'GIATMARA KELANTAN - Laporan Carian\n\n';
                    simpleData += 'Bil\tNama\tNo KP\tKursus\tTelefon\tStatus\n';
                    
                    filteredData.forEach((p, index) => {
                        simpleData += `${index + 1}\t${p.nama}\t${p.noKP}\t${p.kursus}\t${p.telefon}\t${p.status}\n`;
                    });
                    
                    const dataUrl = 'data:application/vnd.ms-excel;charset=utf-8,' + encodeURIComponent(simpleData);
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `Laporan_Carian_GIATMARA_${new Date().getTime()}.xls`;
                    link.click();
                    
                    showNotification(`Fail Excel telah dimuat turun menggunakan kaedah alternatif! (${filteredData.length} rekod)`);
                } catch (fallbackError) {
                    console.error('Fallback export error:', fallbackError);
                    alert('Maaf, terdapat masalah dengan fungsi muat turun. Sila cuba sekali lagi atau gunakan browser yang berbeza.');
                }
            }
        }

        // Session registration functions
        function showPendaftaranSesi() {
            document.getElementById('pendaftaranSesiModal').classList.remove('hidden');
            updateSenaraySesiSediaAda();
        }

        function closePendaftaranSesi() {
            document.getElementById('pendaftaranSesiModal').classList.add('hidden');
            resetFormPendaftaranSesi();
        }

        function resetFormPendaftaranSesi() {
            document.getElementById('namaSesiDaftar').value = '';
            document.getElementById('kodKursus').value = '';
            document.getElementById('namaKursusDaftar').value = '';
            document.getElementById('tahunSesiDaftar').value = '';
            document.getElementById('tempohKursusDaftar').value = '';
            document.getElementById('tarikhMula').value = '';
            document.getElementById('tarikhTamat').value = '';
            document.getElementById('masaMulaDaftar').value = '';
            document.getElementById('masaTamatDaftar').value = '';
            document.getElementById('kapasitPelatih').value = '';
            document.getElementById('keteranganSesi').value = '';
        }

        function daftarSesi(event) {
            event.preventDefault();
            
            const namaSesi = document.getElementById('namaSesiDaftar').value;
            const kodKursus = document.getElementById('kodKursus').value;
            const namaKursus = document.getElementById('namaKursusDaftar').value;
            const tahun = document.getElementById('tahunSesiDaftar').value;
            const tempoh = document.getElementById('tempohKursusDaftar').value;
            const tarikhMula = document.getElementById('tarikhMula').value;
            const tarikhTamat = document.getElementById('tarikhTamat').value;
            const masaMula = document.getElementById('masaMulaDaftar').value;
            const masaTamat = document.getElementById('masaTamatDaftar').value;
            const kapasiti = parseInt(document.getElementById('kapasitPelatih').value);
            const keterangan = document.getElementById('keteranganSesi').value;
            
            // Validate dates
            const startDate = new Date(tarikhMula);
            const endDate = new Date(tarikhTamat);
            const today = new Date();
            
            if (startDate >= endDate) {
                alert('Tarikh tamat mesti selepas tarikh mula!');
                return;
            }
            
            // Validate times
            if (masaMula >= masaTamat) {
                alert('Masa tamat mesti selepas masa mula!');
                return;
            }
            
            // Check for duplicate course code
            const existingSesi = sesiData.find(s => s.kodKursus.toLowerCase() === kodKursus.toLowerCase());
            if (existingSesi) {
                alert(`Kod kursus "${kodKursus}" sudah wujud! Sila gunakan kod yang berbeza.`);
                return;
            }
            
            // Determine status based on start date
            let status = 'Akan Datang';
            if (startDate <= today && endDate >= today) {
                status = 'Aktif';
            } else if (endDate < today) {
                status = 'Tamat';
            }
            
            // Create new session
            const newSesi = {
                id: sesiData.length + 1,
                namaSesi: namaSesi,
                kodKursus: kodKursus.toUpperCase(),
                namaKursus: namaKursus,
                tahun: tahun,
                tempoh: tempoh,
                tarikhMula: tarikhMula,
                tarikhTamat: tarikhTamat,
                masaMula: masaMula,
                masaTamat: masaTamat,
                kapasiti: kapasiti,
                keterangan: keterangan,
                status: status,
                pelatihTerdaftar: 0
            };
            
            sesiData.push(newSesi);
            
            // Auto-save to localStorage
            autoSaveSesiData();
            
            updateSenaraySesiSediaAda();
            resetFormPendaftaranSesi();
            
            // Update session dropdown in add trainee form if it's open
            const tambahPelatihModal = document.getElementById('tambahPelatihModal');
            if (!tambahPelatihModal.classList.contains('hidden')) {
                updateSesiDropdown();
            }
            
            showNotification(`Sesi "${namaSesi}" berjaya didaftarkan dengan kod "${kodKursus.toUpperCase()}"!`);
            
            // If creating session for import, refresh the import session list
            if (window.creatingSessionForImport) {
                window.creatingSessionForImport = false;
                setTimeout(() => {
                    refreshSessionList();
                    showNotification('Sesi baru telah ditambah ke senarai import. Sila pilih sesi untuk meneruskan import pelatih.');
                }, 500);
            }
        }

        function updateSenaraySesiSediaAda() {
            const container = document.getElementById('senaraySesiSediaAda');
            container.innerHTML = '';
            
            // Sort sessions by status and date
            const sortedSesi = [...sesiData].sort((a, b) => {
                const statusOrder = { 'Aktif': 1, 'Akan Datang': 2, 'Tamat': 3 };
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }
                return new Date(a.tarikhMula) - new Date(b.tarikhMula);
            });
            
            sortedSesi.forEach(sesi => {
                const statusColor = sesi.status === 'Aktif' ? 'bg-green-100 text-green-800' :
                                  sesi.status === 'Akan Datang' ? 'bg-blue-100 text-blue-800' :
                                  'bg-gray-100 text-gray-800';
                
                const sesiElement = document.createElement('div');
                sesiElement.className = 'bg-white p-4 rounded-lg border border-gray-200';
                sesiElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="font-semibold text-gray-800">${sesi.namaSesi}</h5>
                        <span class="px-2 py-1 ${statusColor} text-xs rounded-full">${sesi.status}</span>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><strong>Kod:</strong> ${sesi.kodKursus} | <strong>Kursus:</strong> ${sesi.namaKursus}</p>
                        <p><strong>Tahun:</strong> ${sesi.tahun} | <strong>Tempoh:</strong> ${sesi.tempoh} Bulan</p>
                        <p><strong>Tarikh:</strong> ${formatDate(sesi.tarikhMula)} - ${formatDate(sesi.tarikhTamat)}</p>
                        <p><strong>Masa:</strong> ${sesi.masaMula} - ${sesi.masaTamat} | <strong>Kapasiti:</strong> ${sesi.kapasiti} pelatih</p>
                        <p><strong>Terdaftar:</strong> ${sesi.pelatihTerdaftar}/${sesi.kapasiti} pelatih</p>
                        ${sesi.keterangan ? `<p><strong>Keterangan:</strong> ${sesi.keterangan}</p>` : ''}
                    </div>
                    <div class="mt-3 flex space-x-2">
                        <button onclick="editSesi(${sesi.id})" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
                            Edit
                        </button>
                        <button onclick="deleteSesi(${sesi.id})" class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                            Padam
                        </button>
                        <button onclick="viewDetailSesi(${sesi.id})" class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 transition">
                            Lihat Detail
                        </button>
                    </div>
                `;
                container.appendChild(sesiElement);
            });
            
            // Update statistics
            updateStatistikSesi();
        }

        function updateStatistikSesi() {
            const aktif = sesiData.filter(s => s.status === 'Aktif').length;
            const akanDatang = sesiData.filter(s => s.status === 'Akan Datang').length;
            const totalPelatih = sesiData.reduce((sum, s) => sum + s.pelatihTerdaftar, 0);
            
            document.getElementById('jumlahSesiAktif').textContent = aktif;
            document.getElementById('jumlahSesiAkanDatang').textContent = akanDatang;
            document.getElementById('jumlahPelatihTerdaftar').textContent = totalPelatih;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ms-MY', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function editSesi(sesiId) {
            const sesi = sesiData.find(s => s.id === sesiId);
            if (!sesi) return;
            
            // Populate form with existing data
            document.getElementById('sesiNumberDaftar').value = sesi.sesiNumber;
            document.getElementById('tahunSesiDaftar').value = sesi.tahun;
            document.getElementById('kodKursus').value = sesi.kodKursus;
            document.getElementById('namaKursusDaftar').value = sesi.namaKursus;
            document.getElementById('tempohKursusDaftar').value = sesi.tempoh;
            document.getElementById('tarikhMula').value = sesi.tarikhMula;
            document.getElementById('tarikhTamat').value = sesi.tarikhTamat;
            document.getElementById('masaMulaDaftar').value = sesi.masaMula;
            document.getElementById('masaTamatDaftar').value = sesi.masaTamat;
            document.getElementById('kapasitPelatih').value = sesi.kapasiti;
            document.getElementById('keteranganSesi').value = sesi.keterangan;
            
            // Change form submit to update mode
            const form = document.querySelector('#pendaftaranSesiModal form');
            form.onsubmit = function(event) {
                event.preventDefault();
                updateSesi(sesiId);
            };
            
            // Change button text
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.innerHTML = `
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Kemas Kini Sesi
            `;
            
            showNotification(`Mode edit untuk sesi "${sesi.namaSesi}". Ubah maklumat dan klik "Kemas Kini Sesi".`);
        }

        function updateSesi(sesiId) {
            const sesi = sesiData.find(s => s.id === sesiId);
            if (!sesi) return;
            
            const sesiNumber = document.getElementById('sesiNumberDaftar').value;
            const tahun = document.getElementById('tahunSesiDaftar').value;
            const namaSesi = `${sesiNumber}/${tahun}`;
            const kodKursus = document.getElementById('kodKursus').value;
            const namaKursus = document.getElementById('namaKursusDaftar').value;
            const tempoh = document.getElementById('tempohKursusDaftar').value;
            const tarikhMula = document.getElementById('tarikhMula').value;
            const tarikhTamat = document.getElementById('tarikhTamat').value;
            const masaMula = document.getElementById('masaMulaDaftar').value;
            const masaTamat = document.getElementById('masaTamatDaftar').value;
            const kapasiti = parseInt(document.getElementById('kapasitPelatih').value);
            const keterangan = document.getElementById('keteranganSesi').value;
            
            // Validate dates
            const startDate = new Date(tarikhMula);
            const endDate = new Date(tarikhTamat);
            const today = new Date();
            
            if (startDate >= endDate) {
                alert('Tarikh tamat mesti selepas tarikh mula!');
                return;
            }
            
            // Validate times
            if (masaMula >= masaTamat) {
                alert('Masa tamat mesti selepas masa mula!');
                return;
            }
            
            // Check for duplicate session (excluding current session)
            const existingSesi = sesiData.find(s => s.sesiNumber === sesiNumber && s.tahun === tahun && s.id !== sesiId);
            if (existingSesi) {
                alert(`Sesi "${sesiNumber}/${tahun}" sudah wujud! Sila pilih sesi atau tahun yang berbeza.`);
                return;
            }
            
            // Determine status based on start date
            let status = 'Akan Datang';
            if (startDate <= today && endDate >= today) {
                status = 'Aktif';
            } else if (endDate < today) {
                status = 'Tamat';
            }
            
            // Update session data
            sesi.namaSesi = namaSesi;
            sesi.sesiNumber = sesiNumber;
            sesi.kodKursus = kodKursus.toUpperCase();
            sesi.namaKursus = namaKursus;
            sesi.tahun = tahun;
            sesi.tempoh = tempoh;
            sesi.tarikhMula = tarikhMula;
            sesi.tarikhTamat = tarikhTamat;
            sesi.masaMula = masaMula;
            sesi.masaTamat = masaTamat;
            sesi.kapasiti = kapasiti;
            sesi.keterangan = keterangan;
            sesi.status = status;
            
            updateSenaraySesiSediaAda();
            resetFormPendaftaranSesi();
            
            // Update session dropdown in add trainee form if it's open
            const tambahPelatihModal = document.getElementById('tambahPelatihModal');
            if (!tambahPelatihModal.classList.contains('hidden')) {
                updateSesiDropdown();
            }
            
            // Reset form to add mode
            const form = document.querySelector('#pendaftaranSesiModal form');
            form.onsubmit = function(event) {
                daftarSesi(event);
            };
            
            // Reset button text
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.innerHTML = `
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Daftar Sesi Baru
            `;
            
            showNotification(`Sesi "${namaSesi}" berjaya dikemas kini!`);
        }

        function deleteSesi(sesiId) {
            const sesi = sesiData.find(s => s.id === sesiId);
            if (!sesi) return;
            
            if (sesi.pelatihTerdaftar > 0) {
                if (!confirm(`Sesi "${sesi.namaSesi}" mempunyai ${sesi.pelatihTerdaftar} pelatih terdaftar. Adakah anda pasti ingin memadamnya?`)) {
                    return;
                }
            } else {
                if (!confirm(`Adakah anda pasti ingin memadam sesi "${sesi.namaSesi}"?`)) {
                    return;
                }
            }
            
            // Remove session from array
            const index = sesiData.findIndex(s => s.id === sesiId);
            if (index > -1) {
                sesiData.splice(index, 1);
                updateSenaraySesiSediaAda();
                
                // Update session dropdown in add trainee form if it's open
                const tambahPelatihModal = document.getElementById('tambahPelatihModal');
                if (!tambahPelatihModal.classList.contains('hidden')) {
                    updateSesiDropdown();
                }
                
                showNotification(`Sesi "${sesi.namaSesi}" telah dipadam.`);
            }
        }

        function viewDetailSesi(sesiId) {
            const sesi = sesiData.find(s => s.id === sesiId);
            if (!sesi) return;
            
            const detailWindow = window.open('', '_blank', 'width=600,height=700');
            detailWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Detail Sesi - ${sesi.namaSesi}</title>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
                        .info-item { margin-bottom: 10px; }
                        .label { font-weight: bold; color: #333; }
                        .value { color: #666; }
                        .status { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
                        .status.aktif { background-color: #d1fae5; color: #065f46; }
                        .status.akan-datang { background-color: #dbeafe; color: #1e40af; }
                        .status.tamat { background-color: #f3f4f6; color: #374151; }
                        .print-btn { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 20px 0; }
                        .print-btn:hover { background: #2563eb; }
                        @media print { .print-btn { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üè¢ GIATMARA KELANTAN</h1>
                        <h2>Detail Sesi Kursus</h2>
                        <p>Pusat: ${currentUser || 'GIATMARA Kelantan'}</p>
                    </div>
                    
                    <div class="info-grid">
                        <div>
                            <div class="info-item">
                                <span class="label">Nama Sesi:</span><br>
                                <span class="value">${sesi.namaSesi}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Kod Kursus:</span><br>
                                <span class="value">${sesi.kodKursus}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Nama Kursus:</span><br>
                                <span class="value">${sesi.namaKursus}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Tahun:</span><br>
                                <span class="value">${sesi.tahun}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Tempoh Kursus:</span><br>
                                <span class="value">${sesi.tempoh} Bulan</span>
                            </div>
                        </div>
                        <div>
                            <div class="info-item">
                                <span class="label">Status:</span><br>
                                <span class="status ${sesi.status.toLowerCase().replace(' ', '-')}">${sesi.status}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Tarikh Mula:</span><br>
                                <span class="value">${formatDate(sesi.tarikhMula)}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Tarikh Tamat:</span><br>
                                <span class="value">${formatDate(sesi.tarikhTamat)}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Masa:</span><br>
                                <span class="value">${sesi.masaMula} - ${sesi.masaTamat}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Kapasiti:</span><br>
                                <span class="value">${sesi.kapasiti} pelatih</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <span class="label">Pelatih Terdaftar:</span><br>
                        <span class="value">${sesi.pelatihTerdaftar}/${sesi.kapasiti} pelatih (${Math.round((sesi.pelatihTerdaftar/sesi.kapasiti)*100)}% penuh)</span>
                    </div>
                    
                    ${sesi.keterangan ? `
                        <div class="info-item">
                            <span class="label">Keterangan:</span><br>
                            <span class="value">${sesi.keterangan}</span>
                        </div>
                    ` : ''}
                    
                    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Cetak Detail</button>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #666;">
                        <p><strong>Tarikh Jana:</strong> ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</p>
                        <p>Dokumen ini dijana secara automatik dari Sistem Kehadiran GIATMARA Kelantan</p>
                    </div>
                </body>
                </html>
            `);
            detailWindow.document.close();
        }

        // Bulk Delete Functions
        function showBulkDeleteOptions() {
            document.getElementById('bulkDeleteModal').classList.remove('hidden');
            initializeBulkDeleteModal();
        }

        function closeBulkDelete() {
            document.getElementById('bulkDeleteModal').classList.add('hidden');
            resetBulkDeleteModal();
        }

        function initializeBulkDeleteModal() {
            // Update total count
            const totalTrainees = window.allPelatihData ? window.allPelatihData.length : 0;
            document.getElementById('totalAllTrainees').textContent = totalTrainees;
            
            // Populate center dropdown
            const centerSelect = document.getElementById('deleteCenterSelect');
            centerSelect.innerHTML = '<option value="">Pilih Pusat untuk Dipadam</option>';
            pusatData.forEach(pusat => {
                const count = window.allPelatihData ? window.allPelatihData.filter(p => p.pusat === pusat.nama).length : 0;
                const option = document.createElement('option');
                option.value = pusat.nama;
                option.textContent = `${pusat.nama} (${count} pelatih)`;
                centerSelect.appendChild(option);
            });
            
            // Populate course dropdown
            const courseSelect = document.getElementById('deleteCourseSelect');
            courseSelect.innerHTML = '<option value="">Pilih Kursus untuk Dipadam</option>';
            const uniqueCourses = window.allPelatihData ? [...new Set(window.allPelatihData.map(p => p.kursus))].sort() : [];
            uniqueCourses.forEach(kursus => {
                const count = window.allPelatihData.filter(p => p.kursus === kursus).length;
                const option = document.createElement('option');
                option.value = kursus;
                option.textContent = `${kursus} (${count} pelatih)`;
                courseSelect.appendChild(option);
            });
            
            // Populate session dropdown
            const sessionSelect = document.getElementById('deleteSessionSelect');
            sessionSelect.innerHTML = '<option value="">Pilih Sesi untuk Dipadam</option>';
            sesiData.forEach(sesi => {
                const count = window.allPelatihData ? window.allPelatihData.filter(p => p.sesiNama === sesi.namaSesi).length : 0;
                const option = document.createElement('option');
                option.value = sesi.namaSesi;
                option.textContent = `${sesi.namaSesi} (${count} pelatih)`;
                sessionSelect.appendChild(option);
            });
            
            // Add event listeners for radio buttons
            const radioButtons = document.querySelectorAll('input[name="deleteOption"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', handleDeleteOptionChange);
            });
            
            // Add event listeners for confirmation checkboxes
            const checkboxes = ['confirmBackup', 'confirmUnderstand', 'confirmProceed'];
            checkboxes.forEach(id => {
                document.getElementById(id).addEventListener('change', updateExecuteButton);
            });
            
            // Add event listener for confirmation text
            document.getElementById('confirmationText').addEventListener('input', updateExecuteButton);
        }

        function handleDeleteOptionChange() {
            const selectedOption = document.querySelector('input[name="deleteOption"]:checked');
            
            // Enable/disable dropdowns based on selection
            document.getElementById('deleteCenterSelect').disabled = selectedOption?.value !== 'center';
            document.getElementById('deleteCourseSelect').disabled = selectedOption?.value !== 'course';
            document.getElementById('deleteSessionSelect').disabled = selectedOption?.value !== 'session';
            document.getElementById('deleteYearSelect').disabled = selectedOption?.value !== 'year';
            
            // Enable preview button if option is selected
            document.getElementById('previewBtn').disabled = !selectedOption;
            
            // Hide preview and confirmation sections
            document.getElementById('deletePreview').classList.add('hidden');
            document.getElementById('confirmationSection').classList.add('hidden');
            document.getElementById('executeBtn').classList.add('hidden');
        }

        function previewDeletion() {
            const selectedOption = document.querySelector('input[name="deleteOption"]:checked');
            if (!selectedOption) {
                alert('Sila pilih kaedah pemadaman terlebih dahulu.');
                return;
            }
            
            let toDelete = [];
            let description = '';
            
            switch (selectedOption.value) {
                case 'all':
                    toDelete = window.allPelatihData ? [...window.allPelatihData] : [];
                    description = 'SEMUA pelatih dari seluruh sistem';
                    break;
                    
                case 'center':
                    const selectedCenter = document.getElementById('deleteCenterSelect').value;
                    if (!selectedCenter) {
                        alert('Sila pilih pusat untuk dipadam.');
                        return;
                    }
                    toDelete = window.allPelatihData ? window.allPelatihData.filter(p => p.pusat === selectedCenter) : [];
                    description = `semua pelatih dari pusat "${selectedCenter}"`;
                    break;
                    
                case 'course':
                    const selectedCourse = document.getElementById('deleteCourseSelect').value;
                    if (!selectedCourse) {
                        alert('Sila pilih kursus untuk dipadam.');
                        return;
                    }
                    toDelete = window.allPelatihData ? window.allPelatihData.filter(p => p.kursus === selectedCourse) : [];
                    description = `semua pelatih dari kursus "${selectedCourse}"`;
                    break;
                    
                case 'session':
                    const selectedSession = document.getElementById('deleteSessionSelect').value;
                    if (!selectedSession) {
                        alert('Sila pilih sesi untuk dipadam.');
                        return;
                    }
                    toDelete = window.allPelatihData ? window.allPelatihData.filter(p => p.sesiNama === selectedSession) : [];
                    description = `semua pelatih dari sesi "${selectedSession}"`;
                    break;
                    
                case 'year':
                    const selectedYear = document.getElementById('deleteYearSelect').value;
                    if (!selectedYear) {
                        alert('Sila pilih tahun untuk dipadam.');
                        return;
                    }
                    toDelete = window.allPelatihData ? window.allPelatihData.filter(p => p.tahun === selectedYear) : [];
                    description = `semua pelatih dari tahun "${selectedYear}"`;
                    break;
            }
            
            if (toDelete.length === 0) {
                alert('Tiada pelatih dijumpai untuk kriteria yang dipilih.');
                return;
            }
            
            // Store data for deletion
            window.pendingDeletion = toDelete;
            
            // Show preview
            const previewContent = document.getElementById('deletePreviewContent');
            previewContent.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-red-50 p-3 rounded border border-red-200">
                        <p class="font-semibold text-red-800">Akan dipadam: ${description}</p>
                        <p class="text-red-700">Jumlah: <strong>${toDelete.length} pelatih</strong></p>
                    </div>
                    
                    <div class="max-h-48 overflow-y-auto">
                        <table class="w-full text-xs border-collapse border border-gray-300">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="border border-gray-300 px-2 py-1 text-left">Bil</th>
                                    <th class="border border-gray-300 px-2 py-1 text-left">Nama</th>
                                    <th class="border border-gray-300 px-2 py-1 text-left">No. KP</th>
                                    <th class="border border-gray-300 px-2 py-1 text-left">Pusat</th>
                                    <th class="border border-gray-300 px-2 py-1 text-left">Kursus</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${toDelete.slice(0, 20).map((p, index) => `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="border border-gray-300 px-2 py-1">${index + 1}</td>
                                        <td class="border border-gray-300 px-2 py-1 font-medium">${p.nama}</td>
                                        <td class="border border-gray-300 px-2 py-1">${p.noKP}</td>
                                        <td class="border border-gray-300 px-2 py-1">${p.pusat}</td>
                                        <td class="border border-gray-300 px-2 py-1">${p.kursus}</td>
                                    </tr>
                                `).join('')}
                                ${toDelete.length > 20 ? `
                                    <tr>
                                        <td colspan="5" class="border border-gray-300 px-2 py-1 text-center text-gray-500">
                                            ... dan ${toDelete.length - 20} pelatih lagi
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                        <p class="text-yellow-800 text-sm">
                            <strong>Kesan pemadaman:</strong><br>
                            ‚Ä¢ ${toDelete.length} rekod pelatih akan dipadam secara kekal<br>
                            ‚Ä¢ Semua rekod kehadiran berkaitan akan turut dipadam<br>
                            ‚Ä¢ Kapasiti sesi akan dikemas kini secara automatik<br>
                            ‚Ä¢ Tindakan ini TIDAK BOLEH dibatalkan
                        </p>
                    </div>
                </div>
            `;
            
            // Show preview and confirmation sections
            document.getElementById('deletePreview').classList.remove('hidden');
            document.getElementById('confirmationSection').classList.remove('hidden');
            
            showNotification(`Pratonton pemadaman: ${toDelete.length} pelatih akan dipadam.`);
        }

        function updateExecuteButton() {
            const backup = document.getElementById('confirmBackup').checked;
            const understand = document.getElementById('confirmUnderstand').checked;
            const proceed = document.getElementById('confirmProceed').checked;
            const confirmText = document.getElementById('confirmationText').value.toUpperCase();
            
            const allConfirmed = backup && understand && proceed && confirmText === 'PADAM';
            
            const executeBtn = document.getElementById('executeBtn');
            if (allConfirmed) {
                executeBtn.classList.remove('hidden');
                executeBtn.disabled = false;
            } else {
                executeBtn.classList.add('hidden');
                executeBtn.disabled = true;
            }
        }

        function executeBulkDelete() {
            if (!window.pendingDeletion || window.pendingDeletion.length === 0) {
                alert('Tiada data untuk dipadam.');
                return;
            }
            
            const toDelete = window.pendingDeletion;
            const selectedOption = document.querySelector('input[name="deleteOption"]:checked');
            
            // Final confirmation
            const finalConfirm = confirm(`AMARAN TERAKHIR!\n\nAnda akan memadam ${toDelete.length} pelatih secara KEKAL.\n\nTindakan ini TIDAK BOLEH dibatalkan!\n\nAdakah anda pasti ingin meneruskan?`);
            
            if (!finalConfirm) {
                return;
            }
            
            // Show loading
            showNotification('Memproses pemadaman data... Sila tunggu.');
            
            // Simulate deletion process with progress
            let deletedCount = 0;
            const totalToDelete = toDelete.length;
            
            // Process deletion in batches to show progress
            const batchSize = 10;
            let currentBatch = 0;
            
            const processBatch = () => {
                const startIndex = currentBatch * batchSize;
                const endIndex = Math.min(startIndex + batchSize, totalToDelete);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const pelatihToDelete = toDelete[i];
                    
                    // Remove from main pelatih data
                    const mainIndex = pelatihData.findIndex(p => p.id === pelatihToDelete.id);
                    if (mainIndex > -1) {
                        pelatihData.splice(mainIndex, 1);
                    }
                    
                    // Remove from all pelatih data
                    if (window.allPelatihData) {
                        const allIndex = window.allPelatihData.findIndex(p => p.id === pelatihToDelete.id);
                        if (allIndex > -1) {
                            window.allPelatihData.splice(allIndex, 1);
                        }
                    }
                    
                    // Update session capacity if applicable
                    if (pelatihToDelete.sesiId) {
                        const sesi = sesiData.find(s => s.id === pelatihToDelete.sesiId);
                        if (sesi && sesi.pelatihTerdaftar > 0) {
                            sesi.pelatihTerdaftar--;
                        }
                    }
                    
                    deletedCount++;
                }
                
                // Update progress
                const progress = Math.round((deletedCount / totalToDelete) * 100);
                showNotification(`Memproses... ${progress}% (${deletedCount}/${totalToDelete} pelatih dipadam)`);
                
                currentBatch++;
                
                if (deletedCount < totalToDelete) {
                    // Continue with next batch
                    setTimeout(processBatch, 100);
                } else {
                    // Deletion complete
                    finalizeDeletion(deletedCount, selectedOption.value);
                }
            };
            
            // Start deletion process
            setTimeout(processBatch, 500);
        }

        function finalizeDeletion(deletedCount, deleteType) {
            // Update all displays
            updatePusatStats();
            updatePelatihStatistics();
            
            // Refresh trainee management if open
            const pelatihModal = document.getElementById('pelatihManagementModal');
            if (!pelatihModal.classList.contains('hidden')) {
                loadAllPelatihData();
            }
            
            // Close modal
            closeBulkDelete();
            
            // Show completion message
            const typeDescriptions = {
                'all': 'seluruh sistem',
                'center': 'pusat yang dipilih',
                'course': 'kursus yang dipilih',
                'session': 'sesi yang dipilih',
                'year': 'tahun yang dipilih'
            };
            
            const description = typeDescriptions[deleteType] || 'kriteria yang dipilih';
            
            alert(`‚úÖ PEMADAMAN SELESAI!\n\n${deletedCount} pelatih telah dipadam secara kekal dari ${description}.\n\nSistem telah dikemas kini dan semua statistik telah diselaraskan.`);
            
            showNotification(`Pemadaman selesai: ${deletedCount} pelatih telah dipadam dari sistem.`);
            
            // Clear pending deletion data
            window.pendingDeletion = null;
        }

        function resetBulkDeleteModal() {
            // Reset radio buttons
            const radioButtons = document.querySelectorAll('input[name="deleteOption"]');
            radioButtons.forEach(radio => {
                radio.checked = false;
            });
            
            // Reset dropdowns
            document.getElementById('deleteCenterSelect').value = '';
            document.getElementById('deleteCourseSelect').value = '';
            document.getElementById('deleteSessionSelect').value = '';
            document.getElementById('deleteYearSelect').value = '';
            
            // Disable all dropdowns
            document.getElementById('deleteCenterSelect').disabled = true;
            document.getElementById('deleteCourseSelect').disabled = true;
            document.getElementById('deleteSessionSelect').disabled = true;
            document.getElementById('deleteYearSelect').disabled = true;
            
            // Reset checkboxes
            document.getElementById('confirmBackup').checked = false;
            document.getElementById('confirmUnderstand').checked = false;
            document.getElementById('confirmProceed').checked = false;
            document.getElementById('confirmationText').value = '';
            
            // Hide sections
            document.getElementById('deletePreview').classList.add('hidden');
            document.getElementById('confirmationSection').classList.add('hidden');
            document.getElementById('executeBtn').classList.add('hidden');
            
            // Disable buttons
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('executeBtn').disabled = true;
            
            // Clear pending data
            window.pendingDeletion = null;
        }

        // Data Management Functions
        function showDataManagementMenu() {
            const dataMenu = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="dataManagementModal">
                    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">üóÑÔ∏è Pengurusan Data</h3>
                        
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h4 class="font-semibold text-blue-800 mb-2">üìä Status Data</h4>
                                <div class="text-sm text-blue-700 space-y-1">
                                    <p>‚Ä¢ Pelatih: ${pelatihData.length} rekod</p>
                                    <p>‚Ä¢ Sesi: ${sesiData.length} rekod</p>
                                    <p>‚Ä¢ Pusat: ${pusatData.length} rekod</p>
                                    <p>‚Ä¢ Kehadiran: ${Object.keys(attendanceHistory).length} tarikh</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <button onclick="exportAllData()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition">
                                    üì§ Export Semua Data
                                </button>
                                <button onclick="importAllData()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">
                                    üì• Import Data
                                </button>
                                <button onclick="resetAllData()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition">
                                    üóëÔ∏è Reset Semua Data
                                </button>
                                <button onclick="closeDataManagement()" class="w-full bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                                    Tutup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dataMenu);
        }

        function closeDataManagement() {
            const modal = document.getElementById('dataManagementModal');
            if (modal) {
                modal.remove();
            }
        }

        function exportAllData() {
            const allData = {
                pelatihData: pelatihData,
                attendanceHistory: attendanceHistory,
                sesiData: sesiData,
                pusatData: pusatData,
                kursusData: kursusData,
                currentLogo: currentLogo,
                logoHistory: logoHistory,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `GIATMARA_Backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('‚úÖ Semua data telah diexport! Simpan fail backup dengan selamat.');
        }

        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (confirm('‚ö†Ô∏è AMARAN: Import data akan menggantikan semua data sedia ada. Adakah anda pasti?')) {
                            // Restore all data
                            if (importedData.pelatihData) pelatihData = importedData.pelatihData;
                            if (importedData.attendanceHistory) attendanceHistory = importedData.attendanceHistory;
                            if (importedData.sesiData) sesiData = importedData.sesiData;
                            if (importedData.pusatData) pusatData = importedData.pusatData;
                            if (importedData.kursusData) kursusData = importedData.kursusData;
                            if (importedData.currentLogo) currentLogo = importedData.currentLogo;
                            if (importedData.logoHistory) logoHistory = importedData.logoHistory;
                            
                            // Save all to localStorage
                            autoSavePelatihData();
                            autoSaveAttendanceHistory();
                            autoSaveSesiData();
                            autoSavePusatData();
                            autoSaveKursusData();
                            autoSaveCurrentLogo();
                            autoSaveLogoHistory();
                            
                            // Update displays
                            updatePusatStats();
                            updatePusatDropdown();
                            updateCourseFilters();
                            updateAllLogoDisplays();
                            updateCurrentLogoDisplay();
                            
                            closeDataManagement();
                            alert('‚úÖ Data berjaya diimport! Sistem telah dikemas kini.');
                        }
                    } catch (error) {
                        alert('‚ùå Ralat: Fail backup tidak sah atau rosak.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function resetAllData() {
            const confirmText = prompt('‚ö†Ô∏è AMARAN: Ini akan memadam SEMUA data secara kekal!\n\nTaip "RESET" untuk mengesahkan:');
            
            if (confirmText === 'RESET') {
                // Clear all data
                pelatihData = [];
                attendanceHistory = {};
                // Keep default sesi, pusat, and kursus data
                
                // Clear localStorage
                clearLocalStorage();
                
                // Update displays
                updatePusatStats();
                updateCourseFilters();
                
                closeDataManagement();
                alert('‚úÖ Semua data telah direset! Sistem kembali ke keadaan asal.');
                
                // Reload page to reset everything
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else if (confirmText !== null) {
                alert('‚ùå Teks pengesahan salah. Data tidak direset.');
            }
        }

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Memulakan Sistem Kehadiran GIATMARA Kelantan...');
            
            // Load data from localStorage first
            initializeFromLocalStorage();
            
            // Initialize the center dropdown with existing centers
            updatePusatDropdown();
            // Initialize course filters with current data
            updateCourseFilters();
            // Set current date for attendance modal
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ms-MY');
            
            console.log('‚úÖ Sistem Kehadiran GIATMARA Kelantan siap digunakan!');
            console.log('üíæ Local Storage aktif - Data akan kekal selepas refresh');
            
            // Add data management button to admin dashboard
            setTimeout(() => {
                const adminDashboard = document.getElementById('adminDashboard');
                if (adminDashboard) {
                    const dataManagementBtn = `
                        <button onclick="showDataManagementMenu()" class="bg-gray-600 text-white p-6 rounded-xl hover:bg-gray-700 transition card-shadow hover-scale">
                            <div class="text-center">
                                <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                </svg>
                                <h3 class="font-semibold">Urus Data</h3>
                            </div>
                        </button>
                    `;
                    
                    const menuGrid = adminDashboard.querySelector('.grid.md\\:grid-cols-2.lg\\:grid-cols-5');
                    if (menuGrid) {
                        menuGrid.insertAdjacentHTML('beforeend', dataManagementBtn);
                    }
                }
            }, 100);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97bfbfb2026c1fe1',t:'MTc1NzM0ODE3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

